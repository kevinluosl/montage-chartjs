var Component=require("montage/ui/component").Component,TextInput=require("ui/text-input").TextInput,logger=require("montage/core/logger").logger("autocomplete"),ResultsList=require("ui/autocomplete/results-list.reel/results-list").ResultsList,Popup=require("ui/popup/popup.reel").Popup,PressComposer=require("montage/composer/press-composer").PressComposer,RangeController=require("montage/core/range-controller").RangeController,KEY_UP=38,KEY_DOWN=40,KEY_RIGHT=39,KEY_ENTER=13,KEY_ESC=27,getElementPosition=function(t){var e=0,n=0,i=0,a=0;if(t.offsetParent)do e+=t.offsetLeft,n+=t.offsetTop,i+=t.offsetHeight,a+=t.offsetWidth;while(t=t.offsetParent);return{top:n,left:e,height:i,width:a}},Autocomplete=exports.Autocomplete=TextInput.specialize({constructor:{value:function(){this.super(),this.delay=500,this.minLength=2,this.classList.add("matte-InputText")}},hasTemplate:{value:!0},delegate:{value:null},textPropertyPath:{value:null},separator:{value:",",distinct:!0},_delay:{value:null},delay:{get:function(){return this._delay},set:function(t){t!==this._delay&&("string"==typeof t&&(t=parseInt(t,10)),this._delay=t)}},minLength:{value:null},_tokens:{value:null},tokens:{get:function(){return this._tokens},set:function(t){this._tokens=t,this._valueSyncedWithInputField=!1,this.needsDraw=!0},modify:function(t){this._tokens=t}},value:{get:function(){return this._value},set:function(t,e){this._value=t?t.trim():"";var n=this._value;if(n){var i=n.split(this.separator).map(function(t){return t.trim()});this.activeTokenIndex=this._findActiveTokenIndex(this.tokens,i),this._tokens=n.split(this.separator).map(function(t){return t.trim()})}else this.activeTokenIndex=0,this._tokens=[];if(e){if(this._valueSyncedWithInputField=!0,this.showPopup=!1,this._tokens.length&&this._tokens.length>0){var a=this._tokens[this.activeTokenIndex];if(a=a?a.trim():"",a.length>=this.minLength){var r=this;clearTimeout(this.delayTimer),this.delayTimer=setTimeout(function(){r.delayTimer=null,logger.isDebug&&logger.debug("SEARCH for ",a),r.performSearch(a)},this.delay)}}}else this.showPopup=!1,this._valueSyncedWithInputField=!1,this.needsDraw=!0}},overlayWidth:{value:null,enumerable:!1},delayTimer:{value:null,enumerable:!1},_loadingStatus:{value:!1,enumerable:!1},loadingStatus:{enumerable:!1,get:function(){return this._loadingStatus},set:function(t){this._loadingStatus=t,"loading"===this._loadingStatus&&(this.showPopup=!1),this.needsDraw=!0}},activeTokenIndex:{value:null},_findActiveTokenIndex:{enumerable:!1,value:function(t,e){if(null==t||null==e)return 0;var n=0,i=e.length;for(n=0;i>n;n++)if(t.length>n){if(t[n]===e[n])continue;break}return n}},_activeIndexes:{value:null,enumerable:!1},activeItemIndex:{enumerable:!1,get:function(){return this._activeIndexes&&this._activeIndexes.length>0?this._activeIndexes[0]:null},set:function(t){this._activeIndexes=null==t?[]:[t]}},_suggestedValue:{value:null},suggestedValue:{enumerable:!1,get:function(){return this._suggestedValue},set:function(t){if(this._suggestedValue=t,t){var e,n=this.tokens||[];e="string"==typeof t?t:this.textPropertyPath?t[this.textPropertyPath]:"",n[this.activeTokenIndex]=e,this.tokens=n,this.showPopup=!1}}},popup:{enumerable:!1,value:null},_showPopup:{value:null},showPopup:{enumerable:!1,get:function(){return this._showPopup},set:function(t){t!=this._showPopup&&(this._showPopup=t,this.needsDraw=!0)}},_suggestions:{value:null},suggestions:{enumerable:!1,get:function(){return this._suggestions},set:function(t){logger.isDebug&&logger.debug("got suggestions: ",t),this.loadingStatus="complete",this._suggestions=t,this.showPopup=t&&t.length>0}},resultsController:{enumerable:!1,value:null},resultsList:{enumerable:!1,value:null},performSearch:{enumerable:!1,value:function(t){this.delegate&&(this.resultsController.selectedIndexes=[],this.activeItemIndex=0,this.loadingStatus="loading",this.callDelegateMethod("ShouldGetSuggestions",this,t))}},_addEventListeners:{enumerable:!1,value:function(){this.element.addEventListener("keyup",this),this.element.addEventListener("input",this)}},_removeEventListeners:{enumerable:!1,value:function(){this.element.removeEventListener("keyup",this),this.element.removeEventListener("input",this)}},_getPopup:{enumerable:!1,value:function(){var t=this.popup;return t||(t=new Popup,t.content=this.resultsList,t.anchor=this.element,t.delegate=this,t.focusOnShow=!1,this.popup=t),this.popup}},willPositionPopup:{value:function(t){var e=t.anchorElement,n=getElementPosition(e);return{left:n.left,top:n.top+30}}},enterDocument:{value:function(t){t&&(this._addEventListeners(),this.element.classList.add("matte-Autocomplete"),this.resultsController=new RangeController,this.resultsController.selection=[],this.defineBinding("resultsController.content",{"<-":"suggestions"}),this.defineBinding("suggestedValue",{"<-":"resultsController.selection[0]"}),this.resultsList=new ResultsList,this.defineBinding("resultsList.contentController",{"<-":"resultsController"}),this.defineBinding("resultsList.activeIndexes",{"<-":"_activeIndexes"}),this.defineBinding("resultsList.textPropertyPath",{"<-":"textPropertyPath"}),this._getPopup())}},prepareForActivationEvents:{value:function(){var t=new PressComposer;this.addComposer(t)}},draw:{value:function(){this.super(),this._valueSyncedWithInputField||(this.tokens&&(this.value=this.tokens.join(this.separator)),this.value&&this.value.charAt(this.value.length-1)!=this.separator&&(this.value+=this.separator),this.element.value=this.value,this._valueSyncedWithInputField=!0);var t=this.showPopup;""===this.value&&(t=!1),t?(this.popup.show(),this.activeItemIndex=0):this.popup&&this.popup.displayed&&this.popup.hide();var e="loading"===this.loadingStatus;this.element.classList[e?"add":"remove"]("matte-Autocomplete--loading")}},handleKeyup:{enumerable:!1,value:function(t){var e=t.keyCode,n=this._getPopup();switch(e){case KEY_DOWN:if(n.displayed){var i=this.suggestions||[];i.length>0&&this.activeItemIndex<i.length-1?this.activeItemIndex++:this.activeItemIndex=0}else n.show(),this.activeItemIndex=0;break;case KEY_UP:n.displayed===!0&&(this.activeItemIndex>0?this.activeItemIndex--:this.activeItemIndex=0);break;case KEY_ENTER:n.displayed===!0?(this.resultsController.selection=[this.suggestions[this.activeItemIndex]],t.preventDefault()):this.suggestedValue=this.tokens[this.tokens.length-1]}this.element.focus()}}});