montageDefine("a85f63b","ui/rich-text-editor/overlays/rich-text-resizer.reel/rich-text-resizer",{dependencies:["montage/ui/component","montage/core/dom","montage/core/geometry/point"],factory:function(t,e){var n=t("montage/ui/component").Component,i=t("montage/core/dom"),a=t("montage/core/geometry/point").Point;e.RichTextResizer=n.specialize({_isActive:{enumerable:!1,value:!1},_editor:{enumerable:!1,value:null},target:{enumerable:!1,value:null},_draggedElement:{enumerable:!1,value:null},_needsReset:{enumerable:!1,value:!1},initWithEditor:{value:function(t){this._editor=t}},editorMouseDown:{value:function(t){var e=t.target;return this._isActive&&e===this.element?(t.preventDefault(),t.stopPropagation(),!0):void 0}},editorTouchStart:{value:function(t){this.editorMouseDown(t)}},editorMouseUp:{value:function(t){var e=t.target,n=this.target;if(this._observedPointer)return!0;if(e===this.element&&this._editor.activeOverlay==this)this._editor.hideOverlay(),t.target=this.target,t.preventDefault(),t.stopPropagation();else{if("IMG"===e.tagName)return e!==n&&(n&&(n.classList.remove("matte-Resizer-element"),0==n.classList.length&&n.removeAttribute("class")),this.target=e,this._needsReset=!0,this._isActive?this.needsDraw=!0:(this._ignoreNextSelectionchanged=!0,this._editor.showOverlay(this))),t.preventDefault(),t.stopPropagation(),!0;this._editor.activeOverlay==this&&this._editor.hideOverlay()}return!1}},editorTouchEnd:{value:function(t){this.editorMouseUp(t)}},editorSelectionDidChange:{value:function(){return this._ignoreNextSelectionchanged||this._finalizeDrag?this._ignoreNextSelectionchanged=!1:(this._editor.activeOverlay==this&&this._editor.hideOverlay(),this.target=null),!1}},draw:{enumerable:!1,value:function(){var t,e=this.element,n=this.target,s=this._editor.innerElement;if(this._needsReset){var r,o,l=function(t){for(o=t.offsetTop,r=t.offsetLeft;(t=t.offsetParent)&&t!=s;)o+=t.offsetTop,r+=t.offsetLeft};l(n),t=e.style,t.width=n.offsetWidth+"px",t.height=n.offsetHeight+"px",t.top=o+"px",t.left=r+"px",this._editor.innerElement.classList.remove("matte-Editor--resizing"),n.classList.add("matte-Resizer-element"),this.image.src=n.src,this.image.title=n.title,this.image.alt=n.alt,this._selectElement(n),this._needsReset=!1}if(this._draggedElement){var c=(new a).init(0,0),h=i.convertPointFromNodeToPage(e,c),u=this._cursorPosition,d=this._draggedElement.getAttribute("data-montage-id").substring("matte-resizer-handle-".length),p=this._resizerFrameInfo,g=p.ratio,m=parseFloat(e.style.height,10),f=parseFloat(e.style.width,10),v=parseFloat(e.style.top,10),_=parseFloat(e.style.left,10),b=15;this._editor.innerElement.classList.add("matte-Editor--resizing"),"n"==d?(m+=h.y-u.y,v=p.top-(m-p.height)):"ne"==d?(m+=h.y-u.y,f=Math.round(m*g),u.x>h.x+f&&(f=u.x-h.x,m=Math.round(f/g)),v=p.top-(m-p.height)):"e"==d?f=u.x-h.x:"se"==d?(m=u.y-h.y,f=Math.round(m*g),u.x>h.x+f&&(f=u.x-h.x,m=Math.round(f/g))):"s"==d?m=u.y-h.y:"sw"==d?(m=u.y-h.y,f=Math.round(m*g),u.x<=h.x-f+e.clientWidth&&(f=e.clientWidth+h.x-u.x,m=Math.round(f/g)),_=p.left-(f-p.width)):"w"==d?(f+=h.x-u.x,_=p.left-(f-p.width)):"nw"==d&&(m+=h.y-u.y,f=Math.round(m*g),u.x<=h.x-f+e.clientWidth&&(f=e.clientWidth+h.x-u.x,m=Math.round(f/g)),v=p.top-(m-p.height),_=p.left-(f-p.width)),m>b&&f>b&&(e.style.height=m+"px",e.style.width=f+"px",e.style.top=v+"px",e.style.left=_+"px")}if(this._finalizeDrag){f=e.clientWidth,m=e.clientHeight,this._editor.innerElement.classList.remove("matte-Editor--resizing"),n.classList.remove("matte-Resizer-element"),0==n.classList.length&&n.removeAttribute("class"),this._selectElement(n);var L,y,C=document.createElement("div");C.appendChild(n.cloneNode(!0)),L=C.firstChild,L.width=f,L.height=m,L.style.removeProperty("width"),L.style.removeProperty("height"),y=L.id,L.id="matte-editor-resized-image",this._editor.execCommand("inserthtml",!1,C.innerHTML,"Resizing Image"),n=document.getElementById(L.id),n&&(void 0!==y&&""!==y?n.id=y:n.removeAttribute("id"),this.target=n,this._needsReset=!0,this.needsDraw=!0),this._finalizeDrag=!1}}},didBecomeActive:{value:function(){this._isActive=!0,this.element.addEventListener(window.Touch?"touchstart":"mousedown",this,!1),window.addEventListener("resize",this,!1)}},didBecomeInactive:{value:function(){var t=this.target;this._isActive=!1,this.element.removeEventListener(window.Touch?"touchstart":"mousedown",this,!1),window.removeEventListener("resize",this,!1),this._draggedElement&&(window.Touch?(document.removeEventListener("touchmove",this),document.removeEventListener("touchend",this)):(document.removeEventListener("mousemove",this),document.removeEventListener("mouseup",this)),this._releaseInterest()),t&&(t.classList.remove("matte-Resizer-element"),0==t.classList.length&&t.removeAttribute("class"),this._editor.markDirty()),this.target=null,this._needsReset=!1,this._draggedElement=null,this._finalizeDrag=!1}},handleResize:{enumerable:!1,value:function(){this._needsReset=!0,this.needsDraw=!0}},handleMousedown:{value:function(t){var e=t.target,n=this.element;e.classList.contains("matte-Resizer-handle")&&(window.Touch?(this._observePointer(e.id),document.addEventListener("touchmove",this),document.addEventListener("touchend",this)):(this._observePointer("mouse"),document.addEventListener("mousemove",this),document.addEventListener("mouseup",this)),this._resizerFrameInfo={width:n.clientWidth,height:n.clientHeight,left:parseInt(n.style.left,10),top:parseInt(n.style.top,10),ratio:n.clientWidth/n.clientHeight},this._cursorPosition={x:t.pageX,y:t.pageY},this._draggedElement=e,t.preventDefault(),t.stopPropagation())}},handleTouchstart:{value:function(t){this.handleMousedown(t)}},handleMousemove:{value:function(t){this._cursorPosition={x:t.pageX,y:t.pageY},this.needsDraw=!0,t.preventDefault(),t.stopPropagation()}},handleTouchmove:{value:function(t){this.handleMousemove(t)}},handleMouseup:{value:function(t){this._draggedElement&&(window.Touch?(document.removeEventListener("touchmove",this),document.removeEventListener("touchend",this)):(document.removeEventListener("mousemove",this),document.removeEventListener("mouseup",this)),this._draggedElement=null,this._finalizeDrag=!0,this.needsDraw=!0,this._releaseInterest(),t.preventDefault(),t.stopPropagation())}},handleTouchend:{value:function(t){this.handleMouseup(t)}},surrenderPointer:{value:function(){return!1}},_observePointer:{value:function(t){this.eventManager.claimPointer(t,this),this._observedPointer=t}},_releaseInterest:{value:function(){this.eventManager.forfeitPointer(this._observedPointer,this),this._observedPointer=null}},_selectElement:{value:function(t){this._ignoreNextSelectionchanged=!0,this._editor.selectElement(t)}}})}});