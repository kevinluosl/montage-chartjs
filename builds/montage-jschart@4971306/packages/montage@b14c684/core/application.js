var Montage=require("./core").Montage,Target=require("./target").Target,MontageWindow=require("../window-loader/montage-window").MontageWindow,Slot;require("./dom");var Application=exports.Application=Target.specialize({eventManager:{value:null},parentApplication:{value:null},mainApplication:{get:function(){for(var t=this;t.parentApplication;)t=t.parentApplication;return t}},_windowsSortOrder:{value:"reverse-z-order"},windowsSortOrder:{get:function(){return null==this.parentApplication?this._windowsSortOrder:this.mainApplication.windowsSortOrder},set:function(t){null==this.parentApplication?-1!==["z-order","reverse-z-order","z-order","reverse-open-order"].indexOf(t)&&(this._windowsSortOrder=t):this.mainApplication.windowsSortOrder=t}},windows:{get:function(){var t;if(null==this.parentApplication){if(!this._windows){var t=new MontageWindow;t.application=this,t.window=window,this.window=t,this._windows=[this.window],this._multipleWindow=!0}return this._windows}return this.mainApplication.windows}},_window:{value:null},window:{get:function(){if(!this._window&&this==this.mainApplication){var t=new MontageWindow;t.application=this,t.window=window,this._window=t}return this._window},set:function(t){this._window||(this._window=t)}},attachedWindows:{value:[]},eventManagerForWindow:{value:function(t){return t.defaultEventMananger}},focusWindow:{get:function(){var t=this.windows,e=this.windowsSortOrder;if("z-order"==e)return t[0];if("reverse-z-order"==e)return t[t.length-1];for(var i in t)if(t[i].focused)return t[i]}},delegate:{value:null},nextTarget:{get:function(){return this.delegate}},openWindow:{value:function(t,e,i){var a,s,n=this,l=new MontageWindow,o={location:!1,menubar:!1,resizable:!0,scrollbars:!0,status:!1,titlebar:!0,toolbar:!1},c={module:t,name:e,parent:window,callback:function(t,e){var i;a=t.document.application,l.window=t,l.application=a,l.component=e,a.window=l,n.attachedWindows.push(l),i=n.mainApplication.windowsSortOrder,"z-order"==i||"reverse-open-order"==i?n.windows.unshift(l):n.windows.push(l),s=document.createEvent("CustomEvent"),s.initCustomEvent("load",!0,!0,null),l.dispatchEvent(s)}};if(this!==this.mainApplication||this._multipleWindow||this.window,"object"==typeof i){var r,h,p="",g="";for(r in i)i.hasOwnProperty(r)&&(o[r]=i[r])}var d=["name"];for(r in o)-1==d.indexOf(r)&&(h=o[r],"boolean"==typeof h?h=h?"yes":"no":(h+="",h.match(/[ ,"]/)&&(h='"'+h.replace(/"/g,'\\"')+'"')),g+=p+r+"="+h,p=",");return self.mr.loadPackage({name:"montage"}).then(function(t){var e=window.open(t.location+"window-loader/index.html","_blank",g);e.loadInfo=c}).done(),l}},attachWindow:{value:function(t){var e,i=t.application.parentApplication;return i!==this&&(i&&i.detachWindow(t),t.parentApplication=this,this.attachedWindows.push(t),e=this.mainApplication.windowsSortOrder,"z-order"==e||"reverse-open-order"==e?this.windows.unshift(t):this.windows.push(t),t.focus()),t}},detachWindow:{value:function(t){var e,i,a=this.windows;return void 0===t&&(t=this.window),i=t.application.parentApplication,i==this?(e=this.attachedWindows.indexOf(t),-1!==e&&this.attachedWindows.splice(e,1),e=a.indexOf(t),-1!==e&&a.splice(e,1),t.application.parentApplication=null):i&&i.detachWindow(t),t}},constructor:{value:function(){window.loadInfo&&!this.parentApplication&&(this.parentApplication=window.loadInfo.parent.document.application)}},_load:{value:function(t,e){var i,a=this;exports.application=a,require.async("ui/component").then(function(s){return i=s.__root__,i.element=document,require("./template").instantiateDocument(window.document,t).then(function(){a.callDelegateMethod("willFinishLoading",a),i.needsDraw=!0,e&&e(a)})}).done()}},_alertPopup:{value:null,enumerable:!1},_confirmPopup:{value:null,enumerable:!1},_notifyPopup:{value:null,enumerable:!1},_zIndex:{value:null},_isSystemPopup:{value:function(t){return"alert"===t||"confirm"===t||"notify"===t}},_createPopupSlot:{value:function(t){var e=document.createElement("div");document.body.appendChild(e),e.style.zIndex=t,e.style.position="absolute";var i=new Slot;return i.element=e,i.attachToParentComponent(),i}},getPopupSlot:{value:function(t,e,i){var a=this;require.async("ui/slot.reel/slot").then(function(s){Slot=Slot||s.Slot,t=t||"custom";var n,l,o=a._isSystemPopup(t);if(a.popupSlots=a.popupSlots||{},o)switch(t){case"alert":n=9004;break;case"confirm":n=9003;break;case"notify":n=9002}else a._zIndex=a._zIndex?a._zIndex+1:7e3,n=a._zIndex;l=a.popupSlots[t],l||(l=a.popupSlots[t]=a._createPopupSlot(n)),o||(l.element.style.zIndex=n),l.content=e,i.call(this,l)}).done()}},returnPopupSlot:{value:function(t){var e=this;if(e.popupSlots&&e.popupSlots[t]){var i=e.popupSlots[t];i.content=null}}},_getActivePopupSlots:{value:function(){var t=[];if(this.popupSlots){var e=Object.keys(this.popupSlots);if(e&&e.length>0){var i,a=0,s=e.length;for(a=0;s>a;a++)i=this.popupSlots[e[a]],i&&null!==i.content&&t.push(i)}}return t}}});