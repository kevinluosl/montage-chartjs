montageDefine("b14c684","core/event/event-manager",{dependencies:["../core","../uuid","./mutable-event","../serialization"],factory:function(t,e){var i,n=t("../core").Montage,a=t("../uuid"),s=t("./mutable-event").MutableEvent,o=t("../serialization").Serializer,l=t("../serialization").Deserializer;if("undefined"!=typeof window){window.Touch===void 0&&"ontouchstart"in window&&(window.Touch=function(){},function(){var t;document.addEventListener("touchstart",t=function(e){window.Touch=e.touches[0].constructor,document.nativeRemoveEventListener?document.nativeRemoveEventListener("touchstart",t,!0):document.removeEventListener("touchstart",t,!0),i&&i.isStoringPointerEvents&&(i.isStoringPointerEvents=!1,i.isStoringPointerEvents=!0)},!0)}()),n.specialize({type:{value:null},listener:{value:null},capture:{value:null}});var r=n.specialize({constructor:{value:function(t){return this.data=Array(32),this.velocity={velocity:(new h).initWithIdentifier(t)},this}},data:{enumerable:!1,writable:!0,value:null},size:{enumerable:!1,writable:!0,value:0},pos:{enumerable:!1,writable:!0,value:0},velocity:{enumerable:!1,writable:!0,value:0}}),c=n.specialize({constructor:{value:function(t,e,i){return this.clientX=t,this.clientY=e,this.timeStamp=i,this}},clientX:{enumerable:!1,writable:!0,value:null},clientY:{enumerable:!1,writable:!0,value:0},timeStamp:{enumerable:!1,writable:!0,value:0}});n.specialize({memory:{value:{}},add:{value:function(t,e,i,n){var a;(a=this.memory[t])||(a=this.memory[t]=new r(t)),(data=a.data[a.pos])?(data.clientX=e,data.clientY=i,data.timeStamp=n):data=a.data[a.pos]=new c(e,i,n),a.size<a.data.length&&a.size++,a.pos=(a.pos+1)%a.data.length}},remove:{value:function(t){delete this.memory[t]}},clear:{value:function(t){this.memory[t]&&(this.memory[t].size=0,this.memory[t].velocity.velocity.clearCache())}},getMemory:{value:function(t){return this.memory[t]}},isStored:{value:function(t){return this.memory[t]&&this.memory[t].size>0}},pointerVelocity:{value:function(t){return this.memory[t]?this.memory[t].velocity:void 0}},storeEvent:{value:function(t){var e;switch(t.type){case"mousedown":i._isMouseDragging=!0;case"mousemove":i._isStoringMouseEventsWhileDraggingOnly?i._isMouseDragging&&(this.add("mouse",t.clientX,t.clientY,t.timeStamp),Object.defineProperty(t,"velocity",{get:function(){return i.pointerMotion("mouse").velocity},set:function(){}})):(this.add("mouse",t.clientX,t.clientY,t.timeStamp),Object.defineProperty(t,"velocity",{get:function(){return i.pointerMotion("mouse").velocity},set:function(){}}));break;case"mouseup":this.add("mouse",t.clientX,t.clientY,t.timeStamp),Object.defineProperty(t,"velocity",{get:function(){return i.pointerMotion("mouse").velocity},set:function(){}});break;case"touchstart":case"touchmove":for(e=0;t.touches.length>e;e++)this.add(t.touches[e].identifier,t.touches[e].clientX,t.touches[e].clientY,t.timeStamp);break;case"touchend":for(e=0;t.changedTouches.length>e;e++)this.add(t.changedTouches[e].identifier,t.changedTouches[e].clientX,t.changedTouches[e].clientY,t.timeStamp)}}},removeEvent:{value:function(t){var e;switch(t.type){case"mouseup":i._isMouseDragging=!1,i._isStoringMouseEventsWhileDraggingOnly&&this.clear("mouse");break;case"touchend":for(e=0;t.changedTouches.length>e;e++)this.remove(t.changedTouches[e].identifier)}}}});var h=n.specialize({_identifier:{enumerable:!1,writable:!0,value:null},initWithIdentifier:{value:function(t){return this._identifier=t,this}},clearCache:{value:function(){return this._data=this._x=this._y=this._speed=this._angle=null,this}},_data:{enumerable:!1,writable:!0,value:null},_x:{enumerable:!1,writable:!0,value:null},_y:{enumerable:!1,writable:!0,value:null},_speed:{enumerable:!1,writable:!0,value:null},_angle:{enumerable:!1,writable:!0,value:null},x:{get:function(){return null===this._x&&(null===this._data&&(this._data=i._getPointerVelocityData(this._identifier)),this._x=i._calculatePointerVelocity(this._data.time,this._data.x)),this._x},set:function(){}},y:{get:function(){return null===this._y&&(null===this._data&&(this._data=i._getPointerVelocityData(this._identifier)),this._y=i._calculatePointerVelocity(this._data.time,this._data.y)),this._y},set:function(){}},speed:{get:function(){return null===this._speed&&(this._speed=Math.sqrt(this.x*this.x+this.y*this.y)),this._speed},set:function(){}},angle:{get:function(){return null===this._angle&&(this._angle=Math.atan2(this.y,this.x)),this._angle},set:function(){}}}),d=function(){return this.listeners={},this};d._pool=[],d.checkoutRegistration=function(){return 0===this._pool.length?new this:this._pool.pop()},d.checkinRegistration=function(t){t.target=null,this._pool.push(t)},Object.defineProperties(d.prototype,{target:{enumerable:!1,writable:!0,value:null},listeners:{enumerable:!1,writable:!0,value:null}});var p=function(){return this};p._pool=[],p.checkoutRegistration=function(){return 0===this._pool.length?new this:this._pool.pop()},p.checkinRegistration=function(t){t.listener=null,this._pool.push(t)},Object.defineProperties(p.prototype,{initWithListener:{value:function(t,e,i){return this.listener=t,this.capture=e,this.bubble=i,this}},listener:{enumerable:!1,writable:!0,value:null},capture:{enumerable:!1,writable:!0,value:!0},bubble:{enumerable:!1,writable:!0,value:!1}}),o.defineSerializationUnit("listeners",function(t,e){var n,a,s,o=i,l=e.uuid,r=[];for(var c in o.registeredEventListeners)if(n=o.registeredEventListeners[c],a=n&&n[l])for(var h in a.listeners)s=a.listeners[h],r.push({type:c,listener:t.addObjectReference(s.listener),capture:s.capture});return r.length>0?r:void 0}),l.defineDeserializationUnit("listeners",function(t,e,i){for(var n,a=0;n=i[a];a++)e.addEventListener(n.type,n.listener,n.capture)});var u=Event.NONE,g=Event.CAPTURING_PHASE,m=Event.AT_TARGET,f=Event.BUBBLING_PHASE,v="function";e.EventManager=n.specialize({constructor:{value:function(){this.super()}},eventDefinitions:{value:{abort:{bubbles:!1,cancelable:!1},beforeunload:{bubbles:!1},blur:{bubbles:!1,cancelable:!1},change:{bubbles:!0,cancelable:!1},click:{bubbles:!0,cancelable:!0},close:{bubbles:!1,cancelable:!1},compositionend:{bubbles:!0,cancelable:!1},compositionstart:{bubbles:!0,cancelable:!0},compositionupdate:{bubbles:!0,cancelable:!1},contextmenu:{bubbles:!0,cancelable:!0},copy:{bubbles:!0,cancelable:!0},cut:{bubbles:!0,cancelable:!0},dblclick:{bubbles:!0,cancelable:!1},DOMActivate:{bubbles:!0,cancelable:!0,deprecated:!0},DOMMouseScroll:{bubbles:!0},drag:{bubbles:!0,cancelable:!0},dragend:{bubbles:!0,cancelable:!1},dragenter:{bubbles:!0,cancelable:!0},dragleave:{bubbles:!0,cancelable:!1},dragover:{bubbles:!0,cancelable:!0},dragstart:{bubbles:!0,cancelable:!0},drop:{bubbles:!0,cancelable:!0},error:{bubbles:function(t){return!(XMLHttpRequest.prototype.isPrototypeOf(t)||t.tagName&&"VIDEO"===t.tagName.toUpperCase()||t.tagName&&"AUDIO"===t.tagName.toUpperCase())},cancelable:!1},focus:{bubbles:!1,cancelable:!1},focusin:{bubbles:!0,cancelable:!1},focusout:{bubbles:!0,cancelable:!1},input:{bubbles:!0,cancelable:!1},keydown:{bubbles:!0,cancelable:!1},keypress:{bubbles:!0,cancelable:!1},keyup:{bubbles:!0,cancelable:!1},load:{bubbles:!1,cancelable:!1},loadend:{bubbles:!1,cancelable:!1},loadstart:{bubbles:!1,cancelable:!1},message:{bubbles:!1,cancelable:!1},mousedown:{bubbles:!0,cancelable:!0},mouseenter:{bubbles:!1,cancelable:!1},mouseleave:{bubbles:!1,cancelable:!1},mousemove:{bubbles:!0,cancelable:!0},mouseout:{bubbles:!0,cancelable:!0},mouseover:{bubbles:!0,cancelable:!0},mouseup:{bubbles:!0,cancelable:!0},mousewheel:{bubbles:!0},orientationchange:{bubbles:!1},paste:{bubbles:!0,cancelable:!0},progress:{bubbles:!1,cancelable:!1},reset:{bubbles:!0,cancelable:!1},resize:{bubbles:!1,cancelable:!1},scroll:{bubbles:function(t){return!!t.defaultView},cancelable:!1},select:{bubbles:!0,cancelable:!1},submit:{bubbles:!0,cancelable:!0},touchcancel:{bubbles:!0,cancelable:!1},touchend:{bubbles:!0,cancelable:!0},touchmove:{bubbles:!0,cancelable:!0},touchstart:{bubbles:!0,cancelable:!0},unload:{bubbles:!1,cancelable:!1},wheel:{bubbles:!0,cancelable:!0}}},_DOMPasteboardElement:{value:null,enumerable:!1},_delegate:{value:null,enumerable:!1},delegate:{enumerable:!1,get:function(){return this._delegate},set:function(t){this._delegate=t}},_application:{value:null,enumerable:!1},application:{enumerable:!1,get:function(){return this._application},set:function(t){this._application=t}},_registeredWindows:{value:null,enumerable:!1},_windowsAwaitingFinalRegistration:{value:{},enumerable:!1},initWithWindow:{enumerable:!1,value:function(t){if(this._registeredWindows)throw"EventManager has already been initialized";return this.registerWindow(t),this}},registerWindow:{enumerable:!1,value:function(t){if(t.defaultEventManager&&t.defaultEventManager!==this)throw"EventManager cannot register a window already registered to another EventManager";if(this._registeredWindows&&this._registeredWindows.indexOf(t)>=0)throw"EventManager cannot register a window more than once";if(this._registeredWindows||(this._registeredWindows=[]),t.uuid&&0!==t.uuid.length||(t.uuid=a.generate()),this._windowsAwaitingFinalRegistration[t.uuid]!==t){if(t.Element.prototype.nativeAddEventListener=t.Element.prototype.addEventListener,Object.defineProperty(t,"nativeAddEventListener",{configurable:!0,value:t.addEventListener}),Object.getPrototypeOf(t.document).nativeAddEventListener=t.document.addEventListener,t.XMLHttpRequest.prototype.nativeAddEventListener=t.XMLHttpRequest.prototype.addEventListener,t.Worker&&(t.Worker.prototype.nativeAddEventListener=t.Worker.prototype.addEventListener),t.MediaController&&(t.MediaController.prototype.nativeAddEventListener=t.MediaController.prototype.addEventListener),t.Element.prototype.nativeRemoveEventListener=t.Element.prototype.removeEventListener,Object.defineProperty(t,"nativeRemoveEventListener",{configurable:!0,value:t.removeEventListener}),Object.getPrototypeOf(t.document).nativeRemoveEventListener=t.document.removeEventListener,t.XMLHttpRequest.prototype.nativeRemoveEventListener=t.XMLHttpRequest.prototype.removeEventListener,t.Worker&&(t.Worker.prototype.nativeRemoveEventListener=t.Worker.prototype.removeEventListener),t.MediaController&&(t.MediaController.prototype.nativeRemoveEventListener=t.MediaController.prototype.removeEventListener),Object.defineProperty(t,"addEventListener",{configurable:!0,value:t.XMLHttpRequest.prototype.addEventListener=t.Element.prototype.addEventListener=Object.getPrototypeOf(t.document).addEventListener=function(e,i,n){return t.defaultEventManager.registerEventListener(this,e,i,!!n)}}),t.Worker&&(t.Worker.prototype.addEventListener=t.addEventListener),t.MediaController&&(t.MediaController.prototype.addEventListener=t.addEventListener),Object.defineProperty(t,"removeEventListener",{configurable:!0,value:t.XMLHttpRequest.prototype.removeEventListener=t.Element.prototype.removeEventListener=Object.getPrototypeOf(t.document).removeEventListener=function(e,i,n){return t.defaultEventManager.unregisterEventListener(this,e,i,!!n)}}),t.Worker&&(t.Worker.prototype.removeEventListener=t.removeEventListener),t.MediaController&&(t.MediaController.prototype.removeEventListener=t.removeEventListener),t.HTMLDivElement.prototype.addEventListener!==t.Element.prototype.nativeAddEventListener&&t.HTMLElement&&"addEventListener"in t.HTMLElement.prototype){var s,o,l=Object.getOwnPropertyNames(t),r=0,c=l.length;for(r;c>r;r++)s=l[r],s.match(/^HTML\w*Element$/)&&"function"==typeof s&&(o=s.prototype,o.nativeAddEventListener=o.addEventListener,o.addEventListener=t.Element.prototype.addEventListener,o.nativeRemoveEventListener=o.removeEventListener,o.removeEventListener=t.Element.prototype.removeEventListener)}n.defineProperty(t.Element.prototype,"eventHandlerUUID",{value:void 0,enumerable:!1}),n.defineProperty(t.Element.prototype,"component",{get:function(){return i._elementEventHandlerByUUID[this.eventHandlerUUID]},enumerable:!1}),i=t.defaultEventManager=e.defaultEventManager=this,this._registeredWindows.push(t),this._windowsAwaitingFinalRegistration[t.uuid]=t,/loaded|complete|interactive/.test(t.document.readyState)?this._finalizeWindowRegistration(t):t.document.addEventListener("DOMContentLoaded",this,!0)}}},_finalizeWindowRegistration:{enumerable:!1,value:function(t){if(this._windowsAwaitingFinalRegistration[t.uuid]!==t)throw"EventManager wasn't expecting to register this window";delete this._windowsAwaitingFinalRegistration[t.uuid],this._listenToWindow(t)}},unregisterWindow:{enumerable:!1,value:function(t){if(0>this._registeredWindows.indexOf(t))throw"EventManager cannot unregister an unregistered window";if(this._registeredWindows=this._registeredWindows.filter(function(e){return t!==e}),delete t.defaultEventManager,t.Element.prototype.addEventListener=t.Element.prototype.nativeAddEventListener,Object.defineProperty(t,"addEventListener",{configurable:!0,value:t.nativeAddEventListener}),Object.getPrototypeOf(t.document).addEventListener=t.document.nativeAddEventListener,t.XMLHttpRequest.prototype.addEventListener=t.XMLHttpRequest.prototype.nativeAddEventListener,t.Worker&&(t.Worker.prototype.addEventListener=t.Worker.prototype.nativeAddEventListener),t.Element.prototype.removeEventListener=t.Element.prototype.nativeRemoveEventListener,Object.defineProperty(t,"removeEventListener",{configurable:!0,value:t.nativeRemoveEventListener}),Object.getPrototypeOf(t.document).removeEventListener=t.document.nativeRemoveEventListener,t.XMLHttpRequest.prototype.removeEventListener=t.XMLHttpRequest.prototype.nativeRemoveEventListener,t.Worker&&(t.Worker.prototype.removeEventListener=t.Worker.prototype.nativeRemoveEventListener),t.HTMLDivElement.prototype.nativeAddEventListener!==t.Element.prototype.addEventListener&&t.HTMLElement&&"addEventListener"in t.HTMLElement.prototype&&t.Components&&t.Components.interfaces){var e,i;for(e in Components.interfaces)e.match(/^nsIDOMHTML\w*Element$/)&&(e=e.replace(/^nsIDOM/,""),(e=window[e])&&(i=e.prototype,i.addEventListener=i.nativeAddEventListener,delete i.nativeAddEventListener,i.removeEventListener=i.nativeRemoveEventListener,delete i.nativeRemoveEventListener))}delete t.Element.prototype.nativeAddEventListener,delete t.nativeAddEventListener,delete Object.getPrototypeOf(t.document).nativeAddEventListener,delete t.XMLHttpRequest.prototype.nativeAddEventListener,t.Worker&&delete t.Worker.prototype.nativeAddEventListener,delete t.Element.prototype.nativeRemoveEventListener,delete t.nativeRemoveEventListener,delete Object.getPrototypeOf(t.document).nativeRemoveEventListener,delete t.XMLHttpRequest.prototype.nativeRemoveEventListener,t.Worker&&delete t.Worker.prototype.nativeRemoveEventListener,delete t.Element.prototype.eventHandlerUUID,delete t.Element.prototype.component,this._stopListeningToWindow(t)}},unregisterWindows:{enumerable:!1,value:function(){this._registeredWindows.forEach(this.unregisterWindow)}},registeredEventListeners:{enumerable:!1,value:{}},registeredEventListenersForEventType_:{value:function(t){var e,i,n,a,s=this.registeredEventListeners[t];if(!s)return null;a={};for(e in s){i=s[e].listeners;for(n in i)a[n]=i[n]}return a}},registeredEventListenersForEventType_onTarget_:{enumerable:!1,value:function(t,e,i){var n,a;return n=e===i?i.eventManager.registeredEventListeners[t]:this.registeredEventListeners[t],n?(a=n[e.uuid],a?a.listeners:null):null}},registeredEventListenersOnTarget_:{value:function(t){var e,i,n=[];for(e in this.registeredEventListeners)i=this.registeredEventListeners[e],t.uuid in i&&n.push(i);return n}},registerEventListener:{enumerable:!1,value:function(t,e,i,n){var a,s,o,l=this.registeredEventListeners[e],r=!1,c=!1;if(t.uuid===void 0)throw Error("EventManager cannot observe a target without a uuid: "+(t.outerHTML||t));return l?((a=l[t.uuid])||((a=l[t.uuid]=d.checkoutRegistration()).target=t,r=!0),s=a.listeners[i.uuid],o=n?"capture":"bubble",s?(s[o]=!0,c=!0):(a.listeners[i.uuid]=p.checkoutRegistration().initWithListener(i,n,!n),c=!0)):(l=this.registeredEventListeners[e]={},(l[t.uuid]=d.checkoutRegistration()).target=t,l[t.uuid].listeners[i.uuid]=p.checkoutRegistration().initWithListener(i,n,!n),r=!0,c=!0),r&&"function"==typeof t.nativeAddEventListener&&this._observeTarget_forEventType_(t,e),c}},unregisterEventListener:{enumerable:!1,value:function(t,e,i,n){var a,s,o,l,r,c=this.registeredEventListeners[e];if(c&&(a=c[t.uuid])){if(s=a.listeners[i.uuid],!s){for(l in a.listeners)if(r=a.listeners[l].listener,r.originalListener&&r.originalListener.uuid===i.uuid){s=a.listeners[l],i=r;break}if(!s)return}o=n?"capture":"bubble",s[o]=!1,s.bubble||s.capture||(p.checkinRegistration(a.listeners[i.uuid]),delete a.listeners[i.uuid],0===Object.keys(a.listeners).length&&(delete c[t.uuid],d.checkinRegistration(a),0===Object.keys(c).length&&(delete this.registeredEventListeners[e],this._stopObservingTarget_forEventType_(t,e))))}}},actualDOMTargetForEventTypeOnTarget:{value:function(t,e){if(e.nativeAddEventListener){if(e.defaultView)return e;var i,n=this.eventDefinitions[t];return n?(i=typeof n.bubbles===v?n.bubbles(e):n.bubbles,i?e.screen?e.document:e.ownerDocument:e):e}return null}},_observedTarget_byEventType_:{value:{}},_observeTarget_forEventType_:{enumerable:!1,value:function(t,e){var i;!(i=this.actualDOMTargetForEventTypeOnTarget(e,t))||this._observedTarget_byEventType_[e]&&this._observedTarget_byEventType_[e][i.uuid]||(this._observedTarget_byEventType_[e]||(this._observedTarget_byEventType_[e]={}),this._observedTarget_byEventType_[e][i.uuid]=this,i.nativeAddEventListener(e,this,!0))}},_stopObservingTarget_forEventType_:{enumerable:!1,value:function(t,e){var i;i=this.actualDOMTargetForEventTypeOnTarget(e,t),i&&(delete this._observedTarget_byEventType_[e][i.uuid],i.nativeRemoveEventListener(e,this,!0))}},_activationHandler:{enumerable:!0,value:null},_listenToWindow:{enumerable:!1,value:function(t){if(!this._activationHandler){var e=this;this._activationHandler=function(t){var i,n=t.type;if("focus"===n||"mousedown"===n||"touchstart"===n)if(t.changedTouches){i=t.changedTouches.length;for(var a=0;i>a;a++)e._prepareComponentsForActivation(t.changedTouches[a].target)}else e._prepareComponentsForActivation(t.target)}}if(t.Touch?t.document.nativeAddEventListener("touchstart",this._activationHandler,!0):t.document.nativeAddEventListener("mousedown",this._activationHandler,!0),t.document.nativeAddEventListener("focus",this._activationHandler,!0),this.application){var i,n=this.registeredEventListenersOnTarget_(this.application);for(i in n)this._observeTarget_forEventType_(t,i)}}},_stopListeningToWindow:{enumerable:!1,value:function(t){var e,i=this.registeredEventListenersOnTarget_(this.application),n=this.registeredEventListenersOnTarget_(t);for(e in i)this._stopObservingTarget_forEventType_(t,e);for(e in n)this._stopObservingTarget_forEventType_(t,e)}},reset:{enumerable:!1,value:function(){var t,e,i,n;for(t in this.registeredEventListeners){e=this.registeredEventListeners[t];for(i in e.targets)n=e.targets[i],this._stopObservingTarget_forEventType_(n.target,t)}this.registeredEventListeners={},this._claimedPointers={}}},unload:{enumerable:!1,value:function(){this._stopListening()}},methodNameForBubblePhaseOfEventType:{enumerable:!1,value:function(t){return function(e,i){var n=i?e+"+"+i:e;return t[n]||(t[n]="handle"+(i?i.toCapitalized():"")+e.toCapitalized())}}({})},_methodNameForCapturePhaseByEventType_:{value:{}},methodNameForCapturePhaseOfEventType:{enumerable:!1,value:function(t){return function(e,i){var n=i?e+"+"+i:e;return t[n]||(t[n]="capture"+(i?i.toCapitalized():"")+e.toCapitalized())}}({})},_claimedPointers:{enumerable:!1,distinct:!0,value:{}},componentClaimingPointer:{value:function(t){return this._claimedPointers[t]}},isPointerClaimedByComponent:{value:function(t,e){if(!e)throw"Must specify a valid component to see if it claims the specified pointer, '"+e+"' is not valid.";return this._claimedPointers[t]===e}},claimPointer:{value:function(t,e){if(!t&&0!==t)throw"Must specify a valid pointer to claim, '"+t+"' is not valid.";if(!e)throw"Must specify a valid component to claim a pointer, '"+e+"' is not valid.";var i=this._claimedPointers[t];return i===e?!0:i?i.surrenderPointer(t,e)?(this._claimedPointers[t]=e,!0):!1:(this._claimedPointers[t]=e,!0)}},forfeitPointer:{value:function(t,e){if(e!==this._claimedPointers[t])throw"Not allowed to forfeit pointer '"+t+"' claimed by another component";delete this._claimedPointers[t]}},forfeitAllPointers:{value:function(t){var e,i;for(e in this._claimedPointers)i=this._claimedPointers[e],t===i&&delete this._claimedPointers[e]}},_isStoringPointerEvents:{enumerable:!1,value:!1},isStoringPointerEvents:{enumerable:!0,get:function(){return this._isStoringPointerEvents},set:function(t){t===!0?this._isStoringPointerEvents||(this._isStoringPointerEvents=!0,window.Touch&&Object.defineProperty(Touch.prototype,"velocity",{get:function(){return i.pointerMotion(this.identifier).velocity},set:function(){}})):(this._isStoringPointerEvents=!1,this._pointerStorage.memory={},this._isMouseDragging=!1)}},_isStoringMouseEventsWhileDraggingOnly:{enumerable:!1,value:!0},isStoringMouseEventsWhileDraggingOnly:{enumerable:!0,get:function(){return this._isStoringMouseEventsWhileDraggingOnly},set:function(t){this._isStoringMouseEventsWhileDraggingOnly=t===!0?!0:!1}},_isMouseDragging:{enumerable:!1,value:!1},_pointerStorage:{enumerable:!1,value:{memory:{},add:function(t,e){this.memory[t]||(this.memory[t]={data:Array(32),size:0,pos:0}),this.memory[t].data[this.memory[t].pos]=e,this.memory[t].size<this.memory[t].data.length&&this.memory[t].size++,this.memory[t].pos=(this.memory[t].pos+1)%this.memory[t].data.length},remove:function(t){delete this.memory[t]},clear:function(t){this.memory[t]&&(this.memory[t].size=0)},getMemory:function(t){return this.memory[t]},isStored:function(t){return this.memory[t]&&this.memory[t].size>0},storeEvent:function(t){var e;switch(t.type){case"mousedown":i._isMouseDragging=!0;case"mousemove":i._isStoringMouseEventsWhileDraggingOnly?i._isMouseDragging&&(this.add("mouse",{clientX:t.clientX,clientY:t.clientY,timeStamp:t.timeStamp}),Object.defineProperty(t,"velocity",{get:function(){return i.pointerMotion("mouse").velocity},set:function(){}})):(this.add("mouse",{clientX:t.clientX,clientY:t.clientY,timeStamp:t.timeStamp}),Object.defineProperty(t,"velocity",{get:function(){return i.pointerMotion("mouse").velocity},set:function(){}}));break;case"mouseup":this.add("mouse",{clientX:t.clientX,clientY:t.clientY,timeStamp:t.timeStamp}),Object.defineProperty(t,"velocity",{get:function(){return i.pointerMotion("mouse").velocity},set:function(){}});break;case"touchstart":case"touchmove":for(e=0;t.touches.length>e;e++)this.add(t.touches[e].identifier,{clientX:t.touches[e].clientX,clientY:t.touches[e].clientY,timeStamp:t.timeStamp});break;case"touchend":for(e=0;t.changedTouches.length>e;e++)this.add(t.changedTouches[e].identifier,{clientX:t.changedTouches[e].clientX,clientY:t.changedTouches[e].clientY,timeStamp:t.timeStamp})}},removeEvent:function(t){var e;switch(t.type){case"mouseup":i._isMouseDragging=!1,i._isStoringMouseEventsWhileDraggingOnly&&this.clear("mouse");break;case"touchend":for(e=0;t.changedTouches.length>e;e++)this.remove(t.changedTouches[e].identifier)}}}},_getPointerVelocityData:{enumerable:!1,value:function(t){var e,n,a,s,o,l,r,c,h,d=0,p=!0,u={x:[],y:[],time:[]};for(e=i._pointerStorage.getMemory(t),n=e.data.length,a=e.data[(e.pos-1+n)%n],s=o=l=a.timeStamp,r=a.clientX,c=a.clientY;p&&o>s-350&&e.size>d;)a=e.data[(e.pos-d-1+n)%n],o=a.timeStamp,h=r*r+c*c,h>2&&50>=l-o?(u.x.push(a.clientX),u.y.push(a.clientY),u.time.push(o),l=o,r=a.clientX,c=a.clientY,d++):p=!1;return u}},_fitPointerCurve:{enumerable:!1,value:function(t,e){var i,n,a,s,o,l,r,c,h,d,p,u,g,m,f,v,L,C,y,x,w,M,b,z,S,_,P,T,E,B,k,D,A,O,F,R,I,W,Y=1e-4,X=e.length;do{for(p=0,u=0,g=0,m=0,f=0,v=0,C=0,y=0,x=0,w=0,M=0,b=0,S=0,_=0,P=0,T=0,E=0,B=0,D=0,A=0,O=0,F=0,R=0,I=0,d=0;X>d;d++)o=e[d],l=o.t,c=l*l,h=c*l,r=o.v,L=Y*(6*(c-l)-h+2),z=6*Y*(h-2*c+l),k=6*Y*(c-h),W=2*Y*h,v+=L*L,b+=z*z,B+=k*k,I+=W*W,p+=r*L,C+=r*z,S+=r*k,D+=r*W,g-=L,x-=z,P-=k,O-=W,u-=L*l,y-=z*l,_-=k*l,A-=W*l,m-=L*c,w-=z*c,T-=k*c,F-=W*c,f-=L*h,M-=z*h,E-=k*h,R-=W*h;Y*=2}while(0===v||0===b||0===B||0===I);for(l=Y/v,p*=l,u*=3*l,g*=l,m*=3*l,f*=l,l=Y/b,C*=l,y*=3*l,x*=l,w*=3*l,M*=l,l=Y/B,S*=l,_*=3*l,P*=l,T*=3*l,E*=l,l=Y/I,D*=l,A*=3*l,O*=l,F*=3*l,R*=l,v=t[0],b=t[1],B=t[2],I=t[3],i=3*(b-B)+I-v,n=v+B-2*b,a=b-v,s=v,d=0;20>d;d++)l=p+s*g+a*u+n*m+i*f,v+=l,s+=l,i-=l,n+=l,a-=l,l=C+s*x+a*y+n*w+i*M,b+=l,i+=3*l,n-=l+l,a+=l,l=S+s*P+a*_+n*T+i*E,B+=l,i-=3*l,n+=l,l=D+s*O+a*A+n*F+i*R,I+=l,i+=l;t[0]=v,t[1]=b,t[2]=B,t[3]=I}},_pointerBezierValue:{enumerable:!1,value:function(t,e){var i=1-t;return i*i*i*e[0]+3*i*i*t*e[1]+3*i*t*t*e[2]+t*t*t*e[3]}},_calculatePointerVelocity:{enumerable:!1,value:function(t,e){var i,n,a=t.length,s=t[0],o=t[0],l=0;for(n=1;a>n;n++)s>t[n]&&(s=t[n],l=n);if(i=o-s){if(a>5){var r,c,h,d=[];for(n=0;a>n;n++)d[n]={v:e[n],t:(t[n]-s)/i};return r=d[l].v,c=d[0].v,h=[r,(2*r+c)/3,(r+2*c)/3,c],this._fitPointerCurve(h,d),5e3*(this._pointerBezierValue(.8,h)-this._pointerBezierValue(.6,h))/i}return a>1?1e3*(e[0]-e[l])/i:0}return 0}},pointerMotion:{value:function(t){if(i._pointerStorage.isStored(t)){var e={};return Object.defineProperties(e,{_data:{enumerable:!1,writable:!0,value:null},_x:{enumerable:!1,writable:!0,value:null},_y:{enumerable:!1,writable:!0,value:null},_speed:{enumerable:!1,writable:!0,value:null},_angle:{enumerable:!1,writable:!0,value:null},x:{get:function(){return null===this._x&&(null===this._data&&(this._data=i._getPointerVelocityData(t)),this._x=i._calculatePointerVelocity(this._data.time,this._data.x)),this._x},set:function(){}},y:{get:function(){return null===this._y&&(null===this._data&&(this._data=i._getPointerVelocityData(t)),this._y=i._calculatePointerVelocity(this._data.time,this._data.y)),this._y},set:function(){}},speed:{get:function(){return null===this._speed&&(this._speed=Math.sqrt(this.x*this.x+this.y*this.y)),this._speed},set:function(){}},angle:{get:function(){return null===this._angle&&(this._angle=Math.atan2(this.y,this.x)),this._angle},set:function(){}}}),{velocity:e}}return void 0}},monitorDOMModificationInEventHandling:{value:!1},domModificationEventHandler:{value:n.specialize({handleEvent:{value:function(){throw"DOM Modified"}},captureDOMSubtreeModified:{value:function(){throw"DOMSubtreeModified"}},captureDOMAttrModified:{value:function(){throw"DOMAttrModified"}},captureDOMCharacterDataModified:{value:function(){throw"DOMCharacterDataModified"}}})},handleEvent:{enumerable:!1,value:function(t){this.monitorDOMModificationInEventHandling&&(document.body.addEventListener("DOMSubtreeModified",this.domModificationEventHandler,!0),document.body.addEventListener("DOMAttrModified",this.domModificationEventHandler,!0),document.body.addEventListener("DOMCharacterDataModified",this.domModificationEventHandler,!0));var e,i,n,a,o,l,r,c,h,d,p,L,C,y,x=t.type,w=t.bubbles;for("DOMContentLoaded"===x&&(e=t.target.defaultView,e&&this._windowsAwaitingFinalRegistration[e.uuid]&&(this._finalizeWindowRegistration(e),t.target.removeEventListener("DOMContentLoaded",this,!0))),y="boolean"!=typeof t.propagationStopped?s.fromEvent(t):t,h=Element.isElement(y.target)||y.target instanceof Document||y.target===window?this._eventPathForDomTarget(y.target):this._eventPathForTarget(y.target),L=y.target.identifier?this.methodNameForCapturePhaseOfEventType(x,y.target.identifier):null,C=y.target.identifier?this.methodNameForBubblePhaseOfEventType(x,y.target.identifier):null,d=this.methodNameForCapturePhaseOfEventType(x),p=this.methodNameForBubblePhaseOfEventType(x),this.delegate&&typeof this.delegate.willDistributeEvent===v&&this.delegate.willDistributeEvent(y),this._isStoringPointerEvents&&this._pointerStorage.storeEvent(y),y.eventPhase=g,i=h.length-1;!y.propagationStopped&&(n=h[i]);i--)if(y.currentTarget=n,a=this.registeredEventListenersForEventType_onTarget_(x,n))for(r=Object.keys(a),o=0;a&&!y.immediatePropagationStopped&&(l=a[r[o]]);o++)l.capture&&(c=l.listener,L&&typeof c[L]===v?c[L](y):typeof c[d]===v?c[d](y):typeof c.handleEvent===v?c.handleEvent(y):typeof c!==v||c.__isConstructor__||c.call(n,y));if(!y.propagationStopped&&(y.eventPhase=m,y.currentTarget=n=y.target,a=this.registeredEventListenersForEventType_onTarget_(x,n)))for(r=Object.keys(a),o=0;a&&!y.immediatePropagationStopped&&(l=a[r[o]]);o++)c=l.listener,l.capture&&(L&&typeof c[L]===v?c[L](y):typeof c[d]===v?c[d](y):typeof c.handleEvent===v?c.handleEvent(y):typeof c===v&&c.call(n,y)),l.bubble&&(C&&typeof c[C]===v?c[C](y):typeof c[p]===v?c[p](y):typeof c.handleEvent===v?c.handleEvent(y):typeof c===v&&c.call(n,y));for(y.eventPhase=f,i=0;w&&!y.propagationStopped&&(n=h[i]);i++)if(y.currentTarget=n,a=this.registeredEventListenersForEventType_onTarget_(x,n))for(r=Object.keys(a),o=0;a&&!y.immediatePropagationStopped&&(l=a[r[o]]);o++)l.bubble&&(c=l.listener,C&&typeof c[C]===v?c[C](y):typeof c[p]===v?c[p](y):typeof c.handleEvent===v?c.handleEvent(y):typeof c===v&&c.call(n,y));y.eventPhase=u,y.currentTarget=null,this._isStoringPointerEvents&&this._pointerStorage.removeEvent(t),this.monitorDOMModificationInEventHandling&&(document.body.removeEventListener("DOMSubtreeModified",this.domModificationEventHandler,!0),document.body.removeEventListener("DOMAttrModified",this.domModificationEventHandler,!0),document.body.removeEventListener("DOMCharacterDataModified",this.domModificationEventHandler,!0))}},_prepareComponentsForActivation:{value:function(t){var e,i,n=t,a=n&&n.defaultView?n.defaultView:window,s=a.document?a.document:document,o=!1,l=null;do switch(n&&(i=this.eventHandlerForElement(n),i&&(o||(o=!0,l=this._findActiveTarget(i)),i._preparedForActivationEvents||(i._prepareForActivationEvents(),i._preparedForActivationEvents=!0))),e=n,n){case a:n=null;break;case s:n=a;break;case s.documentElement:n=s;break;default:n=n.parentNode}while(n&&e!==n);this.activeTarget=l}},_findActiveTarget:{value:function(t){for(var e=null,i={};!e&&t&&!(t.uuid in i);)i[t.uuid]=t,t.acceptsActiveTarget?e=t:t=t.nextTarget;return e}},_eventPathForTarget:{enumerable:!1,value:function(t){if(!t)return[];var e=t,i=this.application,n=[],a={};a[t.uuid]=t;do e.uuid in a||(n.push(e),a[e.uuid]=e),e=e.nextTarget,(!e||e.uuid in a)&&(e=i),e&&e.uuid in a&&(e=null);while(e);return n}},_eventPathForDomTarget:{enumerable:!1,value:function(t){if(!t)return[];var e,i=t,n=i&&i.defaultView?i.defaultView:window,a=n.document?n.document:document,s=this.application,o=[];do switch(i!==t&&o.push(i),e=i,i){case s:i=i.parentApplication,i&&(s=i);break;case n:i=s;break;case a:i=n;break;case a.documentElement:i=a;break;default:i=i.parentNode,i||(i=s)}while(i&&e!==i);return o}},_elementEventHandlerByUUID:{enumerable:!1,value:{}},registerEventHandlerForElement:{enumerable:!1,value:function(t,e){var i=this.eventHandlerForElement(e);i&&this.unregisterEventHandlerForElement(e),this._elementEventHandlerByUUID[e.eventHandlerUUID=t.uuid]=t}},unregisterEventHandlerForElement:{enumerable:!1,value:function(t){delete this._elementEventHandlerByUUID[t.eventHandlerUUID],delete t.eventHandlerUUID}},eventHandlerForElement:{enumerable:!1,value:function(t){return this._elementEventHandlerByUUID[t.eventHandlerUUID]}},_activeTarget:{value:null},activeTarget:{get:function(){return this._activeTarget||this.application},set:function(t){t||(t=this.application),t===this._activeTarget||this.activeTarget&&!this.activeTarget.surrendersActiveTarget(t)||(t.willBecomeActiveTarget(this.activeTarget),this._activeTarget=t,t.didBecomeActiveTarget())}}})}}});