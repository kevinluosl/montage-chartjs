var Montage=require("../core").Montage,defaultEventManager=require("./event-manager").defaultEventManager,MutableEvent=require("./mutable-event").MutableEvent,KEYNAMES_TO_KEYCODES={backspace:8,tab:9,enter:13,shift:16,control:17,alt:18,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,"delete":46,semicolon:186,colon:186,equal:187,plus:187,comma:188,less:188,minus:189,underscore:189,period:190,greater:190,slash:191,questionmark:191,backtick:192,tilde:192,openingsquarebracket:219,openingcurlybracket:219,backslash:220,pipe:220,closingsquarebracket:221,closingcurlybracket:221,singlequote:222,doublequote:222,clear:12,meta:91,contextmenu:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimal:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,f13:124,f14:125,f15:126,f16:127,f17:128,f18:129,f19:130,f20:131,f21:132,f22:133,f23:134,f24:135},KEYCODES_TO_KEYNAMES=null,OPERAMAC_KEYNAMES_TO_KEYCODES={meta:17,control:57392,f17:63252,f18:63253,f19:63254,f20:63255,f21:63256,f22:63257,f23:63258,f24:63259},FIREFOX_KEYNAMES_TO_KEYCODES={f13:44,f14:145,f15:19,f16:63251,f17:63252,f18:63253,f19:63254,f20:63255,f21:63256,f22:63257,f23:63258,f24:63259,meta:224},KEYNAMES_ALIASES={cmd:"command",ctl:"control",ctrl:"control",win:"meta",windows:"meta",opt:"alt",option:"alt"},MODIFIERS={meta:{name:"meta",value:1},alt:{name:"alt",value:2},control:{name:"control",value:4},shift:{name:"shift",value:8}},NORMALIZED_KEYS={semicolon:";",colon:":",equal:"=",plus:"+",comma:",",less:"<",minus:"-",underscore:"_",period:".",greater:">",slash:"/",questionmark:"?",backtick:"`",tilde:"~",openingsquarebracket:"[",openingcurlybracket:"{",backslash:"\\",pipe:"|",closingsquarebracket:"]",closingcurlybracket:"}",singlequote:"'",doublequote:'"',multiply:"*",add:"+",subtract:"-",decimal:".",divide:"/"},NORMALIZED_CHARS=null,KEYPRESS_EVENT_TYPE="keyPress",LONGKEYPRESS_EVENT_TYPE="longKeyPress",KEYRELEASE_EVENT_TYPE="keyRelease",KeyManager=exports.KeyManager=Montage.specialize({_keyEventsListenerInstalled:{value:!1},_composerKeyMap:{value:{}},_triggeredKeys:{value:{}},_longPressKeys:{value:{}},_cleanupTimeout:{value:null},_cleanupThreshold:{value:2e3},_longPressThreshold:{value:1e3},longPressThreshold:{get:function(){return this._longPressThreshold},set:function(t){t>0&&t!==this._longPressThreshold&&(this._longPressThreshold=t,this._cleanupThreshold=this._longPressThreshold>this._cleanupThreshold-100?this._longPressThreshold+100:2e3)}},registerKey:{value:function(t){var e,i,n,a,s,o=this._normalizeKeySequence(t.keys),l=this._composerKeyMap,r=!1;if(o){if(e=this._convertKeysToModifiersAndKeyCode(o),i=l[e.modifiers],i||(i=l[e.modifiers]={}),n=i[e.keyCode]){for(s in n)if(a=n[s],a.object===t){a.refCount++,r=!0;break}r||n.push({object:t,refCount:1})}else i[e.keyCode]=[{object:t,refCount:1}];t._modifiers=e.modifiers,t._keyCode=e.keyCode,this._registerListeners()}}},unregisterKey:{value:function(t){var e,i,n,a,s=this._composerKeyMap;if(e=s[t._modifiers]){i=e[t._keyCode];for(a in i)n=i[a],n.object===t&&(n.refCount--,0>=n.refCount&&(i.splice(a,1),0===i.length&&(delete e[t._keyCode],0===Object.keys(e).length&&(delete s[t._modifiers],0===Object.keys(s).length&&this._unregisterListeners()))))}}},constructor:{value:function(){var t,e=navigator.userAgent;if(_defaultKeyManager&&console.warn("Rather than creating a new KeyManager object, you might want to use the default key manager"),e.match(/ firefox\//i)?this._firefox=!0:e.match(/ appleWebkit\//i)?(this._webkit=!0,e.match(/ chrome\//i)&&(this._chrome=!0)):e.match(/^opera\//i)&&(this._opera=!0),e.match(/macintosh/i)&&(this._mac=!0,this._opera&&(this._operaMac=!0)),MODIFIERS.command=this._mac?MODIFIERS.meta:MODIFIERS.control,this._operaMac)for(t in OPERAMAC_KEYNAMES_TO_KEYCODES)KEYNAMES_TO_KEYCODES[t]=OPERAMAC_KEYNAMES_TO_KEYCODES[t];if(this._firefox)for(t in FIREFOX_KEYNAMES_TO_KEYCODES)KEYNAMES_TO_KEYCODES[t]=FIREFOX_KEYNAMES_TO_KEYCODES[t];KEYCODES_TO_KEYNAMES={};for(var i in KEYNAMES_TO_KEYCODES){var t=KEYNAMES_TO_KEYCODES[i];void 0===KEYCODES_TO_KEYNAMES[t]&&(KEYCODES_TO_KEYNAMES[t]=i)}NORMALIZED_CHARS={};for(var i in NORMALIZED_KEYS){var t=NORMALIZED_KEYS[i];void 0===NORMALIZED_CHARS[t]&&(NORMALIZED_CHARS[t]=i)}this._shiftKey=!1,this._altKey=!1,this._metaKey=!1,this._ctrlKey=!1}},captureKeydown:{value:function(t){var e,i,n,a=!1;this._preprocessKeyEvent(t),n=this._submap,n&&(e=this._keyCode,e&&n[e]&&(a=this._dispatchComposerKeyMatches(n[e],t)),!a&&t.keyIdentifier&&(i=KEYNAMES_TO_KEYCODES[t.keyIdentifier.toLowerCase()]||this._decodeKeyIdentifier(t.keyIdentifier),i&&i!==e&&n[i]&&this._dispatchComposerKeyMatches(n[i],t))),this._setupCleanupTimer()}},captureKeypress:{value:function(t){var e,i,n,a=t.charCode,s=!1;this._preprocessKeyEvent(t),n=this._submap,n&&(e=this._keyCode,e&&n[e]&&(s=this._dispatchComposerKeyMatches(n[e],t)),!s&&a&&a!==e&&n[a]&&(s=this._dispatchComposerKeyMatches(n[a],t)),!s&&t.keyIdentifier&&(i=KEYNAMES_TO_KEYCODES[t.keyIdentifier.toLowerCase()]||this._decodeKeyIdentifier(t.keyIdentifier),i&&i!==e&&n[i]&&this._dispatchComposerKeyMatches(n[i],t))),this._setupCleanupTimer()}},captureKeyup:{value:function(t){var e,i,n,a,s=t.keyCode,o=0,l=!1;if(this._preprocessKeyEvent(t),i=this._submap,i&&(s=this._keyCode,s&&i[s]&&(l=this._dispatchComposerKeyMatches(i[s],t),o=s),!l&&t.keyIdentifier&&(e=KEYNAMES_TO_KEYCODES[t.keyIdentifier.toLowerCase()]||this._decodeKeyIdentifier(t.keyIdentifier),e&&e!==o&&i[e]&&(l=this._dispatchComposerKeyMatches(i[e],t)))),!l)for(a in this._triggeredKeys)n=this._triggeredKeys[a],(n._keyCode==s||n._keyCode==e)&&this._dispatchComposerKeyMatches([n],t);this._cleanup()}},_normalizeKeySequence:{value:function(t){var e,i,n=[MODIFIERS.meta.name,MODIFIERS.alt.name,MODIFIERS.control.name,MODIFIERS.shift.name],a=t.toLowerCase().replace(/ /g,"").replace(/\+\+/g,"+add").split("+"),s=a.length,o=[];for(i=0;s-1>i;i++){if(e=a[i],e=KEYNAMES_ALIASES[e]||e,e=MODIFIERS[e],!e)return console.warn("Invalid key sequence (modifier):",t),null;o.push(e.name)}return o.sort(function(t,e){return n.indexOf(t)-n.indexOf(e)}),e=a[s-1],e.length>1&&!KEYNAMES_TO_KEYCODES[e]?(console.warn("Invalid key sequence (key):",t,e),null):o.length?o.join("+")+"+"+e:e}},_preprocessKeyEvent:{value:function(t){var e,i,n=this,a=t.type,s=t.keyCode;this._operaMac&&this._operaModifierTimeout&&(clearTimeout(this._operaModifierTimeout),this._operaModifierTimeout=null),("keydown"==a||"keyup"==a)&&(this._operaMac?(i="keydown"==a,s==KEYNAMES_TO_KEYCODES.shift?this._shiftKey=i:s==KEYNAMES_TO_KEYCODES.alt?this._altKey=i:s==KEYNAMES_TO_KEYCODES.meta?this._mac&&(this._metaKey=i):s==KEYNAMES_TO_KEYCODES.control&&(this._ctrlKey=i),"keyup"==a&&(this._operaModifierTimeout=setTimeout(function(){n._shiftKey=!1,n._altKey=!1,n._metaKey=!1,n._ctrlKey=!1,n._operaModifierTimeout=null},this._cleanupThreshold+1e3))):(this._shiftKey=t.shiftKey,this._altKey=t.altKey,this._metaKey=t.metaKey,this._ctrlKey=t.ctrlKey)),this._mac&&this._webkit&&s==KEYNAMES_TO_KEYCODES.contextmenu&&(this._metaKey=!1),this._chrome&&(this._shiftKey||s!=KEYNAMES_TO_KEYCODES.plus||"U+002B"!=t.keyIdentifier||(t.keyCode=KEYNAMES_TO_KEYCODES.add)),this._modifiers=e=(this._shiftKey?MODIFIERS.shift.value:0)+(this._altKey?MODIFIERS.alt.value:0)+(this._metaKey?MODIFIERS.meta.value:0)+(this._ctrlKey?MODIFIERS.control.value:0),this._submap=this._composerKeyMap[e],this._keyCode=t.keyCode,this._keyIdentifier=t.keyIdentifier}},_registerListeners:{value:function(){this._keyEventsListenerInstalled||(window.addEventListener("keydown",this,!0),window.addEventListener("keypress",this,!0),window.addEventListener("keyup",this,!0),this._keyEventsListenerInstalled=!0)}},_unregisterListeners:{value:function(){this._keyEventsListenerInstalled&&(window.removeEventListener("keydown",this,!0),window.removeEventListener("keypress",this,!0),window.removeEventListener("keyup",this,!0),this._keyEventsListenerInstalled=!1)}},_dispatchComposerKeyMatches:{value:function(t,e){var i,n,a,s,o=this,l=!1,r="keyup"==e.type,c="keydown"==e.type,h=r?KEYRELEASE_EVENT_TYPE:KEYPRESS_EVENT_TYPE,d=t.length;for(t=t.slice(),s=0;d>s&&!l;s++){i=t[s].object||t[s];for(var p=e.target,u=i.element,g=i.element===window;!g&&(g=p===u,p!=document);)p=p.parentElement,p||(p=document);if(g||defaultEventManager.activeTarget==i.component){if(r){if(a=Object.keys(this._triggeredKeys),-1==a.indexOf(i.uuid))continue;i._longPressTimeout&&(clearTimeout(i._longPressTimeout),i._longPressTimeout=null,delete this._longPressKeys[i.uuid])}else{if(c)delete this._triggeredKeys[i.uuid],e.preventDefault();else if(this._triggeredKeys[i.uuid])continue;i._shouldDispatchLongPress&&!i._longPressTimeout&&(i._longPressTimeout=setTimeout(function(){var t;i._longPressTimeout=null,t=document.createEvent("CustomEvent"),t.initCustomEvent(LONGKEYPRESS_EVENT_TYPE,!0,!0,null),t.activeElement=e.target,t.identifier=i.identifier,t=MutableEvent.fromEvent(t),i.dispatchEvent(t),delete o._longPressKeys[i.uuid]},this._longPressThreshold),this._longPressKeys[i.uuid]=i)}n=document.createEvent("CustomEvent"),n.initCustomEvent(h,!0,!0,null),n.activeElement=e.target,n.identifier=i.identifier,n.keyComposer=i,n=MutableEvent.fromEvent(n),this._opera&&(n.type=h),i.dispatchEvent(n),n.defaultPrevented&&e.preventDefault(),n.propagationStopped&&(e.stopPropagation(),l=!0),r?delete this._triggeredKeys[i.uuid]:this._triggeredKeys[i.uuid]=i}}if(l)for(s=r?s:0;d>s;s++)i=t[s].object||t[s],delete this._triggeredKeys[i.uuid],i._longPressTimeout&&(clearTimeout(i._longPressTimeout),i._longPressTimeout=null,delete this._longPressKeys[i.uuid]);return l}},_cleanup:{value:function(){var t,e;this._cleanupTimeout&&clearTimeout(this._cleanupTimeout);for(e in this._triggeredKeys)this._triggeredKeys.hasOwnProperty(e)&&delete this._triggeredKeys[e];for(e in this._longPressKeys)this._longPressKeys.hasOwnProperty(e)&&(t=this._longPressKeys[e],clearTimeout(t._longPressTimeout),t._longPressTimeout=null,delete this._longPressKeys[e]);this._cleanupTimeout=null}},_setupCleanupTimer:{value:function(){var t=this;this._cleanupTimeout&&clearTimeout(this._cleanupTimeout),this._cleanupTimeout=setTimeout(function(){t._cleanup()},this._cleanupThreshold)}},_convertKeysToModifiersAndKeyCode:{value:function(t){var e,i,n,a=0,s=0;for(t=t.toLowerCase().replace(/ /g,"").replace(/\+\+/g,"+add").split("+"),e=t.length,n=0;e-1>n;n++){if(i=t[n],i=KEYNAMES_ALIASES[i]||i,i=MODIFIERS[i],!i)return console.warn("Invalid Key sequence:",t),null;s|=i.value}return i=t[e-1],i=NORMALIZED_CHARS[i]||i,i=NORMALIZED_KEYS[i]||i,i.length>1?(a=KEYNAMES_TO_KEYCODES[i],i=MODIFIERS[KEYNAMES_ALIASES[i]||i],i&&(s|=i.value)):a=i.toUpperCase().charCodeAt(0),{modifiers:s,keyCode:a}}},_decodeKeyIdentifier:{value:function(t){return t.match(/U\+/)?parseInt(t.substring(2),16):void 0}}}),_defaultKeyManager=null;Montage.defineProperty(exports,"defaultKeyManager",{get:function(){return _defaultKeyManager||(_defaultKeyManager=new KeyManager),_defaultKeyManager}});