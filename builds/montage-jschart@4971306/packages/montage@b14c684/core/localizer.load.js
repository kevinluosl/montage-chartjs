montageDefine("b14c684","core/localizer",{dependencies:["./core","./messageformat","./logger","./serialization","./promise","./bindings","collections/listen/property-changes","frb/bindings","frb/stringify","frb/expand","frb/scope","./messageformat-locale"],factory:function(t,e){var i=t("./core").Montage,n=t("./messageformat"),a=t("./logger").logger("localizer"),s=t("./serialization").Serializer,r=t("./serialization").Deserializer,o=t("./promise").Promise,l=t("./bindings").Bindings,c=(t("collections/listen/property-changes"),t("frb/bindings")),h=t("frb/stringify"),u=t("frb/expand"),d=t("frb/scope");n.locale=t("./messageformat-locale");var p="key",g="default",f="montage_locale",m="locale",v="messages",L="manifest.json",C=function(){return""},y=/^[a-zA-Z]+(?:-[a-zA-Z0-9]+)*$/,w=e.Localizer=i.specialize({constructor:{value:function w(){this.super()}},init:{value:function(t){return this.locale=t||b.locale,this}},initWithMessages:{value:function(t,e){return this.locale=t,this.messages=e,this}},messageFormat:{serializable:!1,value:null},_messages:{value:null},messages:{get:function(){return this._messages},set:function(t){if(this._messages!==t){if(null!=t&&"object"!=typeof t)throw new TypeError(t," is not an object");this._messages=t}}},messagesPromise:{serializable:!1,value:null},_locale:{value:null},locale:{get:function(){return this._locale},set:function(t){if(!y.test(t))throw new TypeError("Language tag '"+t+"' is not valid. It must match http://tools.ietf.org/html/rfc5646 (alphanumeric characters separated by hyphens)");this._locale!==t&&(this._locale=t,this.messageFormat=new n(t))}},_availableLocales:{value:null},availableLocales:{get:function(){return this._availableLocales?this._availableLocales:this._availableLocales=this._manifest.get("files").get(m).get("files").then(function(t){return Object.keys(t)})}},_require:{value:self.mr},require:{serializable:!1,get:function(){return this._require},set:function(t){this._require!==t&&(this.__manifest=null,this._require=t)}},__manifest:{value:null},_manifest:{depends:["require"],get:function(){var t=this.require;return t.packageDescription.manifest===!0?this.__manifest?this.__manifest:this.__manifest=t.async(L):o.reject(Error("Package has no manifest. "+t.location+'package.json must contain "manifest": true and '+t.location+L+" must exist"))}},loadMessages:{value:function(t,e){if(!this.require)throw Error("Cannot load messages as",this,"require is not set");null===t&&(t=5e3),this.messages=null;var i=this;this.require;var n=this._manifest;return t&&(n=n.timeout(t)),this.messagesPromise=n.get("files").then(function(t){return i._loadMessageFiles(t)}).then(function(t){return i._collapseMessages(t)}).fail(function(t){throw console.error("Could not load messages for '"+i.locale+"': "+t),t}).then(function(t){return"function"==typeof e&&e(t),t})}},_loadMessageFiles:{value:function(t){var e=this.require;if(!t)return o.reject(Error(e.location+L+" does not contain a 'files' property"));var i,n,s,r,l=[];if(!(m in t))return o.reject(Error("Package does not contain a '"+m+"' directory"));for(i=t[m].files,n=this._locale;""!==n;)i.hasOwnProperty(n)&&(s=i[n].files,(r=v+".js")in s||(r=v+".json")in s?l.push(e.async(m+"/"+n+"/"+r)):a.isDebug&&a.debug(this,"Warning: '"+m+"/"+n+"/' does not contain '"+v+".json' or '"+v+".js'")),n=n.substring(0,n.lastIndexOf("-"));if(!l.length)return o.reject(Error("Could not find any "+v+".json or "+v+".js files"));var c=o.all(l);if(a.isDebug){var h=this;c=c.then(function(t){return a.debug(h,"loaded "+t.length+" message files"),t})}return c}},_collapseMessages:{value:function(t){for(var e={},i=0,n=t.length;n>i;i++){var a=t[i];for(var s in a)s in e||(e[s]=a[s])}return this.messages=e,e}},_compiledMessageCache:{value:Object.create(null)},localizeSync:{value:function(t,e){var i,a,s;if(!t&&!e)throw Error("Key or default message must be truthy, not "+t+" and "+e);if(this._messages&&t in this._messages){if(i=this._messages[t],a=typeof i,"function"===a)return i;if("object"===a){if(!("message"in i))throw Error(i,"does not contain a 'message' property");i=i.message}}else i=e;if(i||(console.warn("No message or default message for key '"+t+"'"),i=t),i in this._compiledMessageCache)return this._compiledMessageCache[i];var r=this.messageFormat.parse(i);return r.program&&r.program.statements&&1===r.program.statements.length&&"string"===r.program.statements[0].type?(s=function(){return i},s.toString=s):s=Function("MessageFormat","return "+this.messageFormat.precompile(r))(n),this._compiledMessageCache[i]=s,s}},localize:{value:function(t,e,i,n){var a,s=this;if(i=i===void 0?!0:i,!this.messagesPromise)return a=o.resolve(this.localizeSync(t,e)),a.then(n),a;var r=function(){var i=s.localizeSync(t,e);return"function"==typeof n&&n(i),i};return i?this.messagesPromise.then(r,r):this.messagesPromise.then(r)}}}),x=w.specialize({init:{value:function(){var t=this.callDelegateMethod("getDefaultLocale");return t||"undefined"==typeof window||(window.localStorage&&(t=window.localStorage.getItem(f)),t=t||window.navigator.userLanguage||window.navigator.language),t=t||"en",this.locale=t,this.loadMessages().done(),this}},_delegate:{value:null},delegate:{get:function(){return this._delegate},set:function(t){this._delegate!==t&&(this._delegate=t,this.init())}},locale:{get:function(){return this._locale},set:function(t){try{Object.getPropertyDescriptor(w.prototype,"locale").set.call(this,t)}catch(e){t="en",Object.getPropertyDescriptor(w.prototype,"locale").set.call(this,t)}"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem(f,t)}},reset:{value:function(){return"undefined"!=typeof window&&window.localStorage&&window.localStorage.removeItem(f),this.init(),this._locale}}}),b=e.defaultLocalizer=(new x).init();e.localize=b.localize.bind(b);var M=e.Message=i.specialize({constructor:{value:function(){this.defineBinding("_data",{"<-":"_dataObject.toMap()"}),this._data.addMapChangeListener(this,"data")}},init:{value:function(t,e,i){return t&&(this.key=t),e&&(this.defaultMessage=e),i&&(this.data=i),this}},_localizer:{value:b},localizer:{get:function(){return this._localizer},set:function(t){this._localizer!=t&&(this._localizer=t,this._localize())}},_key:{value:null},key:{get:function(){return this._key},set:function(t){this._key!==t&&(this._key=t,this._localize())}},_defaultMessage:{value:null},defaultMessage:{get:function(){return this._defaultMessage},set:function(t){this._defaultMessage!==t&&(this._defaultMessage=t,this._localize())}},_isLocalizeQueued:{value:!1},_localize:{value:function(){if(!this._isLocalizeQueued){this._isLocalizeQueued=!0;var t=this,e=o.defer();this._messageFunction=e.promise,this.localized=this._messageFunction.then(function(e){return e(t._data.toObject())}),o.nextTick(function(){return t._isLocalizeQueued=!1,t._key||t._defaultMessage?(e.resolve(t._localizer.localize(t._key,t._defaultMessage)),void 0):(console.warn("Both key and default message are falsey for",t,"If this is in a repetition this warning can be ignored"),e.resolve(C),void 0)})}}},_messageFunction:{value:o.resolve(C)},_dataObject:{value:null},_data:{value:null},data:{get:function(){return this._data},set:function(t){this._dataObject!==t&&(this._dataObject=t)}},__localizedResolved:{value:""},_localizedDeferred:{value:o.defer()},localized:{get:function(){return this._localizedDeferred.promise},set:function(t){if(t!==this._localized){var e=this,i=o.defer();this._localizedDeferred.resolve(i.promise),t.then(i.resolve,i.reject),i.promise.then(function(t){return e.__localizedResolved=t}).done(),this._localizedDeferred=i}}},handleDataMapChange:{value:function(){this.localized=this._messageFunction.fcall(this._data.toObject())}},serializeSelf:{value:function(){var t={_bindingDescriptors:this._bindingDescriptors};return t.key=this._key,t.defaultMessage=this._defaultMessage,this._localizer!==b&&(t.localizer=this._localizer),t}},serializeForLocalizations:{value:function(t){var e,i,n={};i=c.getBindings(this),i&&i.key?(n[p]={},this._serializeBinding(this,n[p],i.key,t)):n[p]=this._key,i&&i.defaultMessage?(n[g]={},this._serializeBinding(this,n[g],i.defaultMessage,t)):n[g]=this._defaultMessage;var a=c.getBindings(this._data);e=this._data.toObject();for(var s in e)!e.hasOwnProperty(s)||a&&a[".get('"+s+"')"]||(n.data||(n.data={}),n.data[s]=e[s]);for(var r in a){var o=/\.get\('([^']+)'\)/.exec(r)[1];n.data||(n.data={}),n.data[o]={},this._serializeBinding(this._data,n.data[o],a[r],t)}return n}},_serializeBinding:{value:function(t,e,i,n){if(!("serializable"in i)||i.serializable){var a=i.sourceSyntax;if(i.source!==t){var s=n.addObjectReference(i.source),r=new d({type:"component",label:s["@"]});r.components=n,a=u(a,r)}var r=new d;r.components=n;var o=h(a,r);i.twoWay?e["<->"]=o:e["<-"]=o,i.converter?e.converter=i.converter:(e.convert=i.convert,e.revert=i.revert),i.trace&&(e.trace=!0)}}}}),z=function(t,e,i,n,a,s){var r=new M;for(var o in a)"string"==typeof a[o]?r.data.set(o,a[o]):l.defineBinding(r.data,".get('"+o+"')",a[o],{components:s});"object"==typeof i?l.defineBinding(r,"key",i,{components:s}):r.key=i,"object"==typeof n?l.defineBinding(r,"defaultMessage",n,{components:s}):r.defaultMessage=n,l.defineBinding(t,e,{"<-":"__localizedResolved",source:r,serializable:!1})};s.defineSerializationUnit("localizations",function(t,e){var i=c.getBindings(e);if(i){var n;for(var a in i){var s=i[a];if(M.prototype.isPrototypeOf(s.source)){n||(n={});var r=s.source;n[a]=r.serializeForLocalizations(t)}}return n}}),r.defineDeserializationUnit("localizations",function(t,e,i){for(var n in i){var s,r,o=i[n];p in o?(!a.isDebug||g in o||a.debug(this,"Warning: localized property '"+n+"' does not contain a default message property ("+g+"), in ",e),s=o[p],r=o[g],z(e,n,s,r,o.data,t)):console.error("localized property '"+n+"' must contain a key property ("+p+"), in ",i[n])}})}});