montageDefine("b14c684","core/serialization/serialization",{dependencies:["../core","./serializer/montage-labeler","./deserializer/montage-reviver","frb/parse","frb/stringify"],factory:function(t,e){var i=t("../core").Montage,n=t("./serializer/montage-labeler").MontageLabeler,a=t("./deserializer/montage-reviver").MontageReviver,r=t("frb/parse"),s=t("frb/stringify"),o=i.specialize({_serializationString:{value:null},_serializationObject:{value:null},_serializationLabels:{value:null},initWithString:{value:function(t){return this._serializationString=t,this._serializationObject=null,this._serializationLabels=null,this}},initWithObject:{value:function(t){return this._serializationString=null,this._serializationObject=t,this._serializationLabels=null,this}},clone:{value:function(){var t=new o;return t.initWithString(this.getSerializationString()),t}},getSerializationObject:{value:function(){return this._serializationObject||(this._serializationObject=JSON.parse(this._serializationString)),this._serializationObject}},getSerializationString:{value:function(){return this._serializationString||(this._serializationString=JSON.stringify(this._serializationObject)),this._serializationString}},getSerializationLabels:{value:function(){var t;return this._serializationLabels||(t=this.getSerializationObject())&&(this._serializationLabels=Object.keys(t)),this._serializationLabels}},getExternalObjectLabels:{value:function(){var t=this.getSerializationObject(),e=[];for(var i in t)0===Object.keys(t[i]).length&&e.push(i);return e}},hasSerializationLabel:{value:function(t){return t in this.getSerializationObject()}},isExternalObject:{value:function(t){var e=this.getSerializationObject();return e&&t in e?0===Object.keys(e[t]).length:!1}},isAlias:{value:function(t){var e=this.getSerializationObject();return e&&t in e?"alias"in e[t]:!1}},getElementId:{value:function(t){var e=this.getSerializationObject(),n=i.getPath.call(e,t+".properties.element");return n?n["#"]:void 0}},getSerializationLabelsWithElements:{value:function(t){var e=new c,i=[];return e.initWithSerialization(this),e.visitSerialization(function(e){"Element"===e.type&&t.indexOf(e.data)>=0&&(e=e.parent,e&&"properties"===e.name&&(e=e.parent,e&&"montageObject"===e.type&&i.push(e.label)))}),i}},renameElementReferences:{value:function(t){var e=new c;e.initWithSerialization(this),e.visitSerialization(function(e){"Element"===e.type&&e.data in t&&(e.data=t[e.data])})}},renameSerializationLabels:{value:function(t){var e=new c;e.initWithSerialization(this),e.visitSerialization(function(e){if(e.label){var i=e.label;i in t&&(e.label=t[i])}if("reference"===e.type){var n=e.data;n in t&&(e.data=t[n])}})}},mergeSerialization:{value:function(t,e){return l.mergeSerializations(this,t,e)}},extractSerialization:{value:function(t,e){var i=new h;return i.initWithSerialization(this),i.extractSerialization(t,e)}}}),l=i.specialize(null,{mergeSerializations:{value:function(t,e,i){var n,a,r,s,o,l,c={};r=t.getSerializationLabels(),s=e.getSerializationLabels(),o=this._createCollisionTable(r,s,c,i&&i.labeler),i&&i.willMergeObjectWithLabel&&(l=this._willMergeObjectWithLabel(i,t,e,c),o=o||l),o&&(e=e.clone(),e.renameSerializationLabels(c),s=e.getSerializationLabels()),n=t.getSerializationObject(),a=e.getSerializationObject();for(var h,u=0;h=s[u];u++)-1===r.indexOf(h)&&(n[h]=a[h]);return t.initWithObject(n),c}},_willMergeObjectWithLabel:{value:function(t,e,i,n){var a,r,s,o,l,c=!1,h=i.getSerializationLabels();n&&(s=[],Object.keys(n).forEach(function(t){s.push(n[t])}));for(var u,d=0;u=h[d];d++)if(r=n&&n[u],a=t.willMergeObjectWithLabel(u,r),"string"==typeof a){if(o=this._isLabelValidInSerialization(a,e),o||(l=!this._isLabelValidInSerialization(a,i)&&-1===s.indexOf(a)),!o&&!l)throw Error("willMergeObjectWithLabel either needs to return a label that exists in the destination serialization to indicate it's the same object or return a completely new label to rename the object being merged. \""+a+'"  destination: '+e.getSerializationString()+"\n source: "+i.getSerializationString()+"\n collision table: "+JSON.stringify(n,null,4));c=!0,n[u]=a}return c}},_isLabelValidInSerialization:{value:function(t,e){var i,n;return e.hasSerializationLabel(t)?!0:(n=t.indexOf(":"),n>0&&(i=t.slice(0,n),e.hasSerializationLabel(i))?!0:!1)}},_createCollisionTable:{value:function(t,e,i,a){for(var r,s,o,l,a=a||new n,c=!1,h=Object.create(null),u=0;t.length>u;u++)o=t[u],l=o.indexOf(":"),l>0&&(r=o.slice(0,l),a.addLabel(r),h[r]=1),a.addLabel(o),h[o]=1;for(var u=0;o=e[u];u++)l=o.indexOf(":"),l>0?(r=o.slice(0,l),s=i[r],s?(i[o]=s+":"+o.slice(l+1),c=!0):r in h?(s=a.generateLabel(a.getLabelBaseName(r)),e.indexOf(r)>=0&&(i[r]=s),i[o]=s+o.slice(l),c=!0):a.addLabel(r)):o in h&&!(o in i)?(i[o]=a.generateLabel(a.getLabelBaseName(o)),c=!0):a.addLabel(o);return c}}}),c=i.specialize({initWithSerialization:{value:function(t){this._serialization=t}},visitSerialization:{value:function(t){var e=this._serialization.getSerializationObject();this._walkRootObjects(t,e),this._serialization.initWithObject(e)}},visitSerializationObject:{value:function(t,e){var i=this._serialization.getSerializationObject();if(!(t in i))throw Error('Object "'+t+'" does not exist in '+this._serialization.getSerializationString());this._walkRootObject(e,i,t),this._serialization.initWithObject(i)}},changeLabel:{value:function(t,e){var i,n=this._serialization.getSerializationObject();i=n[t],delete n[t],n[e]=i}},_walkRootObjects:{value:function(t,e){for(var i in e)this._walkRootObject(t,e,i)}},_walkRootObject:{value:function(t,e,i){var n=e[i];"value"in n?this._walkObject(t,n,"value",i):this._walkCustomObject(t,e,i)}},_walkObject:{value:function(t,e,i,n,r){var s,o=e[i],l=a.getTypeOf(o);if(s={type:l},n?s.label=n:s.name=i,r&&(s.parent=r),"number"===l||"string"===l||"null"===l)s.data=o,t(s),e[i]=s.data;else if("regexp"===l)s.data=o["/"],t(s),o["/"]=s.data;else if("reference"===l)s.data=o["@"],t(s),o["@"]=s.data;else if("Element"===l)s.data=o["#"],t(s),o["#"]=s.data;else if("array"===l){s.data=o,t(s),e[i]=o=s.data;for(var c=0,h=o.length;h>c;c++)this._walkObject(t,o,""+c,null,s)}else if("object"===l){s.data=o,t(s),e[i]=o=s.data;for(var i in o)this._walkObject(t,o,i,null,s)}s.label!=n&&this.changeLabel(n,s.label)}},_walkCustomObject:{value:function(t,e,i){var n,a=e[i];n={type:"montageObject",label:i,data:a},t(n),e[i]=a=n.data,n.label!=i&&this.changeLabel(i,n.label),a.properties&&this._walkObject(t,a,"properties",null,n),a.listeners&&this._walkObject(t,a,"listeners",null,n),a.bindings&&this._walkBindings(t,a,null,n),a.localizations&&this._walkLocalizations(t,a,null,n)}},_walkBindings:{value:function(t,e,i){var n,a=e.bindings;n={type:"bindings",data:a,parent:i},t(n),e.bindings=a=n.data;for(var r in a)this._walkBinding(t,a,r,n)}},_walkBinding:{value:function(t,e,i,n){var a,r=e[i];a={type:"binding",name:i,data:r,parent:n},t(a),e[i]=r=a.data,this._walkBindingData(t,r,a)}},_walkBindingData:{value:function(t,e,i){var n,a,o=!1;n=e["<-"]||e["<->"],a=Object.clone(r(n)),this._walksBindingReferences(a,function(e){var i={type:"reference",data:e.label};t(i),e.label!==i.data&&(e.label=i.data,o=!0)}),o&&("<-"in e?e["<-"]=s(a):e["<->"]=s(a)),e.converter&&this._walkObject(t,e,"converter",null,i)}},_walkLocalizations:{value:function(t,e,i){var n,a=e.localizations;n={type:"localizations",data:a,parent:i},t(n),e.localizations=a=n.data;for(var r in a)this._walkLocalization(t,a,r,n)}},_walkLocalization:{value:function(t,e,i,n){var a,r,s=e[i];if(a={type:"localization",name:i,data:s,parent:n},t(a),e[i]=s=a.data,"object"==typeof s.key&&this._walkBindingData(t,s.key,a),"object"==typeof s.default&&this._walkBindingData(t,s.default,a),"object"==typeof s.data){r=s.data;for(var i in r)this._walkBindingData(t,r[i],a)}}},_walksBindingReferences:{value:function(t,e){var i=t.args;if("component"===t.type&&e(t),i)for(var n=0,a=i.length;a>n;n++)this._walksBindingReferences(i[n],e)}}}),h=i.specialize({_serialization:{value:null},initWithSerialization:{value:function(t){this._serialization=t}},extractSerialization:{value:function(t,e){var i,n=new c,a={},r=[];i=this._serialization.getSerializationObject(),n.initWithSerialization(this._serialization);for(var s,l=0;s=t[l];l++)a[s]=i[s],n.visitSerializationObject(s,function(e){var i;"reference"===e.type&&(i=e.data,-1===r.indexOf(i)&&-1===t.indexOf(i)&&r.push(i))});if(e)for(var s,l=0;s=e[l];l++)s in i&&!(s in a)&&(a[s]={});for(var s,l=0;s=r[l];l++)a[s]={};return(new o).initWithObject(a)}}});e.Serialization=o,e.SerializationMerger=l,e.SerializationInspector=c,e.SerializationExtractor=h}});