montageDefine("b14c684","core/serialization/serializer/montage-visitor",{dependencies:["../../core","./montage-serializer","./properties-serializer","./self-serializer","./unit-serializer","../alias","mousse/serialization/visitor"],factory:function(t,e){var i=t("../../core").Montage,n=t("./montage-serializer"),a=t("./properties-serializer").PropertiesSerializer,r=t("./self-serializer").SelfSerializer,s=t("./unit-serializer").UnitSerializer,o=t("../alias").Alias,l=t("mousse/serialization/visitor").Visitor,c=i.specialize.call(l,{_MONTAGE_ID_ATTRIBUTE:{value:"data-montage-id"},_require:{value:null},_units:{value:null},_elements:{value:null},constructor:{value:function c(){}},initWithBuilderAndLabelerAndRequireAndUnits:{value:function(t,e,i,n){return l.call(this,t,e),this._require=i,this._units=n,this._elements=[],this}},getTypeOf:{value:function(t){return t.isModuleReference?"Module":t instanceof o?"Alias":"getInfoForObject"in t||"getInfoForObject"in t.constructor?"MontageObject":t.thisIsAReferenceCreatedByMontageSerializer?"MontageReference":"undefined"!=typeof Element&&Element.isElement(t)?"Element":void 0}},visitMontageReference:{value:function(t,e,i){this.builder.top.setProperty(i,e.reference)}},visitElement:{value:function(t,e,i){var n,a;if(a=e.getAttribute(this._MONTAGE_ID_ATTRIBUTE),!a)throw Error("Not possible to serialize a DOM element with no "+this._MONTAGE_ID_ATTRIBUTE+" assigned: "+e.outerHTML);n=this.builder.createElementReference(a),this.storeValue(n,e,i),this._elements.push(e)}},visitModule:{value:function(t,e,i){var n,a;try{a=e.resolve(this._require)}catch(r){throw Error("Not possible to serialize module reference "+e.id+" from package "+e.require.location+" inside package "+this._require.location)}n=this.builder.createModuleReference(a),this.storeValue(n,e,i)}},visitAlias:{value:function(t,e){var i=this.labeler.getTemplatePropertyLabel(e),n=this.builder.createCustomObject();n.setProperty("alias",e.value),this.builder.top.setProperty(i,n)}},visitMontageObject:{value:function(t,e,i){this.isObjectSerialized(e)?this.serializeReferenceToMontageObject(t,e,i):this.handleMontageObject(t,e,i)}},handleMontageObject:{value:function(t,e,i){var n,a=this.builder.createCustomObject();this.setObjectSerialization(e,a),n=this.serializeMontageObject(t,e,a),n?this.serializeSubstituteObject(t,e,i,a,n):(a.setLabel(this.labeler.getObjectLabel(e)),this.builder.top.setProperty(i,a))}},serializeReferenceToMontageObject:{value:function(t,e,i){var n=this.labeler.getObjectLabel(e),a=this.builder.createObjectReference(n);this.builder.top.setProperty(i,a)}},serializeSubstituteObject:{value:function(t,e,i,n,a){var r,s,o,l;r=this.labeler.getObjectLabel(e),this.labeler.isUserDefinedLabel(r)?(s=this.labeler.getObjectLabel(a),this.labeler.setObjectLabel(a,r),this.builder.relabelReferences(s,r),l=this.getObjectSerialization(a),l&&(l.setLabel(r),this.labeler.isUserDefinedLabel(s)&&this.builder.createObjectReference(r).setLabel(s)),t.visit(a,i)):(t.visit(a,i),o=this.labeler.getObjectLabel(a),this.labeler.setObjectLabel(e,o),this.builder.relabelReferences(r,o))}},serializeMontageObject:{value:function(t,e,i){var n,a,s=this.builder.createObjectLiteral();return this.setObjectType(e,i),i.setProperty("properties",s),this.builder.push(i),"function"==typeof e.serializeSelf?(n=(new r).initWithMalkerAndVisitorAndObject(t,this,e,i),a=e.serializeSelf(n)):(this.setObjectProperties(t,e),this.setObjectCustomUnits(t,e)),this.builder.pop(),0===s.getPropertyNames().length&&i.clearProperty("properties"),a}},setObjectType:{value:function(t,e){var n=i.getInfoForObject(t).isInstance,a=this.getObjectLocationId(t),r=this.builder.createString(a);n?e.setProperty("prototype",r):e.setProperty("object",r)}},getObjectModuleId:{value:function(t){var e=i.getInfoForObject(t);return this._require.identify(e.moduleId,e.require)}},getObjectLocationId:{value:function(t){var e,a=this.getObjectModuleId(t),r=i.getInfoForObject(t),s=r.objectName;return e=n.MontageSerializer.getDefaultObjectNameForModuleId(a),e===s?a:a+"["+s+"]"}},setObjectProperties:{value:function(t,e){var i,n;n=this.builder.top.getProperty("properties"),this.builder.push(n),"function"==typeof e.serializeProperties?(i=(new a).initWithMalkerAndVisitorAndObject(t,this,e),e.serializeProperties(i)):this.setSerializableObjectProperties(t,e),this.builder.pop()}},setSerializableObjectProperties:{value:function(t,e){for(var n,a,r=i.getSerializablePropertyNames(e),s=r.length,o=0;s>o;o++)a=r[o],n=i.getPropertyAttribute(e,a,"serializable"),this.setProperty(t,a,e[a],n)}},hackIsReferenceAllowedForValue:{value:function(t){return"object"==typeof t&&null!=t&&!("undefined"!=typeof Element&&Element.isElement(t))}},setProperty:{value:function(t,e,i,n){var a;if("reference"===n&&this.hackIsReferenceAllowedForValue(i)){a=this.labeler.getObjectLabel(i);var r=this.builder.createObjectReference(a);this.builder.top.setProperty(e,r)}else t.visit(i,e)}},setObjectCustomUnits:{value:function(t,e){for(var i in this._units)this.setObjectCustomUnit(t,e,i)}},setObjectCustomUnit:{value:function(t,e,i){var n,a,r=this._units[i];r&&(a=(new s).initWithMalkerAndVisitorAndObject(t,this,e),n=r(a,e),null!=n&&t.visit(n,i))}},getExternalObjects:{value:function(){for(var t,e={},i=this.builder.getExternalReferences(),n=0;t=i[n];n++)e[t]=this.labeler.getObjectByLabel(t);return e}},getExternalElements:{value:function(){return this._elements}}});e.MontageVisitor=c}});