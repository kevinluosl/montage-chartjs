function instantiateDocument(t,e,i){var n,a,r=new Template,s=t.documentElement.outerHTML,o=new DocumentPart,l=t.documentElement;return n=r.createHtmlDocumentWithHtml(s,t.location.href),r.initWithDocument(n,e).then(function(){return r.setBaseUrl(t.location.href),a=r._createTemplateObjects(i),o.initWithTemplateAndFragment(r),r._instantiateObjects(a,l).then(function(t){return o.objects=t,r._invokeDelegates(o),o})})}var Montage=require("./core").Montage,Deserializer=require("./serialization").Deserializer,DocumentPart=require("./document-part").DocumentPart,DocumentResources=require("./document-resources").DocumentResources,Serialization=require("./serialization/serialization").Serialization,MontageLabeler=require("./serialization/serializer/montage-labeler").MontageLabeler,Promise=require("./promise").Promise,URL=require("./mini-url"),logger=require("./logger").logger("template"),defaultEventManager=require("./event/event-manager").defaultEventManager,defaultApplication,Template=Montage.specialize({_SERIALIZATON_SCRIPT_TYPE:{value:"text/montage-serialization"},_ELEMENT_ID_ATTRIBUTE:{value:"data-montage-id"},PARAM_ATTRIBUTE:{value:"data-param"},_require:{value:null},_resources:{value:null},_baseUrl:{value:null},_instances:{value:null},_metadata:{value:null},_objectsString:{value:null},objectsString:{get:function(){return this._objectsString},set:function(t){this._objectsString=t,this._serialization&&this._serialization.initWithString(t),this.__deserializer=null}},__deserializer:{value:null},_deserializer:{get:function(){var t,e,i=this.__deserializer;if(!i){if(t=this._metadata){e=Object.create(null);for(var n in t)e[n]=t[n].require}i=(new Deserializer).init(this.objectsString,this._require,e),this.__deserializer=i}return i}},getDeserializer:{value:function(){return this._deserializer}},_serialization:{value:null},getSerialization:{value:function(){var t=this._serialization;return t||(t=this._serialization=new Serialization,t.initWithString(this.objectsString)),t}},_isDirty:{value:!1},isDirty:{get:function(){return this._isDirty},set:function(t){this._isDirty!==t&&(this._isDirty=t,this.clearTemplateFromElementContentsCache())}},refresher:{value:null},_document:{value:null},document:{get:function(){return this._isDirty&&this.refresh(),this._document},set:function(t){this._document=t}},constructor:{value:function Template(){this.super()}},initWithRequire:{value:function(t){return this._require=t,this.document=this.createHtmlDocumentWithHtml(""),this.objectsString="",this}},initWithDocument:{value:function(t,e){var i=this;return this._require=e,this.setDocument(t),this.getObjectsString(t).then(function(t){return i.objectsString=t,i})}},initWithHtml:{value:function(t,e){var i=this;return this._require=e,this.document=this.createHtmlDocumentWithHtml(t),this.getObjectsString(this.document).then(function(t){return i.objectsString=t,i})}},initWithObjectsAndDocumentFragment:{value:function(t,e,i){return this._require=i,this.document=this.createHtmlDocumentWithHtml(""),this.document.body.appendChild(this.document.importNode(e,!0)),this.setObjects(t),this}},initWithModuleId:{value:function(t,e){var i=this;return this._require=e,this.createHtmlDocumentWithModuleId(t,e).then(function(n){var a=e(t).directory;return i.document=n,i.setBaseUrl(a),i.getObjectsString(n).then(function(t){return i.objectsString=t,i})})}},clone:{value:function(){var t=new Template;return t._require=this._require,t._baseUrl=this._baseUrl,t.setDocument(this.document),t.objectsString=this.objectsString,t._instances=Object.clone(this._instances,1),t}},instantiate:{value:function(t){return this.instantiateWithInstances(null,t)}},instantiateWithInstances:{value:function(t,e){var i,n,a,r=this,s=new DocumentPart;return t=t||this._instances,i=this._createMarkupDocumentFragment(e),a=this._getParameters(i),s.initWithTemplateAndFragment(this,i),s.startActingAsTopComponent(),s.parameters=a,n=this._createTemplateObjects(t),this._instantiateObjects(n,i).then(function(i){var n;return s.objects=i,r._invokeDelegates(s,t),s.stopActingAsTopComponent(),n=r.getResources(),!n.resourcesLoaded()&&n.hasResources()&&n.loadResources(e).done(),s})}},_objectsInstantiationOptimized:{value:!1},_optimizeObjectsInstantiationPromise:{value:null},_optimizeObjectsInstantiation:{value:function(){var t,e=this;return this._objectsInstantiationOptimized?void 0:(this._optimizeObjectsInstantiationPromise||(t=this._deserializer.preloadModules(),t?this._optimizeObjectsInstantiationPromise=t.then(function(){e._objectsInstantiationOptimized=!0}):this._objectsInstantiationOptimized=!0),this._optimizeObjectsInstantiationPromise)}},setBaseUrl:{value:function(t){this._baseUrl=t}},getBaseUrl:{value:function(){return this._baseUrl}},getResources:{value:function(){var t=this._resources;return t||(t=this._resources=new TemplateResources,t.initWithTemplate(this)),t}},_createTemplateObjects:{value:function(t){var e=Object.create(t||null);return defaultApplication===void 0&&(defaultApplication=require("./application").application),e.application=defaultApplication,e.template=this,e}},_instantiateObjects:{value:function(t,e){var i,n=this._deserializer;return i=this._optimizeObjectsInstantiation(),i?i.then(function(){return n.deserialize(t,e)}):n.deserialize(t,e)}},_createMarkupDocumentFragment:{value:function(t){for(var e=t.createDocumentFragment(),i=this.document.body.childNodes,n=0,a=i.length;a>n;n++)e.appendChild(t.importNode(i[n],!0));return e}},getParameterName:{value:function(t){return t.getAttribute(this.PARAM_ATTRIBUTE)}},getParameters:{value:function(){return this._getParameters(this.document.body)}},_getParameters:{value:function(t){for(var e,i=t.querySelectorAll("*["+this.PARAM_ATTRIBUTE+"]"),n=i.length,a={},r=0;n>r;r++){e=i[r];var s=this.getParameterName(e);if(s in a)throw Error('The parameter "'+s+'" is'+" declared more than once in "+this.getBaseUrl()+".");a[s]=e}if("*"in a&&n>1)throw Error('The star "*" template parameter was declared when other parameters were also present in '+this.getBaseUrl()+": "+Object.keys(a)+".");return a}},hasParameters:{value:function(){return!!this.document.querySelector("*["+this.PARAM_ATTRIBUTE+"]")}},_invokeDelegates:{value:function(t,e){var i,n,a,r=t.objects,s=r.owner||e&&e.owner;for(var o in r)e&&o in e||(i=r[o],n=this._getObjectOwner(o,s),a=this._getObjectLabel(o),i&&("function"==typeof i._deserializedFromTemplate&&i._deserializedFromTemplate(n,a,t),"function"==typeof i.deserializedFromTemplate&&i.deserializedFromTemplate(n,a,t)));if(s){var l=this.getSerialization();l.isExternalObject("owner")||("function"==typeof s._templateDidLoad&&s._templateDidLoad(t),"function"==typeof s.templateDidLoad&&s.templateDidLoad(t))}}},setInstances:{value:function(t){this._instances=t}},getInstances:{value:function(){return this._instances}},setObjects:{value:function(t){this.objectsString=JSON.stringify(t,null,4)}},setObjectMetadata:{value:function(t,e,i,n){var a=this._metadata;a||(this._metadata=a=Object.create(null)),a[t]={require:e,label:i,owner:n},this.__deserializer=null}},getObjectMetadata:{value:function(t){var e=this._metadata;return e&&t in e?e[t]:{require:this._require,label:t}}},_getObjectOwner:{value:function(t,e){var i,n=this._metadata;return i=n&&t in n?n[t].owner:e}},_getObjectLabel:{value:function(t){var e,i=this._metadata;return e=i&&t in i?i[t].label:t}},setDocument:{value:function(t){var e=t.documentElement.innerHTML;this.document=this.createHtmlDocumentWithHtml(e,t.baseURI),this.clearTemplateFromElementContentsCache()}},getObjectsString:{value:function(t){var e;return e=this.getInlineObjectsString(t),null===e?this.getExternalObjectsString(t):Promise.resolve(e)}},getInlineObjectsString:{value:function(t){var e="script[type='"+this._SERIALIZATON_SCRIPT_TYPE+"']",i=t.querySelector(e);return i?i.textContent:null}},getExternalObjectsString:{value:function(t){var e,i,n,a=t.querySelector('link[rel="serialization"]');return a?(e=new XMLHttpRequest,i=a.getAttribute("href"),n=Promise.defer(),e.open("GET",i),e.addEventListener("load",function(){200==e.status?n.resolve(e.responseText):n.reject(Error("Unable to retrive '"+i+"', code status: "+e.status))},!1),e.addEventListener("error",function(t){n.reject(Error("Unable to retrive '"+i+"' with error: "+t.error+"."))},!1),e.send(),n.promise):Promise.resolve(null)}},createHtmlDocumentWithHtml:{value:function(t,e){var i=document.implementation.createHTMLDocument("");return i.documentElement.innerHTML=t,this.normalizeRelativeUrls(i,e),i}},createHtmlDocumentWithModuleId:{value:function(t,e){var i=this;return"function"!=typeof e?Promise.reject(Error("Missing 'require' function to load module '"+t+"'.")):e.async(t).then(function(t){return i.createHtmlDocumentWithHtml(t.content,t.directory)})}},_removeObjects:{value:function(t){var e="script[type='"+this._SERIALIZATON_SCRIPT_TYPE+"'], link[rel='serialization']";Array.prototype.forEach.call(t.querySelectorAll(e),function(t){t.parentNode.removeChild(t)})}},_addObjects:{value:function(t,e){if(e){var i=t.createElement("script");i.setAttribute("type",this._SERIALIZATON_SCRIPT_TYPE),i.textContent=JSON.stringify(JSON.parse(e),null,4),t.head.appendChild(i)}}},_templateFromElementContentsCache:{value:null},clearTemplateFromElementContentsCache:{value:function(){this._templateFromElementContentsCache=null}},createTemplateFromElementContents:{value:function(t){var e,i,n,a=this._templateFromElementContentsCache;return a||(a=Object.create(null),this._templateFromElementContentsCache=a),t in a?Object.create(a[t]):(e=this.getElementById(t),n=this.document.createRange(),n.selectNodeContents(e),i=this.createTemplateFromRange(n),a[t]=i,Object.create(i))}},createTemplateFromElement:{value:function(t){var e,i;return e=this.getElementById(t),i=this.document.createRange(),i.selectNode(e),this.createTemplateFromRange(i)}},createTemplateFromRange:{value:function(t){var e,i,n,a,r,s=new Serialization;return e=t.cloneContents(),i=this._getChildrenElementIds(e),s.initWithString(this.objectsString),n=s.getSerializationLabelsWithElements(i),r=s.extractSerialization(n,["owner"]),a=new Template,a.initWithObjectsAndDocumentFragment(null,e,this._require),a.objectsString=r.getSerializationString(),a._resources=this.getResources(),a}},_createSerializationWithElementIds:{value:function(t){var e,i,n=new Serialization;return n.initWithString(this.objectsString),e=n.getSerializationLabelsWithElements(t),i=n.extractSerialization(e,["owner"])}},expandParameters:{value:function(t){var e,i,n,a,r,s,o,l=[],c={},h=this.getSerialization(),u={};e=this.getParameters();for(var d in e)if(a=e[d],r=t.getTemplateArgumentElement(d),l.push.apply(l,this._getElementIds(r)),i=this.replaceNode(r,a))for(var p in i)c[p]=i[p];return u.elementIds=l,u.elementIdsCollisions=c,s=t.getTemplateArgumentSerialization(l),s.renameElementReferences(c),o=function(e){return e.indexOf(":")>0?t.resolveTemplateArgumentTemplateProperty(e):void 0},n=h.mergeSerialization(s,{willMergeObjectWithLabel:o}),this.objectsString=h.getSerializationString(),u.labels=s.getSerializationLabels(),u.labelsCollisions=n,u}},_resolveElementIdCollisions:{value:function(t,e){var i,n,a,r,s;e=e||new MontageLabeler,a=this.getElementIds();for(var o,l=0;o=a[l];l++)e.addLabel(o);n=this._getElements(t);for(var o in n)this.getElementById(o)&&(r=n[o],s=e.generateLabel(e.getLabelBaseName(o)),this.setElementId(r,s),i||(i=Object.create(null)),i[o]=s);return i}},replaceNode:{value:function(t,e,i){var n;return n=this._resolveElementIdCollisions(t,i),this.normalizeRelativeUrls(t,this.getBaseUrl()),e.parentNode.replaceChild(t,e),n}},insertNodeBefore:{value:function(t,e,i){var n;return n=this._resolveElementIdCollisions(t,i),this.normalizeRelativeUrls(t,this.getBaseUrl()),e.parentNode.insertBefore(t,e),n}},appendNode:{value:function(t,e,i){var n;return n=this._resolveElementIdCollisions(t,i),this.normalizeRelativeUrls(t,this.getBaseUrl()),e.appendChild(t),n}},getElementId:{value:function(t){return t.getAttribute?t.getAttribute(this._ELEMENT_ID_ATTRIBUTE):void 0}},setElementId:{value:function(t,e){t.setAttribute(this._ELEMENT_ID_ATTRIBUTE,e)}},getElementIds:{value:function(){return this._getElementIds(this.document.body)}},_getElements:{value:function(t){var e,i,n="*["+this._ELEMENT_ID_ATTRIBUTE+"]",a={};e=t.querySelectorAll(n);for(var r,s=0;r=e[s];s++)i=this.getElementId(r),a[i]=r;return i=this.getElementId(t),i&&(a[i]=t),a}},_getChildrenElementIds:{value:function(t){var e,i="*["+this._ELEMENT_ID_ATTRIBUTE+"]",n=[];e=t.querySelectorAll(i);for(var a,r=0;a=e[r];r++)n.push(this.getElementId(a));return n}},_getElementIds:{value:function(t){var e,i=this._getChildrenElementIds(t);return e=this.getElementId(t),e&&i.push(e),i}},getElementById:{value:function(t){var e="*["+this._ELEMENT_ID_ATTRIBUTE+"='"+t+"']";return this.document.querySelector(e)}},html:{get:function(){var t=this.document;return this._removeObjects(t),this._addObjects(t,this.objectsString),this._getDoctypeString(t.doctype)+"\n"+t.documentElement.outerHTML}},_getDoctypeString:{value:function(t){return"<!DOCTYPE "+t.name+(t.publicId?' PUBLIC "'+t.publicId+'"':"")+(!t.publicId&&t.systemId?" SYSTEM":"")+(t.systemId?' "'+t.systemId+'"':"")+">"}},normalizeRelativeUrls:{value:function(t,e){if("string"==typeof e&&""!==e&&"about:blank"!==e)for(var i="http://www.w3.org/1999/xlink",n=/^[\w\-]+:|^\//,a=-1!==Template._NORMALIZED_TAG_NAMES.indexOf(t.tagName)?[t]:t.querySelectorAll(Template._NORMALIZED_TAG_NAMES_SELECTOR),r=0,s=a.length;s>r;r++){var o,l=a[r];"image"===l.tagName?(o=l.getAttributeNS(i,"href"),n.test(o)||l.setAttributeNS(i,"href",URL.resolve(e,o))):l.hasAttribute("src")?(o=l.getAttribute("src"),""===o||n.test(o)||l.setAttribute("src",URL.resolve(e,o))):l.hasAttribute("href")&&(o=l.getAttribute("href"),""===o||n.test(o)||l.setAttribute("href",URL.resolve(e,o)))}}},replaceContentsWithTemplate:{value:function(t){this._require=t._require,this._baseUrl=t._baseUrl,this._document=t._document,this.objectsString=t.objectsString,this._instances=t._instances,this._templateFromElementContentsCache=t._templateFromElementContentsCache,this._metadata=t._metadata}},refresh:{value:function(){this.isDirty&&(this.refresher&&"function"==typeof this.refresher.refreshTemplate?(this.refresher.refreshTemplate(this),this.isDirty=!1):console.warn("Not able to refresh without a refresher.refreshTemplate."))}}},{_templateCache:{value:{moduleId:Object.create(null)}},_getTemplateCacheKey:{value:function(t,e){return t=e.resolve(t),e.location+"#"+t}},getTemplateWithModuleId:{value:function(t,e){var i,n;return i=this._getTemplateCacheKey(t,e),n=this._templateCache.moduleId[i],n||(n=(new Template).initWithModuleId(t,e),this._templateCache.moduleId[i]=n),n}},_NORMALIZED_TAG_NAMES:{value:["IMG","image","IFRAME","link","script"]},__NORMALIZED_TAG_NAMES_SELECTOR:{value:null},_NORMALIZED_TAG_NAMES_SELECTOR:{get:function(){return this.__NORMALIZED_TAG_NAMES_SELECTOR||(this.__NORMALIZED_TAG_NAMES_SELECTOR=this._NORMALIZED_TAG_NAMES.join(",")),this.__NORMALIZED_TAG_NAMES_SELECTOR}}}),TemplateResources=Montage.specialize({_resources:{value:null},_resourcesLoaded:{value:!1},template:{value:null},rootUrl:{value:""},constructor:{value:function TemplateResources(){this._resources=Object.create(null)}},initWithTemplate:{value:function(t){this.template=t}},hasResources:{value:function(){return this.getStyles().length>0||this.getScripts().length>0}},resourcesLoaded:{value:function(){return this._resourcesLoaded}},loadResources:{value:function(t){return this._resourcesLoaded=!0,Promise.all([this.loadScripts(t),this.loadStyles(t)])}},getScripts:{value:function(){var t,e,i,n=this._resources.scripts;if(!n){e=this.template,n=this._resources.scripts=[],i=e.document.querySelectorAll("script");for(var a=0,r=i.length;r>a;a++)t=i[a],t.type!==this.template._SERIALIZATON_SCRIPT_TYPE&&n.push(t)}return n}},loadScripts:{value:function(t){var e,i=[];e=this.getScripts();for(var n=0,a=e.length;a>n;n++)i.push(this.loadScript(e[n],t));return Promise.all(i)}},loadScript:{value:function(t,e){var i,n;return i=DocumentResources.getInstanceForDocument(e),n=this._cloneScriptElement(t,e),i.addScript(n)}},_cloneScriptElement:{value:function(t,e){for(var i,n=e.createElement("script"),a=t.attributes,r=0,s=a.length;s>r;r++)i=a[r],n.setAttribute(i.name,i.value);return n.textContent=t.textContent,n}},getStyles:{value:function(){var t,e,i,n=this._resources.styles;return n||(i='link[rel="stylesheet"], style',t=this.template,e=t.document.querySelectorAll(i),n=Array.prototype.slice.call(e,0),this._resources.styles=n),n}},loadStyles:{value:function(t){var e,i=[];e=this.getStyles();for(var n=0,a=e.length;a>n;n++)i.push(this.loadStyle(e[n],t));return Promise.all(i)}},loadStyle:{value:function(t,e){var i,n;return i=t.getAttribute("href"),i?(n=DocumentResources.getInstanceForDocument(e),n.preloadResource(i)):Promise.resolve()}},createStylesForDocument:{value:function(t){for(var e,i,n=this.getStyles(),a=[],r=0;i=n[r];r++)e=t.importNode(i,!0),a.push(e);return a}}}),TemplateArgumentProvider=Montage.specialize({getTemplateArgumentElement:{value:function(){}},getTemplateArgumentSerialization:{value:function(){}},resolveTemplateArgumentTemplateProperty:{value:function(){}}});exports.Template=Template,exports.TemplateArgumentProvider=TemplateArgumentProvider,exports.TemplateResources=TemplateResources,exports.instantiateDocument=instantiateDocument;