montageDefine("b14c684","core/undo-manager",{dependencies:["./core","./target","./promise","collections/map","collections/list"],factory:function(t,e){var i=t("./core").Montage,n=t("./target").Target,a=t("./promise").Promise,r=t("collections/map"),s=t("collections/list"),o=0,l=1,c=e.UndoManager=n.specialize({_operationQueue:{value:null},_promiseOperationMap:{value:null},constructor:{value:function c(){this._operationQueue=[],this._promiseOperationMap=new r,this._undoStack=new s,this._redoStack=new s,this._batchStack=new s,this.defineBinding("undoLabel",{"<-":"undoEntry.label || _promiseOperationMap.get(_undoStack.head.prev.value).label"}),this.defineBinding("undoCount",{"<-":"length",source:this._undoStack}),this.defineBinding("canUndo",{"<-":"!!length",source:this._undoStack}),this.defineBinding("isUndoing",{"<-":"!!undoEntry"}),this.defineBinding("redoLabel",{"<-":"redoEntry.label || _promiseOperationMap.get(_redoStack.head.prev.value).label"}),this.defineBinding("redoCount",{"<-":"length",source:this._redoStack}),this.defineBinding("canRedo",{"<-":"!!length",source:this._redoStack}),this.defineBinding("isRedoing",{"<-":"!!redoEntry"}),this.defineBinding("currentBatch",{"<-":"_batchStack.head.prev.value"})}},_maxUndoCount:{enumerable:!1,value:null},maxUndoCount:{get:function(){return this._maxUndoCount},set:function(t){t!==this._maxUndoCount&&(this._maxUndoCount=t,null!=this._maxUndoCount&&this._trimStacks())}},_undoStack:{value:null},undoCount:{value:0},_redoStack:{value:null},redoCount:{value:0},_trimStacks:{enumerable:!1,value:function(){var t=this._undoStack.length-this._maxUndoCount,e=this._redoStack.length-this._maxUndoCount;t>0&&this._undoStack.splice(0,t),e>0&&this._redoStack.splice(0,e)}},registrationEnabled:{value:!0},_batchStack:{value:null},currentBatch:{value:null},openBatch:{value:function(t){var e={};e.label=t,e.promisedOperations=[],this._batchStack.push(e)}},closeBatch:{value:function(){if(!this.currentBatch)throw Error("No batch operation to close");var t,e=this.currentBatch.label,i=this.currentBatch.promisedOperations,n=[],r=function(){t=Object.create(null),this.openBatch(e);var i=n.reduceRight(function(e,i){return e.then(function(){return o._resolveUndoEntry(t,i),t.undoFunction.apply(t.context,t.args)})},a.resolve());return i.finally(function(){o.closeBatch()})},s=i.reduce(function(t,e){return t.then(function(t){return t&&n.push(t),e})},a.resolve());this._batchStack.pop();var o=this;this.register(e,s.then(function(t){return n.push(t),[r,o]}))}},register:{value:function(t,e){var i,n=this;if(!a.isPromiseAlike(e))throw Error("UndoManager expected a promise");if(0===this._maxUndoCount||!this.registrationEnabled)return a.resolve(null);if(this.currentBatch)this.currentBatch.promisedOperations.push(e),i=e;else{var r={label:t};this._promiseOperationMap.set(e,r),this.isUndoing?(r.label=this.undoLabel,this._redoStack.length===this._maxUndoCount&&this._redoStack.shift(),this._redoStack.push(e)):(this._undoStack.length===this._maxUndoCount&&this._undoStack.shift(),this._undoStack.push(e),!this.isRedoing&&this._redoStack.length>0&&this.clearRedo()),this.isUndoing||this.isRedoing||this.dispatchEventNamed("operationRegistered",!0,!1),i=e.then(function(t){return n._resolveUndoEntry(r,t),r}).then(function(){return n._flushOperationQueue()})}return i}},_resolveUndoEntry:{value:function(t,e){var i,n,a,r;if("string"==typeof e[0]?(i=e[0],n=e[1],a=e[2],r=3):(n=e[0],a=e[1],r=2),i&&(t.label=i),"function"!=typeof n)throw Error("Need undo function for '"+t.label+"' operation, not: "+n);t.undoFunction=n,t.context=a,t.args=e.slice(r)}},_flushOperationQueue:{value:function(){var t,e=this._operationQueue,i=e.length,n=[],r=this._promiseOperationMap,s=this;if(0!==i){var o=!1,l=e.reduce(function(t,e){var i=s._promiseOperationMap.get(e);return o||"function"!=typeof i.undoFunction?(o=!0,t):(n.push(e),t.then(function(){return s._performOperation(i)}).then(function(){r.delete(e)}))},a.resolve());return t=n.length,t>0&&e.splice(0,t),l}}},_performOperation:{value:function(t){var e=this;t.operationType===o?this.undoEntry=t:this.redoEntry=t;var i;try{i=t.undoFunction.apply(t.context,t.args)}catch(n){throw t.deferredOperation.reject(n),n}return a.isPromiseAlike(i)?i.finally(function(){e.undoEntry=null,e.redoEntry=null}).then(function(e){t.deferredOperation.resolve(e)},function(e){t.deferredOperation.reject(e)}):(this.undoEntry=null,this.redoEntry=null,t.deferredOperation.resolve(i),void 0)}},clearUndo:{value:function(){this._undoStack.splice(0,this._undoStack.length)}},clearRedo:{value:function(){this._redoStack.splice(0,this._redoStack.length)}},isUndoing:{value:!1},isRedoing:{value:!1},undoEntry:{enumerable:!1,value:null},redoEntry:{enumerable:!1,value:null},undo:{value:function(){if(0===this.undoCount)return a.resolve(null);var t=this;return this._scheduleOperation(this._undoStack.pop(),o).then(function(e){return t.dispatchEventNamed("undo",!0,!1,e),e})}},redo:{value:function(){if(0===this.redoCount)return a.resolve(null);var t=this;return this._scheduleOperation(this._redoStack.pop(),l).then(function(e){return t.dispatchEventNamed("redo",!0,!1),e})}},_scheduleOperation:{value:function(t,e){var i=a.defer(),n=this._promiseOperationMap.get(t);return n.deferredOperation=i,n.operationType=e,this._operationQueue.push(t),this._flushOperationQueue().thenResolve(i.promise)}},canUndo:{value:null},canRedo:{value:null},undoLabel:{value:null},redoLabel:{value:null}}),h=null;i.defineProperty(e,"defaultUndoManager",{get:function(){return h||(h=new c),h}})}});