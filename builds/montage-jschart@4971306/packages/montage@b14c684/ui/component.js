function loggerToString(t){return t?t._montage_metadata.objectName+":"+Object.hash(t)+" id: "+t.identifier:"NIL"}var Montage=require("../core/core").Montage,Target=require("../core/target").Target,Template=require("../core/template").Template,DocumentResources=require("../core/document-resources").DocumentResources,Gate=require("../core/gate").Gate,Promise=require("../core/promise").Promise,logger=require("../core/logger").logger("component"),drawPerformanceLogger=require("../core/logger").logger("Drawing performance").color.green(),drawListLogger=require("../core/logger").logger("drawing list").color.blue(),needsDrawLogger=require("../core/logger").logger("drawing needsDraw").color.violet(),drawLogger=require("../core/logger").logger("drawing").color.blue(),defaultEventManager=require("../core/event/event-manager").defaultEventManager,Set=require("collections/set"),Alias=require("../core/serialization/alias").Alias,ATTR_LE_COMPONENT="data-montage-le-component",ATTR_LE_ARG="data-montage-le-arg",ATTR_LE_ARG_BEGIN="data-montage-le-arg-begin",ATTR_LE_ARG_END="data-montage-le-arg-end",Component=exports.Component=Target.specialize({DOM_ARG_ATTRIBUTE:{value:"data-arg"},constructor:{value:function Component(){this.super(),this._isComponentExpanded=!1,this._isTemplateLoaded=!1,this._isTemplateInstantiated=!1,this._isComponentTreeLoaded=!1}},delegate:{value:null},templateObjects:{serializable:!1,value:null},_nextTarget:{value:null},nextTarget:{get:function(){return this._nextTarget||this.parentComponent},set:function(t){this._nextTarget=t}},_ownerDocumentPart:{value:null},_templateDocumentPart:{value:null},_domArguments:{value:null},_domArgumentNames:{value:null},_dispatchActionEvent:{value:function(){this.dispatchEvent(this.createActionEvent())},enumerable:!1},createActionEvent:{value:function(){var t=document.createEvent("CustomEvent");return t.initCustomEvent("action",!0,!0,null),t}},canDrawGate:{get:function(){return this._canDrawGate||(this._canDrawGate=(new Gate).initWithDelegate(this),this._canDrawGate.setField("componentTreeLoaded",!1)),this._canDrawGate},enumerable:!1},_blockDrawGate:{value:null},blockDrawGate:{enumerable:!1,get:function(){return this._blockDrawGate||(this._blockDrawGate=(new Gate).initWithDelegate(this),this._blockDrawGate.setField("element",!1),this._blockDrawGate.setField("drawRequested",!1)),this._blockDrawGate}},_firstDraw:{enumerable:!1,value:!0},_completedFirstDraw:{enumerable:!1,value:!1},originalElement:{value:null},_element:{enumerable:!1,value:null},element:{get:function(){return this._element},set:function(t){if(null==t)return console.warn("Tried to set element of ",this," to ",t),void 0;if(t.component&&t.component!==this)throw Error("Element "+t+" is already assigned to another component: "+t.component);if(window._montage_le_flag&&t.setAttribute(ATTR_LE_COMPONENT,Montage.getInfoForObject(this).moduleId),this.isDeserializing)this.eventManager.registerEventHandlerForElement(this,t),this._isTemplateInstantiated?this._templateElement||(this._templateElement=t):(this._element=t,!this.blockDrawGate.value&&this._element&&this.blockDrawGate.setField("element",!0));else{if(!this._firstDraw)return console.error("Cannot change element of ",this," after it has been set"),void 0;this.eventManager.registerEventHandlerForElement(this,t),this._element=t,!this.blockDrawGate.value&&this._element&&this.blockDrawGate.setField("element",!0)}this._initializeClassListFromElement(t)}},getElementId:{value:function(){var t=this._element;return t?t.getAttribute("data-montage-id"):void 0}},_initDomArguments:{value:function(){var t,e,i,n={},a=this.element;t=a.querySelectorAll("*["+this.DOM_ARG_ATTRIBUTE+"]");t:for(var r,s=0;r=t[s];s++){for(i=r;(i=i.parentNode)!==a;)if(i.component)continue t;this._findAndDetachComponents(r),r.parentNode.removeChild(r),e=r.getAttribute(this.DOM_ARG_ATTRIBUTE),r.removeAttribute(this.DOM_ARG_ATTRIBUTE),n[e]=r}this._domArguments=n}},getDomArgumentNames:{value:function(){return this._domArgumentNames||(this._domArgumentNames=Object.keys(this._domArguments)),this._domArgumentNames}},extractDomArgument:{value:function(t){var e;return e=this._domArguments[t],this._domArguments[t]=null,e}},_getTemplateDomArgument:{value:function(t){var e,i,n,a,r,s,o=this._ownerDocumentPart.template;n=o.getElementById(this.getElementId()),e=n.querySelectorAll("*["+this.DOM_ARG_ATTRIBUTE+"='"+t+"']");t:for(var l,c=0;l=e[c];c++){for(i=l;(i=i.parentNode)!==n;)if(a=o.getElementId(i),a&&(r=o.getSerialization(),s=r.getSerializationLabelsWithElements(a),s.length>0))continue t;return l}}},getTemplateArgumentElement:{value:function(t){var e,i,n,a=this._ownerDocumentPart.template;if(window._montage_le_flag)var r=this.ownerComponent._montage_metadata.moduleId,s=this._montage_metadata.label;return"*"===t?(e=a.getElementById(this.getElementId()),i=a.document.createRange(),i.selectNodeContents(e),n=i.cloneContents(),window._montage_le_flag&&e.children.length>0&&this._leTagStarArgument(r,s,n)):(n=this._getTemplateDomArgument(t).cloneNode(!0),n.removeAttribute(this.DOM_ARG_ATTRIBUTE),window._montage_le_flag&&this._leTagNamedArgument(r,s,n,t)),n}},getTemplateArgumentSerialization:{value:function(t){var e=this._ownerDocumentPart.template;return e._createSerializationWithElementIds(t)}},resolveTemplateArgumentTemplateProperty:{value:function(t){var e,i,n,a,r=t.indexOf(":"),s=t.slice(0,r),o=t.slice(r),l=this._templateDocumentPart;if(Montage.getInfoForObject(this).label===s)return l&&(n=l.objects[o]),n instanceof Alias&&(i=l.objects[n.componentLabel],e=n.value.slice(1),a=i.resolveTemplateArgumentTemplateProperty(e),a||(a=e)),a}},setElementWithParentComponent:{value:function(t,e){this._alternateParentComponent=e,this.element!==t&&(this.element=t)}},application:{enumerable:!1,get:function(){return require("../core/application").application}},eventManager:{enumerable:!1,get:function(){return defaultEventManager}},rootComponent:{enumerable:!1,get:function(){return rootComponent}},elementControllerFromEvent:{enumerable:!1,value:function(t,e){return e}},_alternateParentComponent:{value:null},__parentComponent:{value:null},_parentComponent:{set:function(t){this.__parentComponent=t,this.dispatchOwnPropertyChange("parentComponent",t)},get:function(){return this.__parentComponent}},parentComponent:{enumerable:!1,get:function(){return this._parentComponent}},findParentComponent:{value:function(){var t,e=this.element,i=this.eventManager;if(e){for(;null!=(t=e.parentNode)&&null==i.eventHandlerForElement(t);)e=t;return t?i.eventHandlerForElement(t):this._alternateParentComponent}}},querySelectorComponent:{value:function(t){if("string"!=typeof t)throw"querySelectorComponent: Selector needs to be a string.";var e=t.match(/^\s*(?:@([^>\s]+))?(?:\s*(>)?\s*@([^>\s]+)(.*))?$/);if(!e)throw'querySelectorComponent: Syntax error "'+t+'"';var i,n,a,r=this.childComponents,s=e[1],o=(e[2]||" ",e[3]),l=e[4];if(s)for(l=o?"@"+o+l:"",n=0,a;a=r[n];n++){if(s===Montage.getInfoForObject(a).label)return l?a.querySelectorComponent(l):a;if(i=a.querySelectorComponent(t))return i}else for(n=0,a;a=r[n];n++)if(o===Montage.getInfoForObject(a).label)return l?a.querySelectorComponent(l):a;return null}},querySelectorAllComponent:{value:function(t,e){if("string"!=typeof t)throw"querySelectorComponent: Selector needs to be a string.";var i=t.match(/^\s*(?:@([^>\s]+))?(?:\s*(>)?\s*@([^>\s]+)(.*))?$/);if(!i)throw'querySelectorComponent: Syntax error "'+t+'"';var n,a,r=this.childComponents,s=i[1],o=(i[2]||" ",i[3]),l=i[4],c=[];if(s)for(l=o?"@"+o+l:"",n=0,a;a=r[n];n++)s!==Montage.getInfoForObject(a).label||e&&e!==a.ownerComponent?c=c.concat(a.querySelectorAllComponent(t,e)):l?c=c.concat(a.querySelectorAllComponent(l)):c.push(a);else for(n=0,a;a=r[n];n++)o!==Montage.getInfoForObject(a).label||e&&e!==a.ownerComponent||(l?c=c.concat(a.querySelectorAllComponent(l,e)):c.push(a));return c}},template:{enumerable:!1,value:null},hasTemplate:{enumerable:!1,value:!0},_templateModuleId:{serializable:!1,value:null},_template:{value:null},_treeLevel:{value:0},_addChildComponent:{value:function(t){return this.addChildComponent(t)}},addChildComponent:{value:function(t){-1===this.childComponents.indexOf(t)&&(this.childComponents.push(t),t._prepareForEnterDocument(),t._parentComponent=this,t.needsDraw&&!this.rootComponent.isComponentWaitingNeedsDraw(t)&&t._addToParentsDrawList())}},attachToParentComponent:{value:function(){this.detachFromParentComponent(),this._parentComponent=null;var t,e,i=this.findParentComponent();if(i){t=i.childComponents;for(var n=0;e=t[n];n++){var a=e.findParentComponent();a===this&&(i.removeChildComponent(e),a.addChildComponent(e))}i.addChildComponent(this)}}},detachFromParentComponent:{value:function(){var t=this.parentComponent;t&&t.removeChildComponent(this)}},removeChildComponent:{value:function(t){var e=this.childComponents,i=e.indexOf(t);i>-1&&(t._exitDocument(),e.splice(i,1),t._parentComponent=null,t._alternateParentComponent=null,t._addedToDrawList&&(t._addedToDrawList=!1,i=this._drawList.indexOf(t),this._drawList.splice(i,1)),this.rootComponent.removeFromCannotDrawList(t))}},childComponents:{enumerable:!1,distinct:!0,value:[]},_needsEnterDocument:{value:!1},_inDocument:{value:!1},__exitDocument:{value:function(){this._inDocument&&"function"==typeof this.exitDocument&&(this.exitDocument(),this._inDocument=!1)}},_exitDocument:{value:function(){var t;this._needsEnterDocument?this._needsEnterDocument=!1:(t=function(e){for(var i,n=e.childComponents,a=0;i=n[a];a++)i._isComponentExpanded&&t(i);e._inDocument&&e.__exitDocument()},t(this))}},exitDocument:{value:function(){this.isActiveTarget&&(defaultEventManager.activeTarget=this.nextTarget)}},_prepareForEnterDocument:{value:function(){this._firstDraw?this._needsEnterDocument=!0:(this.needsDraw=!0,this.traverseComponentTree(function(t){return t._needsEnterDocument?!1:(t._needsEnterDocument=!0,t.needsDraw=!0,void 0)}))}},ownerComponent:{enumerable:!1,value:null},components:{enumerable:!1,value:{}},_isComponentExpanded:{enumerable:!1,value:null},_isTemplateLoaded:{enumerable:!1,value:null},_isTemplateInstantiated:{enumerable:!1,value:null},cleanupDeletedComponentTree:{value:function(t){t&&this.cancelBindings(),this.needsDraw=!1,this.traverseComponentTree(function(e){t&&e.cancelBindings(),e.needsDraw=!1})}},_newDomContent:{enumerable:!1,value:null},domContent:{serializable:!1,get:function(){return this._element?Array.prototype.slice.call(this._element.childNodes,0):null},set:function(t){var e,i,n,a=[];for(this._newDomContent=t,this.needsDraw=!0,null===this._newDomContent&&(this._shouldClearDomContentOnNextDraw=!0),"function"==typeof this.contentWillChange&&this.contentWillChange(t),e=this.childComponents,i=0,n;n=e[i];i++)n.detachFromParentComponent();if(t instanceof Element)this._findAndDetachComponents(t,a);else if(t&&t[0])for(i=0;t.length>i;i++)this._findAndDetachComponents(t[i],a);for(i=0,n;n=a[i];i++)this.addChildComponent(n)}},_shouldClearDomContentOnNextDraw:{value:!1},_findAndDetachComponents:{value:function(t,e){var i,n=t.component;if(e||(e=[]),n)n.detachFromParentComponent(),e.push(n);else{i=t.children||t.childNodes;for(var a,r=0;a=i[r];r++)this._findAndDetachComponents(a,e)}return e}},clonesChildComponents:{writable:!1,value:!1},_innerTemplate:{value:null},innerTemplate:{serializable:!1,get:function(){var t,e,i,n,a,r,s,o=this._innerTemplate;if(!o&&(t=this._ownerDocumentPart)){e=t.template,i=this.getElementId(),o=e.createTemplateFromElementContents(i),n=o.getSerialization(),a=n.getExternalObjectLabels(),r=t.objects,s=Object.create(null);for(var l,c=0;l=a[c];c++)s[l]=r[l];o.setInstances(s),this._innerTemplate=o}return o},set:function(t){this._innerTemplate=t}},canDraw:{value:function(){return this._canDraw}},_canDraw:{get:function(){return!this._canDrawGate||this._canDrawGate.value},set:function(t){rootComponent.componentCanDraw(this,t)},enumerable:!1},_prepareCanDraw:{enumerable:!1,value:function(){this._isComponentTreeLoaded||this.loadComponentTree().done()}},_blocksOwnerComponentDraw:{value:!1},_updateOwnerCanDrawGate:{value:function(){this._blocksOwnerComponentDraw&&this.ownerComponent&&this.ownerComponent.canDrawGate.setField(this.uuid,this.canDrawGate.value)}},_isComponentTreeLoaded:{value:null},shouldLoadComponentTree:{value:!0},_loadComponentTreeDeferred:{value:null},loadComponentTree:{value:function(){var t=this,e=this.canDrawGate,i=this._loadComponentTreeDeferred;return i||(i=Promise.defer(),this._loadComponentTreeDeferred=i,e.setField("componentTreeLoaded",!1),(this.needsDraw||this.hasTemplate)&&(this._canDraw=!1),this.expandComponent().then(function(){if(t.hasTemplate||t.shouldLoadComponentTree){for(var e,i=[],n=t.childComponents,a=0;e=n[a];a++)i.push(e.loadComponentTree());return Promise.all(i)}}).then(function(){t._isComponentTreeLoaded=!0,t._needsEnterDocument&&(t.needsDraw=!0),e.setField("componentTreeLoaded",!0),i.resolve()},i.reject).done()),i.promise}},traverseComponentTree:{value:function(t,e){function i(){var i,a,r=n.childComponents;if(t&&t(n)===!1)return e&&e(),void 0;if(0===(a=r.length))return e&&e(),void 0;for(var s=function(){0===--a&&e&&e()},o=0;i=r[o];o++)i.traverseComponentTree(t,s)}var n=this;this._isComponentExpanded?i():e&&e()}},_expandComponentDeferred:{value:null},expandComponent:{value:function(){var t=this,e=this._expandComponentDeferred;return e||(e=Promise.defer(),this._expandComponentDeferred=e,this.hasTemplate?this._instantiateTemplate().then(function(){t._isComponentExpanded=!0,t._addTemplateStyles(),t.needsDraw=!0,e.resolve()},e.reject):(this._isComponentExpanded=!0,e.resolve())),e.promise}},_templateObjectDescriptor:{value:{enumerable:!0,configurable:!0}},_setupTemplateObjects:{value:function(t){this.templateObjects=Object.create(null),this._addTemplateObjects(t)}},_addTemplateObjects:{value:function(t){var e=this._templateObjectDescriptor,i=this.templateObjects;for(var n in t){var a=t[n];"object"==typeof a&&null!=a&&(Component.prototype.isPrototypeOf(a)&&a!==this&&a.parentComponent!==this?(e.get=this._makeTemplateObjectGetter(this,n,a),Object.defineProperty(i,n,e)):i[n]=a)}}},_makeTemplateObjectGetter:{value:function(t,e,i){var n,a,r,s="@"+e;return function(){if(n)return t.querySelectorAllComponent(s,t);if(a=t.querySelectorAllComponent(s,t),1===a.length)for(r=a[0];r=r.parentComponent;){if(r===t)return Object.defineProperty(this,e,{value:a[0]}),a[0];if(r.clonesChildComponents)break}else if(0===a.length)return i;return n=!0,a}}},_instantiateTemplate:{value:function(){var t=this;return this._loadTemplate().then(function(e){if(!t._element)return console.error("Cannot instantiate template without an element.",t),Promise.reject(Error("Cannot instantiate template without an element.",t));var i=t.templateObjects,n=t._element.ownerDocument;return i||(i=Object.create(null)),i.owner=t,t._isTemplateInstantiated=!0,e.instantiateWithInstances(i,n).then(function(e){e.parentDocumentPart=t._ownerDocumentPart,t._templateDocumentPart=e,e.fragment=null}).fail(function(t){var i=t.stack||t;throw console.error("Error in",e.getBaseUrl()+":",i),t})})}},_templateDidLoad:{value:function(t){this._setupTemplateObjects(t.objects)}},_loadTemplatePromise:{value:null},_loadTemplate:{value:function(){var t,e=this,i=this._loadTemplatePromise;return i||(t=Montage.getInfoForObject(this),i=this._loadTemplatePromise=Template.getTemplateWithModuleId(this.templateModuleId,t.require).then(function(t){return e._template=t,e._isTemplateLoaded=!0,t})),i}},templateModuleId:{get:function(){return this._templateModuleId||this._getDefaultTemplateModuleId()}},_getDefaultTemplateModuleId:{value:function(){var t,e,i,n;return n=Montage.getInfoForObject(this),i=n.moduleId,e=i.lastIndexOf("/"),t=i+"/"+i.slice(-1===e?0:e+1,-5)+".html"}},deserializedFromSerialization:{value:function(){this.attachToParentComponent()}},_deserializedFromTemplate:{value:function(t,e,i){Montage.getInfoForObject(this).label=e,this._ownerDocumentPart=i,this.hasOwnProperty("identifier")||(this.identifier=e),this.ownerComponent||(this.ownerComponent=Component.prototype.isPrototypeOf(t)?t:this.rootComponent,this._updateOwnerCanDrawGate()),this._needsDrawInDeserialization&&(this.needsDraw=!0)}},blueprintModuleId:{serializable:!1,enumerable:!1,get:function(){var t=Montage.getInfoForObject(this),e=t&&!t.isInstance?this:Object.getPrototypeOf(this);if(!Object.getOwnPropertyDescriptor(e,"_blueprintModuleId")||!e._blueprintModuleId){t=Montage.getInfoForObject(e);var i=t.moduleId,n=i.lastIndexOf("/"),a=i.lastIndexOf(".");n=-1===n?0:n+1,a=-1===a?i.length:a,a=n>a?i.length:a;var r;r=i.length>a&&".reel"===i.slice(a,i.length)?i+"/"+i.slice(n,a)+".meta":i.slice(0,a)+".meta",Montage.defineProperty(e,"_blueprintModuleId",{value:r})}return e._blueprintModuleId}},blueprint:require("../core/core")._blueprintDescriptor,gateDidBecomeTrue:{value:function(t){t===this._canDrawGate?(this._canDraw=!0,this._updateOwnerCanDrawGate()):t===this._blockDrawGate&&(rootComponent.componentBlockDraw(this),this._prepareCanDraw())},enumerable:!1},gateDidBecomeFalse:{value:function(t){t===this._canDrawGate&&this._updateOwnerCanDrawGate()},enumerable:!1},_canDrawGate:{enumerable:!1,value:null},_preparedForActivationEvents:{enumerable:!1,value:!1},_arrayObjectPool:{value:{pool:null,size:200,ix:0}},_getArray:{value:function(){if(null==this._arrayObjectPool.pool){this._arrayObjectPool.pool=[];for(var t=0;this._arrayObjectPool.size>t;t++)this._arrayObjectPool.pool[t]=[]}return this._arrayObjectPool.ix<this._arrayObjectPool.size?this._arrayObjectPool.pool[this._arrayObjectPool.ix++]:[]}},_disposeArray:{value:function(t){this._arrayObjectPool.ix>0&&(t.length=0,this._arrayObjectPool.pool[--this._arrayObjectPool.ix]=t)}},_drawIfNeeded:{enumerable:!1,value:function(t){var e,i,n,a,r=this._firstDraw;if(this._treeLevel=t,r&&(this.originalElement=this.element),this.needsDraw&&rootComponent.addToDrawCycle(this),r&&this.prepareForDraw&&Montage.callDeprecatedFunction(this,this.prepareForDraw,"prepareForDraw","enterDocument(firstTime)"),this._needsEnterDocument&&(this._needsEnterDocument=!1,this._inDocument=!0,"function"==typeof this.enterDocument&&this.enterDocument(r),this._enterDocument(r)),r&&(this.originalElement=null),null!==this._drawList&&this._drawList.length>0){for(i=this._drawList,this._drawList=this._getArray(),a=i.length,n=0;a>n;n++)e=i[n],e._addedToDrawList=!1,e.canDraw()?e._drawIfNeeded(t+1):drawLogger.isDebug&&drawLogger.debug(loggerToString(e)+" can't draw.");this._disposeArray(i)}}},_updateComponentDom:{value:function(){var t,e,i;if(this._firstDraw){for(this._prepareForDraw(),e=this.composerList.length,i=0;e>i;i++)t=this.composerList[i],t.lazyLoad||t._load();this._firstDraw=!1}(null!==this._newDomContent||this._shouldClearDomContentOnNextDraw)&&(drawLogger.isDebug&&logger.debug("Component content changed: component ",this._montage_metadata.objectName,this.identifier," newDomContent",this._newDomContent),this._performDomContentChanges())}},_replaceElementWithTemplate:{enumerable:!1,value:function(){var t,e,i,n,a,r=this.element,s=this._templateElement,o=this.element.attributes;for(i=0;n=o[i];i++)t=n.nodeName,window._montage_le_flag&&t===ATTR_LE_COMPONENT?e=n.nodeValue:"id"===t||"data-montage-id"===t?e=n.nodeValue:(a=s.getAttribute(t)||"",e=a?a+("style"===t?"; ":" ")+n.nodeValue:n.nodeValue),s.setAttribute(t,e);this._initializeClassListFromElement(s),r.parentNode?r.parentNode.replaceChild(s,r):this._canDrawOutsideDocument||console.warn("Warning: Trying to replace element ",r," which has no parentNode"),this.eventManager.unregisterEventHandlerForElement(r),this.eventManager.registerEventHandlerForElement(this,s),this._element=s,this._templateElement=null,this._newDomContent&&(this._newDomContent=null,this._shouldClearDomContentOnNextDraw=!1)}},_addTemplateStyles:{value:function(){var t,e,i,n=this._templateDocumentPart;if(n){t=n.template.getResources(),i=this.element.ownerDocument,e=t.createStylesForDocument(i);for(var a,r=0;a=e[r];r++)this.rootComponent.addStylesheet(a)}}},_prepareForDraw:{value:function(){logger.isDebug&&logger.debug(this,"_templateElement: "+this._templateElement);var t;window._montage_le_flag&&(t=this.element.children.length>0),this._initDomArguments(),t&&this._leTagArguments(),this._templateElement&&(this._bindTemplateParametersToArguments(),this._replaceElementWithTemplate())},enumerable:!1},_leTagArguments:{value:function(){var t=this.ownerComponent._montage_metadata.moduleId,e=this._montage_metadata.label,i=this.getDomArgumentNames();if(0===i.length)this._leTagStarArgument(t,e,this.element);else for(var n,a=0;n=i[a];a++)this._leTagNamedArgument(t,e,this._domArguments[n],n)}},_getNodeFirstElement:{value:function(t){var e=t.firstElementChild;if(!e){e=t.firstChild;do if(e.nodeType===Node.ELEMENT_NODE)break;while(e=e.nextSibling)}return e}},_getNodeLastElement:{value:function(t){var e=t.lastElementChild;if(!e){e=t.lastChild;do if(e.nodeType===Node.ELEMENT_NODE)break;while(e=e.previousSibling)}return e}},_leTagStarArgument:{value:function(t,e,i){var n=this._getNodeFirstElement(i),a=this._getNodeLastElement(i);n.setAttribute(ATTR_LE_ARG_BEGIN,(n.getAttribute(ATTR_LE_ARG_BEGIN)||"")+" "+t+","+e),a.setAttribute(ATTR_LE_ARG_END,(a.getAttribute(ATTR_LE_ARG_END)||"")+" "+t+","+e)}},_leTagNamedArgument:{value:function(t,e,i,n){i.setAttribute(ATTR_LE_ARG,t+","+e+","+n)}},_bindTemplateParametersToArguments:{value:function(){var t,e,i,n,a,r,s,o,l=this._templateDocumentPart.parameters;if(e=this._domArguments,this._template.hasParameters()||1!==e.length){if(n=this._validateTemplateArguments(e,l))throw n;for(var c in l){t=l[c],i=e[c],"*"===c?(s=this._element.ownerDocument.createRange(),s.selectNodeContents(this._element),a=s.extractContents()):a=i,r=this._findAndDetachComponents(a),t.parentNode.replaceChild(a,t);for(var h=0;o=r[h];h++)o.attachToParentComponent()}}}},_validateTemplateArguments:{value:function(t,e){var i,n,a=Object.keys(e);if(0!==a.length)if(null==t){if(a.length>0)return Error("No arguments provided for "+this.templateModuleId+". Arguments needed: "+a+".")}else if("*"in e){if(i=Object.keys(t),i.length>0)return Error('Arguments "'+i+'" were given to component but no named parameters '+"are defined in "+this.templateModuleId)}else{for(n in e)if(!(n in t))return Error('"'+n+'" argument not '+"given in "+this.templateModuleId);for(n in t)if("*"!==n&&!(n in e))return Error('"'+n+'" parameter does '+"not exist in "+this.templateModuleId)}}},prepareForActivationEvents:{enumerable:!1,value:null},_prepareForActivationEvents:{value:function(){var t,e=this.composerList.length;for(e=0;this.composerList.length>e;e++)t=this.composerList[e],t.lazyLoad&&t._load();"function"==typeof this.prepareForActivationEvents&&this.prepareForActivationEvents()}},_performDomContentChanges:{value:function(){var t,e,i=this._newDomContent,n=this._element.childNodes[0];if(i||this._shouldClearDomContentOnNextDraw){e=this._element,t=this._element.childNodes.length;for(var a=0;t>a;a++)e.removeChild(e.firstChild);if(Element.isElement(i))e.appendChild(i);else if(null!=i)for(var r,a=0;r=i[a];a++)e.appendChild(r);this._newDomContent=null,"function"==typeof this.contentDidChange&&this.contentDidChange(this._element.childNodes[0],n),this._shouldClearDomContentOnNextDraw=!1}}},prepareForDraw:{enumerable:!1,value:null},draw:{enumerable:!1,value:function(){}},willDraw:{enumerable:!1,value:null},didDraw:{enumerable:!1,value:function(){}},_addedToDrawList:{value:!1},_addToParentsDrawList:{enumerable:!1,value:function(){if(!this._addedToDrawList){var t=this.parentComponent;t?(t._addToDrawList(this),drawListLogger.isDebug&&drawListLogger.debug(loggerToString(this)+" added to "+loggerToString(t)+"'s drawList")):drawListLogger.isDebug&&drawListLogger.debug(this,"parentComponent is null")}}},_needsDraw:{value:!1},_needsDrawInDeserialization:{value:!1},needsDraw:{enumerable:!1,get:function(){return!!this._needsDraw},set:function(t){return this.isDeserializing?(this._needsDrawInDeserialization=!0,void 0):(this._needsDraw!==t&&(needsDrawLogger.isDebug&&needsDrawLogger.debug("needsDraw toggled "+t+" for "+this._montage_metadata.objectName),this._needsDraw=!!t,t&&(this.canDrawGate.value?this._addToParentsDrawList():this.blockDrawGate.setField("drawRequested",!0))),void 0)}},_drawList:{value:null},__addToDrawList:{enumerable:!1,value:function(t){null===this._drawList?(this._drawList=[t],t._addedToDrawList=!0):-1===this._drawList.indexOf(t)&&(this._drawList.push(t),t._addedToDrawList=!0)}},_addToDrawList:{enumerable:!1,value:function(t){this.__addToDrawList(t),this._addToParentsDrawList()}},_templateElement:{enumerable:!1,value:null},surrenderPointer:{value:function(){return!0}},composerList:{value:[],distinct:!0,serializable:!1},addComposer:{value:function(t){this.addComposerForElement(t,t.element)}},addComposerForElement:{value:function(t,e){t.component=this,t.element=e,this.composerList.push(t),this._firstDraw||(t.lazyLoad?this._preparedForActivationEvents&&t._load():t._load())}},scheduleComposer:{value:function(t){this.rootComponent.addToComposerList(t)}},removeComposer:{value:function(t){var e,i;for(i=this.composerList.length,e=0;i>e;e++)if(this.composerList[e].uuid===t.uuid){this.composerList[e].unload(),this.composerList.splice(e,1);break}}},clearAllComposers:{value:function(){var t,e,i=this.composerList;for(e=i.length,t=0;e>t;t++)i[t].unload();i.splice(0,e)}},localizer:{value:null},_waitForLocalizerMessages:{value:!1},waitForLocalizerMessages:{enumerable:!1,get:function(){return this._waitForLocalizerMessages},set:function(t){if(this._waitForLocalizerMessages!==t)if(t!==!0||this.localizer.messages)this._waitForLocalizerMessages=!1,this.canDrawGate.setField("messages",!0);else{if(!this.localizer)throw"Cannot wait for messages on localizer if it is not set";this._waitForLocalizerMessages=!0;var e=this;logger.debug(this,"waiting for messages from localizer"),this.canDrawGate.setField("messages",!1),this.localizer.messagesPromise.then(function(){logger.isDebug&&logger.debug(e,"got messages from localizer"),e.canDrawGate.setField("messages",!0)})}}},_elementAttributeValues:{value:null},_elementAttributeDescriptors:{value:null},_getElementAttributeDescriptor:{value:function(t){for(var e,i=this;i&&i._elementAttributeDescriptors&&!(e=i._elementAttributeDescriptors[t]);)i=Object.getPrototypeOf(i);return e}},defineAttribute:{value:function(t,e){e=e||{};var i="_"+t,n={configurable:e.configurable===void 0?!0:e.configurable,enumerable:e.enumerable===void 0?!0:e.enumerable,set:function(t,e){return function(i){var n=this._getElementAttributeDescriptor(t,this);n&&"boolean"===n.dataType&&(i=i||""===i?!0:!1),i!==void 0&&this[e]!==i&&(this[e]=i,null===this._elementAttributeValues&&(this._elementAttributeValues={}),this._elementAttributeValues[t]=i,this.needsDraw=!0)}}(t,i),get:function(t,e){return function(){return this[e]}}(t,i)};Montage.defineProperty(this.prototype,i,{value:null}),Montage.defineProperty(this.prototype,t,n)}},addAttributes:{value:function(t){var e,i,n;this.prototype._elementAttributeDescriptors=t;for(i in t)t.hasOwnProperty(i)&&(n=t[i],null===n||"string"==typeof n?(e={value:n,dataType:"string"},t[i]=e):e=n,this[i]===void 0&&this.defineAttribute(i,e))}},_enterDocument:{value:function(t){var e;if(t){e=this.originalElement;var i,n,a,r,s,o,l;if(i=e.attributes)for(a=i.length,n=0;a>n;n++)r=i[n].name,s=i[n].value,l=this._getElementAttributeDescriptor(r,this),(l||this[r]!==void 0)&&(null===this._elementAttributeValues&&(this._elementAttributeValues={}),this._elementAttributeValues[r]===void 0&&(this._elementAttributeValues[r]=s,(this[r]===void 0||null==this[r])&&(this[r]=s)));if(l=this._getElementAttributeDescriptor("textContent",this)){var c=e.textContent;null===this._elementAttributeValues&&(this._elementAttributeValues={}),this._elementAttributeValues.textContent===void 0&&(this._elementAttributeValues.textContent=c,null==this.textContent&&(this.textContent=c))}if(this._elementAttributeDescriptors)for(o in this._elementAttributeDescriptors){l=this._elementAttributeDescriptors[o];var h="_"+o;null===this[h]&&null!==l&&"value"in l&&(this[h]=this._elementAttributeDescriptors[o].value)}}}},_draw:{value:function(){var t,e=this.element;for(var i in this._elementAttributeValues)if(this._elementAttributeValues.hasOwnProperty(i)){var n=this[i];t=this._getElementAttributeDescriptor(i,this),t&&("boolean"===t.dataType?n===!0?(e[i]=!0,e.setAttribute(i,i.toLowerCase())):(e[i]=!1,e.removeAttribute(i)):n!==void 0&&("textContent"===i?e.textContent=n:e.setAttribute(i,n))),delete this._elementAttributeValues[i]}this._drawClassListIntoComponent()}},_classList:{value:null},_classListDirty:{value:!1},classList:{get:function(){return null===this._classList&&(this._classList=new Set,this._subscribeToToClassListChanges(),this._initializeClassListFromElement(this.element)),this._classList}},_initializeClassListFromElement:{value:function(t){if(t&&t.classList&&t.classList.length>0){var e=this.classList;this._unsubscribeToClassListChanges&&this._unsubscribeToClassListChanges(),e.addEach(t.classList),this._subscribeToToClassListChanges()}}},_unsubscribeToClassListChanges:{value:null},_subscribeToToClassListChanges:{value:function(){this._unsubscribeToClassListChanges=this._classList.addRangeChangeListener(this,"classList")}},handleClassListRangeChange:{value:function(){this._classListDirty=!0,this.needsDraw=!0}},_drawClassListIntoComponent:{value:function(){if(this._classListDirty){for(var t,e=this.element.classList,i=this._classList,n=0,a=e.length;a>n;n++)t=e.item(n),i.has(t)||(e.remove(t),n--,a--);this._classList.forEach(function(t){e.add(t)}),this._classListDirty=!1}}},dispose:{value:function(){this.cancelBindings(),this.detachFromParentComponent(),this._element&&(defaultEventManager.unregisterEventHandlerForElement(this._element),this._element=null),this.childComponents.forEach(function(t){t.dispose()})}}}),RootComponent=Component.specialize({constructor:{value:function RootComponent(){this.super(),this._drawTree=this._drawTree.bind(this),this._readyToDrawListIndex={}}},init:{value:function(){return this}},needsDraw:{enumerable:!0,get:function(){return!1},set:function(t){if(this._needsDraw!==t&&(this._needsDraw=!!t,t))for(var e,i=this.childComponents,n=0;e=i[n];n++)needsDrawLogger.isDebug&&needsDrawLogger.debug(this,"needsDraw = true for: "+e._montage_metadata.exportedSymbol),e.needsDraw=!0}},canDrawGate:{get:function(){return this._canDrawGate||(this._canDrawGate=(new Gate).initWithDelegate(this))}},_clearNeedsDrawTimeOut:{value:null},_needsDrawList:{value:[]},_cannotDrawList:{value:null},componentBlockDraw:{value:function(t){this._cannotDrawList=this._cannotDrawList?this._cannotDrawList:{},this._cannotDrawList[t.uuid]=t,this._clearNeedsDrawTimeOut&&(window.clearTimeout(this._clearNeedsDrawTimeOut),this._clearNeedsDrawTimeOut=null)}},isComponentWaitingNeedsDraw:{value:function(t){return t.uuid in this._cannotDrawList||this._needsDrawList.indexOf(t)>=0}},componentCanDraw:{value:function(t,e){if(e){if(!this._cannotDrawList)return;if(delete this._cannotDrawList[t.uuid],this._needsDrawList.push(t),0===Object.keys(this._cannotDrawList).length&&this._needsDrawList.length>0&&!this._clearNeedsDrawTimeOut){var i=this;this._clearNeedsDrawTimeOut=window.setTimeout(function(){i._clearNeedsDrawList()},0)}}else this._clearNeedsDrawTimeOut&&(window.clearTimeout(this._clearNeedsDrawTimeOut),this._clearNeedsDrawTimeOut=null)}},_clearNeedsDrawList:{value:function(){var t,e,i,n=this._needsDrawList;for(i=n.length,e=0;i>e;e++)t=n[e],(t.needsDraw||t._drawList&&t._drawList.length>0)&&t._addToParentsDrawList();this._clearNeedsDrawTimeOut=null,n.splice(0,i)}},removeFromCannotDrawList:{value:function(t){if(this._cannotDrawList&&(delete this._cannotDrawList[t.uuid],0===Object.keys(this._cannotDrawList).length&&this._needsDrawList.length>0&&!this._clearNeedsDrawTimeOut)){var e=this;this._clearNeedsDrawTimeOut=window.setTimeout(function(){e._clearNeedsDrawList()},0)}}},_cancelDrawIfScheduled:{value:function(){var t=this.requestedAnimationFrame,e=this.cancelAnimationFrame;
null!==t&&(this._frameTime||(logger.isDebug&&logger.debug(this,"clearing draw"),e?e.call(window,t):window.clearTimeout(t),this.requestedAnimationFrame=null))}},_addToDrawList:{value:function(t){this.__addToDrawList(t),drawListLogger.isDebug&&drawListLogger.debug(this,this.canDrawGate.value,this.requestedAnimationFrame),this.drawTree()},enumerable:!1},addToComposerList:{value:function(t){this.composerList.push(t),drawLogger.isDebug&&drawLogger.debug(this,t,"Added to composer list"),this._scheduleComposerRequest=!0,this.drawTree()}},composerListSwap:{value:[],distinct:!0},_scheduleComposerRequest:{value:!1},requestedAnimationFrame:{value:null,enumerable:!1},requestAnimationFrame:{value:window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame,enumerable:!1},cancelAnimationFrame:{value:window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame,enumerable:!1},_frameTime:{value:null},_oldSource:{value:null},_diff:{value:function(t,e){for(var i={},n={},a=0;e.length>a;a++)null==i[e[a]]&&(i[e[a]]={rows:[],o:null}),i[e[a]].rows.push(a);for(a=0;t.length>a;a++)null==n[t[a]]&&(n[t[a]]={rows:[],n:null}),n[t[a]].rows.push(a);for(a in i)1===i[a].rows.length&&n[a]!==void 0&&1===n[a].rows.length&&(e[i[a].rows[0]]={text:e[i[a].rows[0]],row:n[a].rows[0]},t[n[a].rows[0]]={text:t[n[a].rows[0]],row:i[a].rows[0]});for(a=0;e.length-1>a;a++)null!=e[a].text&&null==e[a+1].text&&e[a].row+1<t.length&&null==t[e[a].row+1].text&&e[a+1]==t[e[a].row+1]&&(e[a+1]={text:e[a+1],row:e[a].row+1},t[e[a].row+1]={text:t[e[a].row+1],row:a+1});for(a=e.length-1;a>0;a--)null!=e[a].text&&null==e[a-1].text&&e[a].row>0&&null==t[e[a].row-1].text&&e[a-1]==t[e[a].row-1]&&(e[a-1]={text:e[a-1],row:e[a].row-1},t[e[a].row-1]={text:t[e[a].row-1],row:a-1});return{o:t,n:e}}},_previousDrawDate:{enumerable:!1,value:0},_documentResources:{value:null},_needsStylesheetsDraw:{value:!1},_stylesheets:{value:[]},addStylesheet:{value:function(t){this._stylesheets.push(t),this._needsStylesheetsDraw=!0}},drawStylesheets:{value:function(){for(var t,e=this._documentResources,i=this._stylesheets;t=i.shift();)e.addStyle(t);this._needsStylesheetsDraw=!1}},drawTree:{value:function(){if(null===this.requestedAnimationFrame){var t=this.requestAnimationFrame;if(t)this.requestedAnimationFrame=t.call(window,this._drawTree);else{var e=Date.now(),i=17-e+this._previousDrawDate;0>i&&(i=0),this.requestedAnimationFrame=setTimeout(this._drawTree,i),this._previousDrawDate=e+i}this._scheduleComposerRequest=!1}},enumerable:!1},_drawTree:{value:function(t){var e;if(this._needsStylesheetsDraw&&this.drawStylesheets(),!this._documentResources.areStylesLoaded)return drawPerformanceLogger.isDebug&&console.log("Draw Cycle Waiting Stylesheets: ",this._documentResources._expectedStyles.length),this.requestedAnimationFrame=null,this.drawTree(),void 0;if(drawPerformanceLogger.isDebug&&(e=window.performance?window.performance.now():Date.now()),this._frameTime=t?t:Date.now(),this._clearNeedsDrawTimeOut&&this._clearNeedsDrawList(),drawLogger.isDebug){var i=document.body.innerHTML;if(this._oldSource&&i!==this._oldSource){for(var n=["DOM modified outside of the draw loop"],a=this._diff(this._oldSource.split("\n"),i.split("\n")),r=0;a.n.length>r;r++)if(null==a.n[r].text)n.push("+ "+a.n[r]);else for(var s=a.n[r].row+1;a.o.length>s&&null==a.o[s].text;s++)n.push("- "+a.o[s]);console.warn(n.join("\n"))}console.group((t?drawLogger.toTimeString(new Date(t))+" ":"")+"Draw Fired")}if(this.drawIfNeeded(),drawPerformanceLogger.isDebug){if(window.performance)var o=window.performance.now();else var o=Date.now();console.log("Draw Cycle Time: ",o-e,", Components: ",this._lastDrawComponentsCount)}drawLogger.isDebug&&(console.groupEnd(),this._oldSource=document.body.innerHTML),this._frameTime=null,this._scheduleComposerRequest&&this.drawTree()}},_readyToDrawList:{enumerable:!1,value:[]},_readyToDrawListIndex:{enumerable:!1,value:null},addToDrawCycle:{value:function(t){var e=this._readyToDrawListIndex;return e.hasOwnProperty(t.uuid)?(drawLogger.isDebug&&this!==rootComponent&&drawLogger.debug(loggerToString(this)+" added to the draw cycle twice, this should not happen."),void 0):(this._readyToDrawList.push(t),this._readyToDrawListIndex[t.uuid]=!0,t._updateComponentDom(),void 0)}},_lastDrawComponentsCount:{value:null},_sortByLevel:{value:function(t,e){return t._treeLevel-e._treeLevel}},drawIfNeeded:{value:function(){var t,e,i,n,a,r,s=this._readyToDrawList,o=0,l=this.composerList;if(s.length=0,r=l.length,this._readyToDrawListIndex.clear(),r>0){for(this.composerList=this.composerListSwap,e=0;r>e;e++)a=l[e],a.needsFrame=!1,a.frame(this._frameTime);l.splice(0,r),this.composerListSwap=l}for(this._drawIfNeeded(0),i=s.length,drawLogger.isDebug&&console.groupCollapsed("willDraw - "+s.length+(s.length>1?" components.":" component."));i>o;){for(e=o;i>e;e++)t=s[e],"function"==typeof t.willDraw&&t.willDraw(this._frameTime),drawLogger.isDebug&&drawLogger.debug("Level "+t._treeLevel+" "+loggerToString(t));this._drawIfNeeded(0),o=i,i=s.length}for(drawLogger.isDebug&&(console.groupEnd(),console.group("draw - "+s.length+(s.length>1?" components.":" component."))),s.sort(this._sortByLevel),e=0;i>e;e++)t=s[e],t.needsDraw=!1;for(this.requestedAnimationFrame=null,e=i-1;e>=0;e--)t=s[e],t._draw(this._frameTime),t.draw(this._frameTime),drawLogger.isDebug&&drawLogger.debug("Level "+t._treeLevel+" "+loggerToString(t));for(drawLogger.isDebug&&(console.groupEnd(),console.groupCollapsed("didDraw - "+s.length+(s.length>1?" components.":" component."))),e=0;i>e;e++)t=s[e],t.didDraw(this._frameTime),"channelListItem"===t.identifier&&console.log("component %s completedFirstDraw %s",Object.hash(t),t._completedFirstDraw),t._completedFirstDraw||(n=document.createEvent("CustomEvent"),n.initCustomEvent("firstDraw",!0,!1,null),t.dispatchEvent(n),t._completedFirstDraw=!0),drawLogger.isDebug&&drawLogger.debug("Level "+t._treeLevel+" "+loggerToString(t));return drawLogger.isDebug&&console.groupEnd(),drawPerformanceLogger.isDebug&&(this._lastDrawComponentsCount=s.length),!!s.length}},element:{get:function(){return this._element},set:function(t){defaultEventManager.registerEventHandlerForElement(this,t),this._element=t,this._documentResources=DocumentResources.getInstanceForDocument(t)}}}),rootComponent=(new RootComponent).init();exports.__root__=rootComponent;