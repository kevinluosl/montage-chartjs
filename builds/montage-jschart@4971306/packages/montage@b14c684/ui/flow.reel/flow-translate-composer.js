var Montage=require("../../core/core").Montage,TranslateComposer=require("../../composer/translate-composer").TranslateComposer,defaultEventManager=require("../../core/event/event-manager").defaultEventManager,Point=require("../../core/geometry/point").Point,convertPointFromPageToNode=require("../../core/dom").convertPointFromPageToNode,FlowTranslateComposer=exports.FlowTranslateComposer=TranslateComposer.specialize({constructor:{value:function(){this.super(),this.handleMousewheel=this.handleWheel}},stealChildrenPointer:{value:!0},_linearScrollingVector:{value:[-300,0]},linearScrollingVector:{get:function(){return this._linearScrollingVector},set:function(t){this._linearScrollingVector=t}},_startPageX:{value:null},_startPageY:{value:null},_pageX:{value:null},_pageY:{value:null},_pointerStartX:{value:null},_pointerStartY:{value:null},_contentOffsetX:{value:null},_contentOffsetY:{value:null},_superStart:{value:TranslateComposer.prototype._start},_start:{value:function(t,e,n,i){this._superStart(t,e,n,i);var a=window.getComputedStyle(this._element,null),r=this.convertCssPixelsPropertyStringToNumber(a.getPropertyValue("border-left-width")),s=this.convertCssPixelsPropertyStringToNumber(a.getPropertyValue("border-top-width")),o=this.convertCssPixelsPropertyStringToNumber(a.getPropertyValue("padding-left")),l=this.convertCssPixelsPropertyStringToNumber(a.getPropertyValue("padding-top")),c=convertPointFromPageToNode(this._element,(new Point).init(t,e));this._pointerStartX=this._pointerX=c.x-r-o,this._pointerStartY=this._pointerY=c.y-s-l,this._contentOffsetX=this._startPageX-this._pointerStartX,this._contentOffsetY=this._startPageY-this._pointerStartY,this._computePointedElement(),this._startPageX=this._pageX=t,this._startPageY=this._pageY=e,this._startScroll=this._scroll,this._previousScrollDelta=0,this._scrollEnd=null}},_analyzeMovement:{value:function(t){var e,n,i,a=t.velocity;a&&(e=a.speed,e>=this.startTranslateSpeed?this._stealPointer():(n=this.startPageX-t.pageX,i=this.startPageY-t.pageY,n*n+i*i>this.startTranslateRadius*this.startTranslateRadius&&this._stealPointer()))}},_dispatchTranslateStart:{value:function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("translateStart",!0,!0,null),t.scroll=this._scroll,t.translateX=0,t.translateY=0,t.pointer=this._observedPointer,this.dispatchEvent(t)}},_dispatchTranslateEnd:{value:function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("translateEnd",!0,!0,null),t.scroll=this._scroll,t.translateX=0,t.translateY=0,t.pointer=this._observedPointer,this.dispatchEvent(t)}},_dispatchTranslateCancel:{value:function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("translateCancel",!0,!0,null),t.scroll=this._scroll,t.translateX=0,t.translateY=0,t.pointer=this._observedPointer,this.dispatchEvent(t)}},_dispatchTranslate:{value:function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("translate",!0,!0,null),t.scroll=this._scroll,t.translateX=0,t.translateY=0,t.pointer=this._observedPointer,this.dispatchEvent(t)}},_move:{value:function(t,e){this._isFirstMove&&(this._dispatchTranslateStart(),this._isFirstMove=!1),this._pageX=t,this._pageY=e,this._updateLinearScroll(),this._shouldDispatchTranslate&&this._dispatchTranslate()}},_end:{value:function(t){this.eventManager.isPointerClaimedByComponent(this._observedPointer,this)&&(this.startTime=Date.now(),this.endX=this.startX=this._pageX,this.endY=this.startY=this._pageY,this._hasMomentum&&(t.velocity.speed>40||this.translateStrideX||this.translateStrideY)?(this.momentumX="vertical"!=this._axis?t.velocity.x*this._pointerSpeedMultiplier*(this._invertXAxis?1:-1):0,this.momentumY="horizontal"!=this._axis?t.velocity.y*this._pointerSpeedMultiplier*(this._invertYAxis?1:-1):0,this.endX=this.startX+this.momentumX*this.__momentumDuration/2e3,this.endY=this.startY+this.momentumY*this.__momentumDuration/2e3,this.startStrideXTime=null,this.startStrideYTime=null,this.animateMomentum=!0):this.animateMomentum=!1,this.animateMomentum?this._animationInterval():this._isFirstMove||this._dispatchTranslateEnd()),this._releaseInterest()}},_translateEndTimeout:{value:null},_mousewheelStrideTimeout:{value:null},_previousDeltaY:{value:0},handleWheel:{value:function(t){var e=this;if(this.eventManager.isPointerClaimedByComponent(this._WHEEL_POINTER,this.component)){var n=this._pageY,i=t.wheelDeltaY||-t.deltaY||0;this.translateStrideX?(window.clearTimeout(this._mousewheelStrideTimeout),(null===this._mousewheelStrideTimeout||Math.abs(i)>Math.abs(this._previousDeltaY*(null===this._mousewheelStrideTimeout?2:4)))&&(i>1?this.callDelegateMethod("previousStride",this):-1>i&&this.callDelegateMethod("nextStride",this)),this._mousewheelStrideTimeout=window.setTimeout(function(){e._mousewheelStrideTimeout=null,e._previousDeltaY=0},70),e._previousDeltaY=i,this._shouldPreventDefault(t)&&t.preventDefault()):(null===this._translateEndTimeout&&this._dispatchTranslateStart(),this._pageY=this._pageY+20*i/100,this._updateScroll(),this._dispatchTranslate(),window.clearTimeout(this._translateEndTimeout),this._translateEndTimeout=window.setTimeout(function(){e._dispatchTranslateEnd(),e._translateEndTimeout=null},400),n!==this._pageY&&this._shouldPreventDefault(t)&&t.preventDefault()),this.eventManager.forfeitPointer(this._WHEEL_POINTER,this.component)}}},_scroll:{value:0},scroll:{get:function(){return this._scroll},set:function(t){null!==this.minScroll&&this.minScroll>t&&(t=this.minScroll),null!==this.maxScroll&&t>this.maxScroll&&(t=this.maxScroll),this._scroll=t}},minScroll:{value:null},maxScroll:{value:null},_flow:{value:null},flow:{get:function(){return this._flow},set:function(t){this._flow=t,this.component=t}},_updateScroll:{value:function(){this._updateLinearScroll()}},_updateLinearScroll:{value:function(){var t=this._flow,e=t.isCameraEnabled?500/t._height:1,n=(this._pageX-this._startPageX)*this._linearScrollingVector[0]*e*t._sceneScaleX.denominator/t._sceneScaleX.numerator,i=(this._pageY-this._startPageY)*this._linearScrollingVector[1]*e*t._sceneScaleY.denominator/t._sceneScaleY.numerator,a=this._linearScrollingVector[0]*this._linearScrollingVector[0]+this._linearScrollingVector[1]*this._linearScrollingVector[1],r=(n+i)/a;this.scroll+=r-this._previousScrollDelta,this._previousScrollDelta=r}},frame:{value:function(){this.isAnimating&&this._animationInterval()}},convertCssPixelsPropertyStringToNumber:{value:function(t){return"string"==typeof t?"px"===t.substr(-2)?1*t.substr(0,t.length-2):0:0}},_rayPointDistance:{value:function(t,e){var n,i,a,r,s;return n=t[0]*e[0]+t[1]*e[1]+t[2]*e[2],n>=0?(i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],n/=i,a=t[0]*n-e[0],r=t[1]*n-e[1],s=t[2]*n-e[2],Math.sqrt(a*a+r*r+s*s)):!1}},_closerIndex:{value:null},_computePointedElement:{value:function(){var t=this._flow._splinePaths,e=t.length;if(e){var n,i,a,r,s,o,l,c,h,u=this._flow,d=u._viewpointTargetPoint[0]-u._viewpointPosition[0],p=u._viewpointTargetPoint[2]-u._viewpointPosition[2],g=Math.atan2(d,p),m=p*Math.cos(-g)-d*Math.sin(-g),f=Math.atan2(u._viewpointTargetPoint[1]-u._viewpointPosition[1],m),v=.5*this._element.clientWidth-this._pointerX,b=this._pointerY-.5*this._element.clientHeight,L=.5*this._element.offsetHeight/Math.tan(u._viewpointFov*u._doublePI*(1/720)),y=[],_=u._visibleIndexes,C=_.length,w=u._sceneScale,x=null,M=1e100;for(i=L*Math.cos(f)-b*Math.sin(f),b=L*Math.sin(f)+b*Math.cos(f),n=i*Math.cos(g)-v*Math.sin(g),v=i*Math.sin(g)+v*Math.cos(g),l=[v,b,n],h=0;t.length>h;h++)for(h=0;t.length>h;h++)y[h]=t[h].transform([w.x.numerator/w.x.denominator,0,0,0,0,w.y.numerator/w.y.denominator,0,0,0,0,w.z.numerator/w.z.denominator,0,-u._viewpointPosition[0]+.5*u._firstIterationWidth+u._firstIterationOffsetLeft,-u._viewpointPosition[1]+.5*u._firstIterationHeight+u._firstIterationOffsetTop,-u._viewpointPosition[2],1]);for(h=0;C>h;h++)c=this._flow.offset(_[h]),a=c.pathIndex,r=c.slideTime,o=y[a]._convertSplineTimeToBezierIndexTime(r),null!==o&&(pos=y[a].getPositionAtIndexTime(o),s=this._rayPointDistance(l,pos),s!==!1&&M>s&&(M=s,x=_[h]));this._closerIndex=x}}},_previousScrollDelta:{value:0},_startScroll:{value:0},_translateStride:{value:null},translateStride:{get:function(){return this._translateStride},set:function(t){this._translateStride=t,this.translateStrideX=t}},_scrollEnd:{value:null},_scrollStart:{value:null},_hasMomentum:{value:!0},isLimitedToSingleStride:{value:!1},_animationInterval:{value:function(){var t,e,n,i,a,r,s=Date.now(),o=!1;a=this.minScroll,r=this.maxScroll,this.minScroll=null,this.maxScroll=null,null===this._scrollEnd&&(this._scrollStart=this.scroll,this._pageX=this.endX,this._pageY=this.endY,this._updateScroll(),this._scrollEnd=this.scroll,this.isLimitedToSingleStride&&this.translateStrideX&&(this._scrollEnd>Math.floor(this._scrollStart)+this.translateStrideX&&(this._scrollEnd=Math.floor(this._scrollStart)+this.translateStrideX),this._scrollEnd<Math.ceil(this._scrollStart)-this.translateStrideX&&(this._scrollEnd=Math.ceil(this._scrollStart)-this.translateStrideX)),this._pageX=this.startX,this._pageY=this.startY,this._updateScroll()),this.animateMomentum?(t=s-this.startTime,this.__momentumDuration>t?(this._pageX=this.startX+(this.momentumX+this.momentumX*(this.__momentumDuration-t)/this.__momentumDuration)*t/1e3/2,this._pageY=this.startY+(this.momentumY+this.momentumY*(this.__momentumDuration-t)/this.__momentumDuration)*t/1e3/2,this._updateScroll(),this.translateStrideX&&null===this.startStrideXTime&&(this.__momentumDuration-t<this.translateStrideDuration||Math.abs(this.scroll-this._scrollEnd)<.75*this.translateStrideX)&&(this.startStrideXTime=s,this._strideStartScroll=this._scroll)):this.animateMomentum=!1):null===this.startStrideXTime&&(this.startStrideXTime=this.startTime,this._strideStartScroll=this._scrollStart),i=this.scroll,this.startStrideXTime&&s-this.startStrideXTime>0&&(n=Math.round(this._scrollEnd/this.translateStrideX),s-this.startStrideXTime<this.translateStrideDuration?(t=this._bezierTValue((s-this.startStrideXTime)/this.translateStrideDuration,.275,0,.275,1),e=(s-this.startStrideXTime)/this.translateStrideDuration,i=i*(1-e)+(n*this.translateStrideX*t+this._strideStartScroll*(1-t))*e,o=!0):(i=n*this.translateStrideX,this.animateMomentum=!1)),this.minScroll=a,this.maxScroll=r,a>i&&(i=a,this.animateMomentum=!1,o=!1),i>r&&(i=r,this.animateMomentum=!1,o=!1),this.scroll=i,this.isAnimating=this.animateMomentum||o,this.isAnimating?this.needsFrame=!0:(this._dispatchTranslateEnd(),this._scrollEnd=null)}}});