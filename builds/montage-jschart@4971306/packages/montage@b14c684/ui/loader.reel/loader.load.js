montageDefine("b14c684","ui/loader.reel/loader",{dependencies:["../../core/core","../component","../../core/logger","../../core/event/event-manager"],factory:function(t,e){var i=(t("../../core/core").Montage,t("../component").Component),n=t("../../core/logger").logger("loader"),a=t("../../core/event/event-manager").defaultEventManager,r="_montageStartBootstrappingTimeout",s="montage-app-loader",o="montage-app-bootstrapping",l="montage-app-loading",c="montage-app-loaded",h=0,u=1,d=2,p=3;e.Loader=i.specialize({constructor:{value:function(){this.super()}},mainModule:{value:"ui/main.reel"},mainName:{value:"Main"},includeFrameworkModules:{value:!1},minimumBootstrappingDuration:{value:1500},minimumLoadingDuration:{value:2e3},_initializedModules:{value:null},initializedModules:{dependencies:["includeFrameworkModules"],enumerable:!1,get:function(){return!this._initializedModules||this.includeFrameworkModules?this._initializedModules:this._initializedModules.slice(this._frameworkModuleCount-1)},set:function(t){this._initializedModules=t}},_requiredModules:{value:null},requiredModules:{dependencies:["includeFrameworkModules"],enumerable:!1,get:function(){return!this._requiredModules||this.includeFrameworkModules?this._requiredModules:this._requiredModules.slice(this._frameworkModuleCount-1)},set:function(t){this._requiredModules=t}},_currentStage:{value:h},currentStage:{get:function(){return this._currentStage},set:function(t){t!==this._currentStage&&(n.isDebug&&n.debug(this,"CURRENT STAGE: "+t),this._currentStage=t,this.needsDraw=!0)}},_readyToShowLoader:{value:!1},isLoadingMainComponent:{value:null},readyToShowLoader:{get:function(){return this._readyToShowLoader},set:function(t){t===this._readyToShowLoader&&(this._readyToShowLoader=t,this.needsDraw=!0)}},readyToShowMainComponent:{get:function(){return!!this._mainComponent}},_frameworkModuleCount:{enumerable:!1,value:null},hasTemplate:{enumerable:!1,value:!1},_mainComponent:{value:null},_mainComponentEnterDocument:{value:null},_showLoadingTimeout:{enumerable:!1,value:null},_showMainComponentTimeout:{enumerable:!1,value:null},templateDidLoad:{value:function(){n.isDebug&&n.debug(this,"templateDidLoad"),this.element||(this.element=document.documentElement,this.attachToParentComponent()),this.readyToShowLoader=!0;var t,e=document._montageTiming,i=this;e.bootstrappingStartTime?(n.isDebug&&n.debug(this,"had already started bootstrapping"),this.currentStage=u,e.bootstrappingEndTime=Date.now(),t=this.minimumBootstrappingDuration-(e.bootstrappingEndTime-e.bootstrappingStartTime),t>0?(n.isDebug&&n.debug(this,"still need to show bootstrapper for another "+t+"ms"),this._showLoadingTimeout=setTimeout(function(){i._revealLoader()},t)):this._revealLoader()):(n.isDebug&&n.debug(this,"bootstrapping has not started yetâ€¦"),this._loadMainComponent())}},_revealLoader:{value:function(){n.isDebug&&n.debug(this,"_revealLoader"),this.currentStage=d,document._montageTiming.loadingStartTime=Date.now();var t,e,i,a,r=document.getElementById(s);if(r)for(e=r.children,t=0;i=e[t];t++)(a=i.component)&&(a.attachToParentComponent(),a.needsDraw=!0)}},_revealMainComponent:{value:function(){n.isDebug&&n.debug(this,"_revealMainComponent"),this.currentStage=p}},_loadMainComponent:{value:function(){n.isDebug&&n.debug(this,"_loadMainComponent"),this.isLoadingMainComponent=!0;var t=this;mr.async(this.mainModule).then(function(e){if(!(t.mainName in e))throw Error(t.mainName+" was not found in "+t.mainModule);return t._mainLoadedCallback(e)}).done()}},_mainLoadedCallback:{value:function(t){n.isDebug&&n.debug(this,"_mainLoadedCallback"),this._mainComponent=t[this.mainName].create(),this._mainComponentEnterDocument=this._mainComponent.enterDocument,this._mainComponent.enterDocument=this.mainComponentEnterDocument.bind(this),this._mainComponent.setElementWithParentComponent(document.createElement("div"),this),this._mainComponent.attachToParentComponent(),this._mainComponent._canDrawOutsideDocument=!0,this._mainComponent.needsDraw=!0}},mainComponentEnterDocument:{value:function(){var t,e=this;n.isDebug&&n.debug(this,"main preparing to draw"),this.isLoadingMainComponent=!1,this._contentToRemove=document.createRange(),t=this.element===document.documentElement?document.body:this.element,this._contentToRemove.selectNodeContents(t),this.childComponents=[this._mainComponent],t.appendChild(this._mainComponent.element);var i,s,o=document[r],l=document._montageTiming;l.bootstrappingStartTime?l.bootstrappingStartTime&&!l.loadingStartTime?(clearTimeout(this._showLoadingTimeout),this._showLoadingTimeout=null,l.bootstrappingEndTime=Date.now(),(i=this.minimumBootstrappingDuration-(l.bootstrappingEndTime-l.bootstrappingStartTime))>0?(n.isDebug&&n.debug(this,"show bootstrapper for another "+i+"ms"),this._showMainComponentTimeout=setTimeout(function(){n.isDebug&&n.debug(this,"ok, shown bootstrapper long enough"),e._revealMainComponent()},i)):setTimeout(function(){n.isDebug&&n.debug(this,"ok, showing bootstrapper now"),e._revealMainComponent()},0)):l.loadingStartTime&&(l.loadingEndTime=Date.now(),(s=this.minimumLoadingDuration-(l.loadingEndTime-l.loadingStartTime))>0?(n.isDebug&&n.debug(this,"show loader for another "+s+"ms"),this._showMainComponentTimeout=setTimeout(function(){n.isDebug&&n.debug(this,"ok, shown loader long enough"),e._revealMainComponent()},s)):this._revealMainComponent()):(n.isDebug&&n.debug(this,"bootstrapper never shown"),clearTimeout(o),o=null,this._revealMainComponent());var c=this._mainComponent;return a.unregisterEventHandlerForElement(this.element),c.attachToParentComponent(),p>this.currentStage&&(this.currentStage=p),c.enterDocument=this._mainComponentEnterDocument,c.enterDocument?c.enterDocument.apply(c,arguments):void 0}},removeContentOnLoad:{value:!0},_forceContentRemoval:{enumerable:!1,value:!1},_contentToRemove:{enumerable:!1,value:null},removeContent:{value:function(){this._forceContentRemoval=!0,this.needsDraw=!0}},draw:{value:function(){if(this.readyToShowMainComponent||this.isLoadingMainComponent||(n.isDebug&&n.debug(this,"draw; start loading main component"),this._loadMainComponent()),d===this.currentStage)this.element.classList.remove(o),this.element.classList.add(l);else if(p===this.currentStage&&this._contentToRemove){this.element.classList.remove(o),this.element.classList.remove(l),(this.removeContentOnLoad||this._forceContentRemoval)&&(this._contentToRemove.extractContents(),this._contentToRemove.detach(),this._contentToRemove=null),this.element.classList.add(c);var t=document.createEvent("CustomEvent");t.initCustomEvent("componentLoaded",!0,!0,this._mainComponent),this.dispatchEvent(t,!0,!0),this.detachFromParentComponent()}}}})}});