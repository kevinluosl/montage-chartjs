var Montage=require("../../core/core").Montage,Component=require("../component").Component,Template=require("../../core/template").Template,RangeController=require("../../core/range-controller").RangeController,Promise=require("../../core/promise").Promise,browser=require("../../core/browser").browser,Map=require("collections/map"),Set=require("collections/set"),deprecationWarning=require("../../core/deprecate").deprecationWarning,logger=require("../../core/logger").logger("repetition").color.magenta(),Observers=require("frb/observers"),observeProperty=Observers.observeProperty,observeKey=Observers.observeKey,Iteration=exports.Iteration=Montage.specialize({repetition:{value:null},controller:{value:null},object:{value:null},selected:{value:null},_fragment:{value:null},_childComponents:{value:null},index:{value:null},_drawnIndex:{value:null},active:{value:null},_noTransition:{value:null},_templateDocumentPart:{value:null},isDirty:{value:!1},constructor:{value:function Iteration(){this.super(),logger.isDebug&&logger.debug("Iteration:%s create iteration %O",Object.hash(this),this),this.repetition=null,this.controller=null,this.object=null,this.defineBinding("selected",{"<->":"object.defined() ? repetition.contentController.selection.has(object) : selected"}),this._fragment=null,this._childComponents=null,this.index=null,this._drawnIndex=null,this.active=!1,this.defineBinding("active",{"<->":"repetition.activeIterations.has(())"}),this._noTransition=!1,this.addOwnPropertyChangeListener("active",this),this.addOwnPropertyChangeListener("selected",this),this.addOwnPropertyChangeListener("_noTransition",this),this.addPathChangeListener("index.defined() && _childComponents.defined()",this,"handleComponentModelChange"),this.cachedFirstElement=null}},initWithRepetition:{value:function(t){return this.repetition=t,this}},recycle:{value:function(){this.index=null,this.object=null,this._noTransition=!0}},injectIntoDocument:{value:function(t){null!==this._drawnIndex?(logger.isDebug&&logger.debug("Iteration:%s retracting from index %s and injecting at %s",Object.hash(this),this._drawnIndex,t),this.retractFromDocument()):logger.isDebug&&logger.debug("Iteration:%s injecting at index %s",Object.hash(this),t);var e=this,i=this.repetition,n=i.element,a=i._boundaries,r=n.ownerDocument.createTextNode(""),s=a[t];if(a.splice(t,0,r),n.insertBefore(r,s),n.insertBefore(this._fragment,s),i._drawnIterations.splice(t,0,this),i._updateDrawnIndexes(t),i._addDirtyClassListIteration(this),!this._elementsWillBeAddedToMap){var o=this._childComponents.length,l=function(t){t.target.removeEventListener("firstDraw",l,!1),o--,o||e.forEachElement(function(t){i._iterationForElement.set(t,e)})};if(this._childComponents.length>0)for(var c=0;this._childComponents.length>c;c++){var h=this._childComponents[c];h.addEventListener("firstDraw",l,!1),h.needsDraw=!0,h._completedFirstDraw===!0&&console.error("Repetiton:%s child component %O has already drawn.",Object.hash(this),h)}else this.forEachElement(function(t){i._iterationForElement.set(t,e)});this._elementsWillBeAddedToMap=!0}}},_elementsWillBeAddedToMap:{value:!1},retractFromDocument:{value:function(){logger.isDebug&&logger.debug("Iteration:%s retractFromDocument drawnIndex: %s",Object.hash(this),this._drawnIndex);var t=this._drawnIndex,e=this.repetition,i=e.element,n=e._boundaries[t],a=e._boundaries[t+1];e._boundaries.splice(t,1);for(var r=this._fragment,s=n.nextSibling;s!=a;){var o=s.nextSibling;i.removeChild(s),r.appendChild(s),s=o}i.removeChild(n),this._drawnIndex=null,e._drawnIterations.splice(t,1),e._updateDrawnIndexes(t)}},handleComponentModelChange:{value:function(t){t?this._childComponents.forEach(this.repetition.addChildComponent,this.repetition):this._childComponents&&this._childComponents.forEach(this.repetition.removeChildComponent,this.repetition)}},handlePropertyChange:{value:function(){this.repetition&&(this.repetition._addDirtyClassListIteration(this),this.repetition.needsDraw=!0)}},forEachElement:{value:function(t,e){var i=this.repetition,n=this._drawnIndex;if(null!=n)for(var a=i._boundaries[n];a!==i._boundaries[n+1];a=a.nextSibling)1===a.nodeType&&t.call(e,a)}},firstElement:{get:function(){var t=this.repetition,e=this._drawnIndex;if(null!=e)for(var i=t._boundaries[e];i!==t._boundaries[e+1];i=i.nextSibling)if(1===i.nodeType)return this.cachedFirstElement=i,i}},isComponentTreeLoaded:{value:function(){return null!==this._fragment}},cachedFirstElement:{value:null}}),Repetition=exports.Repetition=Component.specialize({initWithContent:{value:function(t){return this.object=t,this}},initWithContentController:{value:function(t){return this.contentController=t,this}},content:{get:function(){return this.getPath("contentController.content")},set:function(t){this.contentController=(new RangeController).initWithContent(t)}},contentController:{value:null},isSelectionEnabled:{value:null},selection:{value:null},selectedIterations:{value:null},selectedIndexes:{value:null},activeIterations:{value:null},iterations:{value:null},currentIteration:{value:null},objectAtCurrentIteration:{value:null},hasTemplate:{value:!1},_iterationTemplate:{value:null},clonesChildComponents:{value:!0},constructor:{value:function(){this.super(),this.contentController=null,this.organizedContent=[],this.defineBinding("organizedContent.rangeContent()",{"<-":"contentController.organizedContent"}),this.isSelectionEnabled=!1,this.defineBinding("selection",{"<->":"contentController.selection"}),this.defineBinding("selectedIterations",{"<-":"iterations.filter{selected}"}),this.defineBinding("selectedIndexes",{"<-":"selectedIterations.map{index}"}),this._iterationTemplate=null,this.addPathChangeListener(this._setupRequirements,this,"_handleSetupRequirementsChange"),this.addPathChangeListener("innerTemplate",this,"_handleInnerTemplateChange"),this.iterations=[],this._drawnIterations=[],this._freeIterations=[],this._contentForIteration=Map(),this._iterationForElement=Map(),this.currentIteration=null,this._templateId=null,this._iterationCreationPromise=Promise.resolve(),this._boundaries=[],this._dirtyClassListIterations=Set(),this._requestedIterations=0,this._createdIterations=0,this._canDrawInitialContent=!1,this._initialContentDrawn=!1,this.addOwnPropertyChangeListener("isSelectionEnabled",this),this._selectionPointer=null,this.activeIterations=[]}},_setupRequirements:{value:"[!_iterationTemplate.defined(),!_newDomContent.defined(),!_shouldClearDomContentOnNextDraw,_isComponentExpanded,_ownerDocumentPart.defined()].every{}"},_handleSetupRequirementsChange:{value:function(t){t&&this._setupIterationTemplate()}},_handleInnerTemplateChange:{value:function(t){this._iterationTemplate&&this._teardownIterationTemplate(),t&&this.getPath(this._setupRequirements)&&this._setupIterationTemplate()}},cleanupDeletedComponentTree:{value:function(t){var e=this._innerTemplate;this._innerTemplate=null,e&&this._teardownIterationTemplate(),t&&this.cancelBindings()}},expandComponent:{value:function(){return this._isComponentExpanded=!0,Promise.resolve()}},_buildIterationTemplate:{value:function(){var t,e,i,n;return t=this.innerTemplate.clone(),e=t.getSerialization(),i=e.getSerializationObject(),n=Montage.getInfoForObject(this).label,this._iterationLabel=n+":iteration",i[this._iterationLabel]={},t.setObjects(i),this.innerTemplate.hasParameters()&&this._expandIterationTemplateParameters(t),window._montage_le_flag&&(t.refresher=this,this._leTagIterationTemplate(t)),t}},_rebuildIterationTemplate:{value:function(){var t,e=this._iterationTemplate,i=this.iterations;this._purgeFreeIterations();for(var n,a=0;n=i[a];a++)n.isDirty=!0;this._innerTemplate=null,t=this._buildIterationTemplate(),e.replaceContentsWithTemplate(t)}},refreshTemplate:{value:function(){this._rebuildIterationTemplate()}},_setupIterationTemplate:{value:function(){var t=this;this._iterationTemplate=this._buildIterationTemplate();for(var e,i=t.childComponents,n=i.length-1;e=i[n--];)e.detachFromParentComponent(),e.needsDraw=!1,e.cleanupDeletedComponentTree(!0);t.handleOrganizedContentRangeChange(t.organizedContent,[],0),t.organizedContent.addRangeChangeListener(t,"organizedContent"),t._canDrawInitialContent=!0,t.needsDraw=!0}},_leTagIterationTemplate:{value:function(t){var e=t.document.body;if(e.children.length>0){var i=this.ownerComponent._montage_metadata.moduleId,n=this._montage_metadata.label;this._leTagStarArgument(i,n,e)}}},_teardownIterationTemplate:{value:function(){this.organizedContent.removeRangeChangeListener(this,"organizedContent"),this.handleOrganizedContentRangeChange([],this.organizedContent,0),this._purgeFreeIterations(),this._iterationTemplate=null,this._contentForIteration.clear(),this._iterationForElement.clear(),this.currentIteration=null,this._templateId=null,this._requestedIterations=0,this._createdIterations=0,this._canDrawInitialContent=!1,this._selectionPointer=null,this.activeIterations.clear(),this._dirtyClassListIterations.clear()}},_purgeFreeIterations:{value:function(){for(var t=0;this._freeIterations.length>t;t++)for(var e=this._freeIterations[t],i=0;e._childComponents.length>i;i++){var n=e._childComponents[i];this.removeChildComponent(n),n.cleanupDeletedComponentTree(!0)}this._freeIterations.clear()}},_expandIterationTemplateParameters:{value:function(t){for(var e,i,n,a,r,s,o,l,c,h=this;t.hasParameters();){h=h.ownerComponent,e=h._ownerDocumentPart.template,a=h._ownerDocumentPart.objects,s=t.expandParameters(h),n=t.getSerialization().getExternalObjectLabels(),r=t.getInstances(),l=s.labels,i=s.labelsCollisions;for(var u,d=0;u=l[d];d++)o=i&&u in i?i[u]:u,n.indexOf(o)>=0?r[o]=a[u]:(c=e.getObjectMetadata(u),c.owner||(c.owner=a.owner),t.setObjectMetadata(o,c.require,c.label,c.owner))}}},_iterationLabel:{value:null},_iterationCreationPromise:{value:null},_createIteration:{value:function(){var t=this,e=(new this.Iteration).initWithRepetition(this);return this._iterationCreationPromise=this._iterationCreationPromise.then(function(){var i,n,a=t.element.ownerDocument;return t.currentIteration=e,i=t._iterationTemplate.getInstances(),i=Object.create(i),i[t._iterationLabel]=e,n=t._iterationTemplate.instantiateWithInstances(i,a).then(function(i){i.parentDocumentPart=t._ownerDocumentPart,e._templateDocumentPart=i,i.loadComponentTree().then(function(){logger.isDebug&&logger.debug("Iteration:%s component tree loaded.",Object.hash(e)),e._fragment=i.fragment,e._childComponents=i.childComponents,t.constructIteration(e)}).done(),t.currentIteration=null}),n.done(),n.then(null,function(){})}),this._requestedIterations++,e}},constructIteration:{value:function(){this._createdIterations++,this._createdIterations>=this._requestedIterations&&(this.needsDraw=!0,this._canDraw=!0)}},observeProperty:{value:function(t,e,i){return"contentAtCurrentIteration"===t||"objectAtCurrentIteration"===t?("contentAtCurrentIteration"===t?deprecationWarning("contentAtCurrentIteration",":iteration.object"):"objectAtCurrentIteration"===t&&deprecationWarning("objectAtCurrentIteration",":iteration.object"),observeKey(this._contentForIteration,this.currentIteration,e,i)):"currentIteration"===t?(deprecationWarning("currentIteration",":iteration"),e(this.currentIteration)):observeProperty(this,t,e,i)}},makePropertyObservable:{value:function(t){return"currentIteration"!==t?Montage.makePropertyObservable.call(this,t):void 0}},_controllerIterations:{value:null},_drawnIterations:{value:null},_freeIterations:{value:null},_contentForIteration:{value:null},handleOrganizedContentRangeChange:{value:function(t,e,i){logger.isDebug&&logger.debug("Repetition:%s content changed +%s@%s %O -%s %O ",Object.hash(this),t?t.length:0,i,t,e?e.length:0,e);var n=this.iterations,a=this._contentForIteration;this._iterationTemplate.isDirty&&this._iterationTemplate.refresh();var r=Math.min(t.length,e.length),s=e.length-r,o=t.length-r;if(logger.isDebug&&logger.debug("Repetition:%s +%s -%s iterations",Object.hash(this),o,s),r>0)for(var l=0;r>l;l++,i++)n[i].object=t[l],a.set(n[i],t[l]);if(s>0){var c=n.splice(i,s);c.forEach(function(t){t.recycle()});for(var h,l=0;h=c[l];l++)h.isDirty||this._freeIterations.push(h)}if(o>0){if(logger.isDebug)var u=[];for(;o>this._freeIterations.length;)this._freeIterations.push(this._createIteration()),logger.isDebug&&u.push(this._freeIterations[this._freeIterations.length-1]);for(var d=Array(o),l=r,p=0;t.length>l;l++,p++){var g=this._freeIterations.pop();logger.isDebug&&(u.has(g)||logger.debug("Repetition:%s reusing %s",Object.hash(this),Object.hash(g)));var m=t[l];g.object=m,a.set(g,m),d[p]=g}n.swap(i,0,d)}(s>0||o>0)&&this._updateIndexes(i),this.needsDraw=!0}},_updateIndexes:{value:function(t){for(var e=this.iterations;e.length>t;t++)e[t].index=t}},_addDirtyClassListIteration:{value:function(t){t.forEachElement(function(e){var i;e&&(i=e.component)?(i.classList[t.active?"add":"remove"]("active"),i.classList[t.selected?"add":"remove"]("selected"),i.classList.remove("no-transition")):this._dirtyClassListIterations.add(t)},this)}},canDraw:{value:function(){var t=this.canDrawGate.value;return t=t&&this._requestedIterations<=this._createdIterations,t=t&&(this._initialContentDrawn||this._canDrawInitialContent)}},_boundaries:{value:null},_dirtyClassListIterations:{value:null},_requestedIterations:{value:null},_createdIterations:{value:null},_canDrawInitialContent:{value:null},_initialContentDrawn:{value:null},draw:{value:function(){this._initialContentDrawn||(this._drawInitialContent(),this._initialContentDrawn=!0);for(var t=this._drawnIterations.length-1;t>=0;t--)null===this._drawnIterations[t].index&&this._drawnIterations[t].retractFromDocument();for(var t=0;this.iterations.length>t;t++){var e=this.iterations[t];e._drawnIndex!==e.index&&e.isComponentTreeLoaded()&&e.injectIntoDocument(t)}var i=this._dirtyClassListIterations.toArray();this._dirtyClassListIterations.clear(),i.forEach(function(t){t.isComponentTreeLoaded()&&t.forEachElement(function(e){e.component||(e.classList[t.active?"add":"remove"]("active"),e.classList[t.selected?"add":"remove"]("selected"),e.classList.remove("no-transition"))},this)},this)}},_drawInitialContent:{value:function(){for(var t=this.element,e=t.childNodes.length,i=0;e>i;i++)t.removeChild(t.firstChild);var n=t.ownerDocument.createTextNode("");t.appendChild(n),this._boundaries.push(n)}},_updateDrawnIndexes:{value:function(t){for(var e=this._drawnIterations;e.length>t;t++)e[t]._drawnIndex=t}},_selectionPointer:{value:null},handleIsSelectionEnabledChange:{value:function(t){t?this._enableSelectionTracking():this._disableSelectionTracking()}},_enableSelectionTracking:{value:function(){browser.android&&browser.android.androidBrowser?window.Touch?this.element.addEventListener("touchstart",this,!0):this.element.addEventListener("mousedown",this,!0):(this.element.addEventListener("touchstart",this,!0),this.element.addEventListener("mousedown",this,!0))}},_disableSelectionTracking:{value:function(){browser.android&&browser.android.androidBrowser?window.Touch?this.element.removeEventListener("touchstart",this,!0):this.element.removeEventListener("mousedown",this,!0):(this.element.removeEventListener("touchstart",this,!0),this.element.removeEventListener("mousedown",this,!0))}},_observeSelectionPointer:{value:function(t){this._selectionPointer=t,this.eventManager.claimPointer(t,this);var e=this.element.ownerDocument;e.addEventListener("touchend",this,!1),e.addEventListener("touchcancel",this,!1),e.addEventListener("mouseup",this,!1)}},_ignoreSelectionPointer:{value:function(){this.eventManager.isPointerClaimedByComponent(this._selectionPointer,this)&&this.eventManager.forfeitPointer(this._selectionPointer,this),this._selectionPointer=null,this.activeIterations.clear();var t=this.element.ownerDocument;t.removeEventListener("touchend",this,!1),t.removeEventListener("touchcancel",this,!1),t.removeEventListener("mouseup",this,!1)}},captureMousedown:{value:function(t){if(null==this._selectionPointer){this._observeSelectionPointer("mouse");var e=this._findIterationContainingElement(t.target);e?e.active=!0:this._ignoreSelectionPointer()}}},captureTouchstart:{value:function(t){if(null==this._selectionPointer){this._observeSelectionPointer(t.changedTouches[0].identifier);var e=this._findIterationContainingElement(t.target);e?e.active=!0:this._ignoreSelectionPointer()}}},handleTouchend:{value:function(t){for(var e=0;t.changedTouches.length>e&&!this._endSelectionOnTarget(t.changedTouches[e].identifier,t.target);e++);}},handleTouchcancel:{value:function(){this._ignoreSelectionPointer()}},handleMouseup:{value:function(t){this._endSelectionOnTarget("mouse",t.target)}},_endSelectionOnTarget:{value:function(t,e){if(t===this._selectionPointer){if(this.eventManager.isPointerClaimedByComponent(this._selectionPointer,this)){var i=this._findIterationContainingElement(e);i&&(i.active=!1,i.selected||(i.selected=!0))}return this._ignoreSelectionPointer(),!0}}},_findIterationContainingElement:{value:function(t){for(var e;t;){if(t===this.element)return this._iterationForElement.get(e);e=t,t=t.parentNode}}},Iteration:{value:Iteration,serializable:!1}});