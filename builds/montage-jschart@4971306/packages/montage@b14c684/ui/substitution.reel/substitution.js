var Slot=require("../slot.reel").Slot,Promise=require("../../core/promise").Promise,logger=require("../../core/logger").logger("substitution");exports.Substitution=Slot.specialize({hasTemplate:{enumerable:!1,value:!1},constructor:{value:function(){this._switchElements=Object.create(null),this._switchComponentTreeLoaded=Object.create(null)}},_allChildComponents:{value:null},deserializedFromTemplate:{value:function(){this._allChildComponents=this.childComponents.slice(0),this.switchValue&&this._loadSwitchComponentTree(this.switchValue)}},_switchElements:{value:null},_switchComponentTreeLoaded:{value:null},addSwitchElement:{value:function(t,e){if(e.parentNode)throw Error("Can't handle elements inside the DOM.");this._switchElements[t]=e,this._findFringeComponents(e,this._allChildComponents)}},_findFringeComponents:{value:function(t,e){var n;if(e=e||[],t.component)e.push(t.component);else{n=t.children;for(var i,a=0;i=n[a];a++)this._findFringeComponents(i,e)}return e}},_drawnSwitchValue:{value:null},_switchValue:{value:null},switchValue:{get:function(){return this._switchValue},set:function(t){this._switchValue===t||this._isSwitchingContent||(this._switchValue=t,this._firstDraw||this.isDeserializing||this._loadContent(t))}},enterDocument:{value:function(t){var e;if(Slot.enterDocument.apply(this,arguments),t){e=this.getDomArgumentNames();for(var n,i=0;n=e[i];i++)this._switchElements[n]=this.extractDomArgument(n);this._loadContent(this.switchValue),this._updateComponentDom()}}},_loadContent:{value:function(t){this.content=t===this._drawnSwitchValue?this.element.children[0]:this._switchElements[t]||null,this._switchComponentTreeLoaded[t]||this._loadSwitchComponentTree(t)}},contentDidChange:{value:function(t,e){this.super(),this._drawnSwitchValue&&(this._switchElements[this._drawnSwitchValue]=e),this._drawnSwitchValue=this._switchValue}},_loadSwitchComponentTree:{value:function(t){var e,n,i=this,a=this._allChildComponents,r=this._switchElements[t],s=this.element,o=this.canDrawGate,l=[];r||(r=this._getSubstitutionDomArgument(t));for(var c=0;a.length>c;c++){for(e=a[c],n=e.element;n!==r&&n!==s&&n.parentNode;)n=n.parentNode;n===r&&l.push(e.loadComponentTree())}l.length>0?(o.setField(t+"ComponentTreeLoaded",!1),Promise.all(l).then(function(){i._switchComponentTreeLoaded[t]=!0,o.setField(t+"ComponentTreeLoaded",!0),i._canDraw=!0,i.needsDraw=!0}).done()):(this._switchComponentTreeLoaded[t]=!0,this.needsDraw=!0)}},_getSubstitutionDomArgument:{value:function(t){var e,n,i,a,r,s,o=this._ownerDocumentPart.template;i=this.element,e=i.querySelectorAll("*["+this.DOM_ARG_ATTRIBUTE+"='"+t+"']");t:for(var l,c=0;l=e[c];c++){for(n=l;(n=n.parentNode)!==i;)if(a=o.getElementId(n),a&&(r=o.getSerialization(),s=r.getSerializationLabelsWithElements(a),s.length>0))continue t;return l}}},shouldLoadComponentTree:{value:!1},transition:{value:null}});